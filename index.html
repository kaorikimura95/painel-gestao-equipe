<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSV 2026 - Painel de Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Open Sans', sans-serif; }
        .h-dvh { height: 100dvh; }
        /* Modal e Scrollbars */
        #projectModal, #indicatorModal, #calendarModal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); }
        .modal-container { max-height: 80vh; overflow-y: auto; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        nav::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        nav::-webkit-scrollbar-track { background: transparent; }
        /* Campos */
        .field-label { display: block; font-size: 10px; font-weight: 900; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.1em; }
        .input-style { width: 100%; background-color: white; border: 1px solid #dbeafe; border-radius: 0.75rem; padding: 0.75rem 1rem; font-size: 0.875rem; outline: none; transition: all 0.2s; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); appearance: none; color: #0f172a; font-weight: 400; }
        .input-style:focus { box-shadow: 0 0 0 2px #3b82f6; border-color: transparent; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.5rem 1rem; border: 1px solid #dbeafe; border-radius: 0.75rem; min-height: 44px; transition: all 0.2s; cursor: text; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); background-color: #ffffff !important; align-items: center; }
        .actor-tag { background-color: #dbeafe; color: #1d4ed8; font-size: 0.75rem; font-weight: 700; padding: 0.25rem 0.5rem; border-radius: 0.375rem; display: flex; align-items: center; gap: 0.5rem; border: 1px solid #bfdbfe; }
        .form-section-title { display: flex; align-items: center; gap: 0.5rem; color: #1e293b; font-weight: 900; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.2em; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.75rem; margin-bottom: 1.5rem; }
        .doc-link-container { display: flex; align-items: center; justify-content: center; border: 2px dashed #bfdbfe; border-radius: 0.75rem; padding: 0.75rem; background-color: rgba(239, 246, 255, 0.3); transition: all 0.2s; cursor: pointer; color: #3b82f6; font-weight: 700; font-size: 0.75rem; gap: 0.75rem; }
        .doc-link-container:hover { background-color: #eff6ff; border-color: #60a5fa; }
        .hidden-field { display: none !important; }
        .radio-group { display: flex; gap: 1rem; padding: 0.75rem; background-color: white; border: 1px solid #dbeafe; border-radius: 0.75rem; }
        .radio-option { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem; font-weight: 500; color: #334155; }
        /* Abas e Temas */
        .tab-btn { color: #94a3b8; transition: all 0.2s; }
        .tab-btn:hover { background-color: #1e293b; color: white; }
        .btn-theme-project { color: #94a3b8; } .btn-theme-project:hover { color: #2563eb; border-color: #93c5fd; }
        .btn-theme-contract { color: #94a3b8; } .btn-theme-contract:hover { color: #9333ea; border-color: #d8b4fe; }
        .btn-theme-operational { color: #94a3b8; } .btn-theme-operational:hover { color: #ea580c; border-color: #fdba74; }
        .btn-theme-portaria { color: #94a3b8; } .btn-theme-portaria:hover { color: #0891b2; border-color: #67e8f9; }
        .btn-theme-indicators { color: #94a3b8; } .btn-theme-indicators:hover { color: #be185d; border-color: #fbcfe8; }
        /* Acordeão */
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease; }
        .accordion-row.active .accordion-content { max-height: 3000px; padding-bottom: 2rem; }
        .accordion-row.active .chevron-icon { transform: rotate(180deg); }
        /* Portaria */
        .portaria-card { background-color: white; border-width: 1px; border-style: solid; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: all 0.2s; position: relative; overflow: hidden; }
        .portaria-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .portaria-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .type-diretoria { border-color: #e2e8f0; } .type-diretoria::before { background-color: #1e293b; }
        .badge-diretoria { background-color: #f1f5f9; color: #1e293b; border: 1px solid #e2e8f0; }
        .type-coordenadoria { border-color: #dbeafe; } .type-coordenadoria::before { background-color: #3b82f6; }
        .badge-coordenadoria { background-color: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
        .type-divisao { border-color: #e0e7ff; } .type-divisao::before { background-color: #6366f1; }
        .badge-divisao { background-color: #eef2ff; color: #4338ca; border: 1px solid #e0e7ff; }
        .type-servico { border-color: #f1f5f9; } .type-servico::before { background-color: #cbd5e1; }
        .badge-servico { background-color: #f8fafc; color: #64748b; border: 1px solid #f1f5f9; }
        .portaria-badge { font-size: 10px; font-weight: 900; text-transform: uppercase; padding: 4px 8px; border-radius: 6px; letter-spacing: 0.05em; }
        .portaria-filter-btn { height: 42px; display: flex; align-items: center; justify-content: center; border-radius: 0.5rem; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: white; box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1); transition: all 0.2s; opacity: 0.7; cursor: pointer; width: 100%; filter: grayscale(80%); transform: scale(0.98); }
        .portaria-filter-btn:hover, .portaria-filter-btn.active { opacity: 1; filter: grayscale(0%); transform: scale(1); border: 2px solid white; outline: 2px solid currentColor; }
        .filter-all { background-color: #475569; } .filter-diretoria { background-color: #0f172a; } .filter-coordenadoria { background-color: #2563eb; } .filter-divisao { background-color: #7c3aed; } .filter-servico { background-color: #059669; }
        /* Cards Estatisticas */
        .stat-card { cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; min-height: 80px; display: flex; flex-direction: column; justify-content: center; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .stat-card.active-filter { box-shadow: 0 0 0 3px #60a5fa; border-color: transparent; background-color: #eff6ff; transform: scale(1.02); z-index: 10; }
        .coord-btn { transition: all 0.3s ease; opacity: 1; }
        .coord-btn.active-coord { background-color: #2563eb !important; color: white !important; transform: scale(1.1); z-index: 10; }
        #coordBtnContainer.coord-list-active .coord-btn:not(.active-coord) { opacity: 0.4; filter: grayscale(100%); transform: scale(0.95); }
        .chart-pie { width: 100px; height: 100px; border-radius: 50%; }
        /* Indicadores */
        .indicator-card { background: white; border: 1px solid #fbcfe8; border-radius: 1rem; padding: 1.5rem; transition: all 0.2s; position: relative; overflow: hidden; cursor: pointer; }
        .indicator-card:hover { transform: translateY(-2px); border-color: #f9a8d4; }
        .indicator-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #be185d; }
        .month-cell { background: #fdf2f8; border: 1px solid #fbcfe8; border-radius: 0.375rem; padding: 0.25rem; text-align: center; }
        .month-label { font-size: 9px; font-weight: 900; color: #9d174d; text-transform: uppercase; }
        .month-value { font-size: 11px; font-weight: bold; color: #831843; }
        .progress-bg { background: #fce7f3; border-radius: 999px; height: 8px; width: 100%; overflow: hidden; margin-top: 0.5rem; }
        .progress-fill { background: #db2777; height: 100%; border-radius: 999px; }
        .ppa-year-box { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.5rem; text-align: center; }
        .ppa-year-box.current { background-color: #fdf2f8; border-color: #fbcfe8; }
        /* Calendar */
        .calendar-new-wrapper { background: white; border-radius: 1rem; border: 1px solid #e2e8f0; }
        .calendar-new-day-cell { min-height: 120px; background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.5rem; }
        .calendar-day-active { background-color: #eff6ff !important; border-color: #3b82f6 !important; }
        .responsive-stats-grid { display: grid; gap: 1rem; grid-template-columns: repeat(2, 1fr); }
        @media (min-width: 640px) { .responsive-stats-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1280px) { .responsive-stats-grid { grid-template-columns: repeat(5, 1fr); } }
    </style>
</head>
<body id="mainBody" class="bg-slate-50 text-slate-900 text-sm overflow-hidden">

    <div id="projectModal" class="items-center justify-center p-2 sm:p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl overflow-hidden border border-slate-200 flex flex-col max-h-[95vh] sm:max-h-[90vh]">
            <div class="px-4 sm:px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-600 text-white rounded-lg flex items-center justify-center shadow-lg"><i class="fas fa-project-diagram"></i></div>
                    <h3 id="modalTitle" class="font-black text-slate-800 uppercase">Novo Registro</h3>
                </div>
                <button onclick="toggleModal('projectModal')" class="w-10 h-10 rounded-full hover:bg-slate-100"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-container flex-1 overflow-y-auto">
                <form id="projectForm" class="p-4 md:p-8">
                    <input type="hidden" id="editId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-10">
                        <div class="space-y-6">
                            <h4 class="form-section-title">01. Identificação</h4>
                            <div id="contractTypeField" class="hidden-field"><label class="field-label">Tipo</label><select id="projType" class="input-style"><option value="Contrato">Contrato</option><option value="Convênio">Convênio</option></select></div>
                            <div><label class="field-label">Nome</label><input type="text" id="projName" class="input-style" required></div>
                            <div><label class="field-label">Descrição</label><textarea id="projDesc" rows="3" class="input-style"></textarea></div>
                            <div><label class="field-label">Observações</label><textarea id="projObs" rows="2" class="input-style"></textarea></div>
                            
                            <div id="contractRelationWrapper" class="hidden-field pt-3 border-t border-slate-100">
                                <label class="field-label">Relação com Projeto?</label>
                                <div class="radio-group"><label class="radio-option"><input type="radio" name="contractRelType" value="nao" checked onclick="toggleContractRelInput()"> Não</label><label class="radio-option"><input type="radio" name="contractRelType" value="sim" onclick="toggleContractRelInput()"> Sim</label></div>
                            </div>
                            <div id="projectSelectWrapper" class="hidden-field"><label class="field-label">Qual projeto?</label><select id="projRelation" class="input-style"></select></div>
                            
                            <div id="resourceLogicField" class="hidden-field pt-3 border-t border-slate-100">
                                <label class="field-label">Repasse de recurso?</label><select id="projHasResource" class="input-style" onchange="toggleResourceInput()"><option value="Não">Não</option><option value="Sim">Sim</option></select>
                            </div>
                            <div id="resourceValueField" class="hidden-field"><label class="field-label">Valor (R$)</label><input type="text" id="projResourceValue" class="input-style text-emerald-600 font-bold" placeholder="0,00"></div>

                            <div id="relationalField" class="hidden-field"><label class="field-label">Origem</label><div class="radio-group"><label class="radio-option"><input type="radio" name="originType" value="pontual" checked onclick="toggleOriginInput()"> Pontual</label><label class="radio-option"><input type="radio" name="originType" value="projeto" onclick="toggleOriginInput()"> Projeto</label></div></div>
                            <div><label class="field-label">Gestor</label><input type="text" id="projManager" class="input-style"></div>
                            <div><label class="field-label">Atores</label><div class="tag-container" id="actorsTagContainer"><input type="text" id="actorInput" class="bg-transparent outline-none flex-1 min-w-[100px]" placeholder="Digite + Enter"></div></div>
                        </div>
                        <div class="space-y-6">
                            <h4 class="form-section-title">02. Processos e Prazos</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="field-label">Prioridade</label><select id="projPriority" class="input-style"><option value="Média">Média</option><option value="Alta">Alta</option><option value="Urgente">Urgente</option><option value="Baixa">Baixa</option></select></div>
                                <div><label class="field-label">SEI</label><input type="text" id="projSei" class="input-style"></div>
                                <div><label class="field-label">Prazo</label><input type="date" id="projPrazo" class="input-style"></div>
                                <div id="operationalDurationField" class="hidden-field"><label class="field-label">Duração (Dias)</label><input type="number" id="projDuration" class="input-style"></div>
                            </div>
                            <div><label class="field-label">Link Docs</label><div class="doc-link-container"><input type="text" id="projDocs" class="bg-transparent outline-none flex-1 text-center" placeholder="URL SharePoint/Drive"></div></div>
                            
                            <h4 class="form-section-title mt-6">03. Acompanhamento</h4>
                            <div><label class="field-label">Coordenação</label><select id="projCoord" class="input-style"><option value="EPT">EPT</option><option value="CEC">CEC</option><option value="CET">CET</option><option value="CGSV">CGSV</option><option value="COST">COST</option><option value="CIST">CIST</option></select></div>
                            <div id="serviceField" class="hidden-field"><label class="field-label">Serviço</label><select id="projService" class="input-style"><option value="SCCE">SCCE</option><option value="SDCG">SDCG</option><option value="SFP">SFP</option><option value="SIEDU">SIEDU</option><option value="SOPED">SOPED</option><option value="SETEF">SETEF</option><option value="SDMP">SDMP</option><option value="SDAP">SDAP</option><option value="SAST">SAST</option><option value="RENAEST">RENAEST</option><option value="SESV">SESV</option><option value="SMO">SMO</option><option value="SEP">SEP</option><option value="STSV">STSV</option><option value="SISV">SISV</option><option value="SIM">SIM</option><option value="SGR">SGR</option><option value="SAT">SAT</option><option value="SENT">SENT</option><option value="SFI">SFI</option></select></div>
                            <div><label class="field-label">Status</label><select id="projStatus" class="input-style" onchange="toggleRiskInput()"></select></div>
                            <div id="riskField" class="hidden-field"><label class="field-label text-red-600">Riscos</label><textarea id="projRisks" rows="2" class="input-style bg-red-50 border-red-200"></textarea></div>
                        </div>
                    </div>
                    <div id="roadmapSection" class="mt-6">
                        <div class="flex justify-between items-center mb-2"><h4 class="form-section-title mb-0 border-0">04. Roadmap</h4><button type="button" onclick="addRoadmapRow()" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded font-bold hover:bg-blue-200">+ Etapa</button></div>
                        <div id="roadmapContainer" class="space-y-2"></div>
                    </div>
                    
                    <div class="mt-8 flex gap-4 pt-4 border-t border-slate-100">
                        <button type="button" id="btnDeleteProject" onclick="deleteProject()" class="hidden px-6 py-3 bg-red-50 text-red-600 rounded-xl font-bold text-xs uppercase hover:bg-red-100 border border-red-100"><i class="fas fa-trash-alt mr-2"></i> Excluir</button>
                        <button type="button" onclick="saveProject()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 uppercase text-xs tracking-widest shadow-lg">Gravar Dados</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="indicatorModal" class="items-center justify-center p-2 sm:p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl border border-slate-200 flex flex-col max-h-[90vh]">
            <div class="bg-gradient-to-r from-pink-600 to-rose-500 px-6 py-4 flex justify-between items-center text-white shrink-0">
                <h3 class="font-black uppercase">Atualizar Indicador</h3>
                <button onclick="toggleModal('indicatorModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <form id="indicatorForm">
                    <input type="hidden" id="indId">
                    <h4 id="indNameDisplay" class="text-lg font-black text-slate-800 mb-1">Nome</h4>
                    <p class="text-xs text-slate-500 font-bold uppercase mb-6">Meta: <span id="indMetaDisplay" class="text-pink-600"></span></p>
                    
                    <div id="indPpaSection" class="hidden mb-6 p-4 bg-slate-50 rounded-xl border border-slate-100">
                        <h5 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 border-b border-slate-200 pb-1">Histórico PPA</h5>
                        <div id="indPpaGrid" class="grid grid-cols-2 gap-4"></div>
                    </div>
                    
                    <div id="indMonths2025Wrapper" class="hidden mb-6 p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                        <h5 class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2 border-b border-indigo-200 pb-1">2025 (Histórico)</h5>
                        <div class="grid grid-cols-3 sm:grid-cols-4 gap-2" id="indMonthsGrid2025"></div>
                    </div>
                    
                    <h5 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 border-b border-slate-100 pb-1">2026 (Realizado)</h5>
                    <div class="grid grid-cols-3 sm:grid-cols-4 gap-2" id="indMonthsGrid"></div>
                    
                    <div class="mt-6 flex justify-end">
                        <button type="button" onclick="saveIndicator()" class="bg-pink-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-pink-700 uppercase text-xs">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="calendarModal" class="items-center justify-center p-2 sm:p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg border border-slate-200 flex flex-col">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center shrink-0">
                 <h3 class="font-black text-slate-800 uppercase">Evento</h3>
                 <button onclick="toggleModal('calendarModal')" class="w-8 h-8 rounded-full hover:bg-slate-100"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <form id="calendarForm" class="space-y-4">
                    <input type="hidden" id="calEventId">
                    <div><label class="field-label">Título</label><input type="text" id="calEventName" class="input-style" required></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="field-label">Data</label><input type="date" id="calEventDate" class="input-style" required></div>
                        <div><label class="field-label">Área</label><select id="calEventArea" class="input-style"></select></div>
                    </div>
                    <div><label class="field-label">Obs</label><textarea id="calEventObs" rows="2" class="input-style"></textarea></div>
                    <div class="flex gap-3 pt-4">
                        <button type="button" id="btnDeleteEvent" onclick="deleteCalendarEvent()" class="px-4 py-3 bg-red-50 text-red-600 rounded-xl font-bold text-xs uppercase hover:bg-red-100 hidden"><i class="fas fa-trash"></i></button>
                        <button type="button" onclick="saveCalendarEvent()" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 uppercase text-xs">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="appShell" class="flex flex-col md:flex-row h-dvh md:h-screen overflow-hidden">
        <aside class="w-full md:w-64 bg-slate-900 text-white flex flex-col shadow-xl shrink-0 z-30 h-auto md:h-full">
            <div class="p-4 border-b border-slate-800">
                <h1 class="text-xl font-bold uppercase">DSV <span class="text-blue-400">2026</span></h1>
                <div id="sysStatus" class="mt-4 flex items-center gap-2 text-[10px] font-black uppercase py-2 px-3 rounded-lg border border-slate-700 bg-slate-800">
                    <span id="sysStatusDot" class="w-2 h-2 rounded-full bg-slate-500"></span><span id="sysStatusText" class="text-slate-400">Iniciando...</span>
                </div>
            </div>
            <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
                <button onclick="switchTab('projects')" id="tab-projects" class="tab-btn w-full flex items-center p-2 rounded-lg text-xs font-bold uppercase"><i class="fas fa-folder w-6"></i> Projetos</button>
                <button onclick="switchTab('contracts')" id="tab-contracts" class="tab-btn w-full flex items-center p-2 rounded-lg text-xs font-bold uppercase"><i class="fas fa-file-contract w-6"></i> Contratos</button>
                <button onclick="switchTab('operational')" id="tab-operational" class="tab-btn w-full flex items-center p-2 rounded-lg text-xs font-bold uppercase"><i class="fas fa-tasks w-6"></i> Operacional</button>
                <button onclick="switchTab('indicators')" id="tab-indicators" class="tab-btn w-full flex items-center p-2 rounded-lg text-xs font-bold uppercase"><i class="fas fa-chart-line w-6"></i> Indicadores</button>
                <button onclick="switchTab('calendar')" id="tab-calendar" class="tab-btn w-full flex items-center p-2 rounded-lg text-xs font-bold uppercase"><i class="fas fa-calendar-alt w-6"></i> Calendário</button>
                <button onclick="switchTab('portaria')" id="tab-portaria" class="tab-btn w-full flex items-center p-2 rounded-lg text-xs font-bold uppercase"><i class="fas fa-book w-6"></i> Portaria</button>
                
                <div class="pt-4 border-t border-slate-700 mt-4">
                    <p class="text-[10px] text-slate-500 uppercase font-black px-2 mb-2">Filtro Coordenação</p>
                    <div id="coordBtnContainer" class="grid grid-cols-2 gap-2">
                        <button id="coord-EPT" onclick="setFilter('EPT')" class="coord-btn bg-slate-800 p-2 rounded text-[10px] font-bold">EPT</button>
                        <button id="coord-CEC" onclick="setFilter('CEC')" class="coord-btn bg-slate-800 p-2 rounded text-[10px] font-bold">CEC</button>
                        <button id="coord-CET" onclick="setFilter('CET')" class="coord-btn bg-slate-800 p-2 rounded text-[10px] font-bold">CET</button>
                        <button id="coord-CGSV" onclick="setFilter('CGSV')" class="coord-btn bg-slate-800 p-2 rounded text-[10px] font-bold">CGSV</button>
                        <button id="coord-COST" onclick="setFilter('COST')" class="coord-btn bg-slate-800 p-2 rounded text-[10px] font-bold">COST</button>
                        <button id="coord-CIST" onclick="setFilter('CIST')" class="coord-btn bg-slate-800 p-2 rounded text-[10px] font-bold">CIST</button>
                        <button onclick="setFilter('all')" class="coord-btn col-span-2 bg-slate-700 p-2 rounded text-[10px] font-bold uppercase">Limpar Filtro</button>
                    </div>
                </div>
            </nav>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden bg-slate-50 relative">
            <header class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm shrink-0">
                <h2 id="viewTitle" class="text-lg font-black text-slate-800 uppercase">Visão Geral</h2>
                <input type="text" id="searchInput" oninput="renderData()" placeholder="Pesquisar..." class="bg-slate-50 border border-slate-100 rounded-lg px-4 py-2 text-xs outline-none w-64">
            </header>

            <div id="contentArea" class="flex-1 overflow-y-auto p-6 pb-24">
                <div id="standardView">
                    <div id="statsWrapper" class="flex flex-col xl:flex-row gap-6 mb-8">
                        <div class="flex-1 responsive-stats-grid">
                            <div id="cardTotal" onclick="setListFilter('all')" class="stat-card bg-white p-3 rounded-xl border border-slate-200 shadow-sm active-filter"><p class="text-[9px] text-slate-400 font-black uppercase">Total</p><div id="statTotal" class="text-xl font-black text-slate-800">0</div></div>
                            <div id="cardBacklog" onclick="setListFilter('Backlog')" class="stat-card bg-white p-3 rounded-xl border border-slate-200 shadow-sm"><p class="text-[9px] text-slate-400 font-black uppercase">Backlog</p><div id="statBacklog" class="text-xl font-black text-slate-600">0</div></div>
                            <div id="cardIniciado" onclick="setListFilter('Iniciado')" class="stat-card bg-white p-3 rounded-xl border border-sky-200 shadow-sm"><p class="text-[9px] text-sky-600 font-black uppercase">Iniciado</p><div id="statIniciado" class="text-xl font-black text-slate-800">0</div></div>
                            <div id="cardPlanejado" onclick="setListFilter('Em Planejamento')" class="stat-card bg-white p-3 rounded-xl border border-indigo-200 shadow-sm"><p class="text-[9px] text-indigo-600 font-black uppercase">Planejamento</p><div id="statPlanejado" class="text-xl font-black text-slate-800">0</div></div>
                            <div id="cardExecDP" onclick="setListFilter('Em Execução (Dentro do Planejado)')" class="stat-card bg-white p-3 rounded-xl border border-green-200 shadow-sm"><p class="text-[9px] text-green-600 font-black uppercase">Execução OK</p><div id="statExecDP" class="text-xl font-black text-slate-800">0</div></div>
                            <div id="cardExecEA" onclick="setListFilter('Em Execução (Atenção)')" class="stat-card bg-white p-3 rounded-xl border border-amber-200 shadow-sm"><p class="text-[9px] text-amber-600 font-black uppercase">Atenção</p><div id="statExecEA" class="text-xl font-black text-slate-800">0</div></div>
                            <div id="cardCritico" onclick="setListFilter('Crítico')" class="stat-card bg-white p-3 rounded-xl border border-red-200 shadow-sm"><p class="text-[9px] text-red-600 font-black uppercase">Crítico</p><div id="statCritico" class="text-xl font-black text-slate-800">0</div></div>
                            <div id="cardConcluido" onclick="setListFilter('Concluído')" class="stat-card bg-white p-3 rounded-xl border border-emerald-200 shadow-sm"><p class="text-[9px] text-emerald-600 font-black uppercase">Concluído</p><div id="statConcluido" class="text-xl font-black text-slate-800">0</div></div>
                        </div>
                    </div>

                    <div id="operationalFilters" class="mb-4 hidden">
                        <select id="filterService" onchange="renderData()" class="input-style"><option value="all">Todos os Serviços</option><option value="SCCE">SCCE</option><option value="SDCG">SDCG</option><option value="SFP">SFP</option><option value="SIEDU">SIEDU</option><option value="SOPED">SOPED</option><option value="SETEF">SETEF</option><option value="SDMP">SDMP</option><option value="SDAP">SDAP</option><option value="SAST">SAST</option><option value="RENAEST">RENAEST</option><option value="SESV">SESV</option><option value="SMO">SMO</option><option value="SEP">SEP</option><option value="STSV">STSV</option><option value="SISV">SISV</option><option value="SIM">SIM</option><option value="SGR">SGR</option><option value="SAT">SAT</option><option value="SENT">SENT</option><option value="SFI">SFI</option></select>
                    </div>

                    <button id="addBtn" onclick="openNewModal()" class="w-full py-4 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-black uppercase hover:border-blue-500 hover:text-blue-500 mb-6 transition-all">Adicionar Novo</button>
                    <div id="projectsList" class="space-y-4"></div>
                </div>

                <div id="indicatorsView" class="hidden space-y-8">
                    <h3 class="font-black text-slate-400 uppercase tracking-widest border-b pb-2">Estratégicos PPA</h3>
                    <div id="indicatorsList" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div>
                    <h3 class="font-black text-slate-400 uppercase tracking-widest border-b pb-2 pt-6">Outros Indicadores</h3>
                    <div id="otherIndicatorsList" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div>
                </div>

                <div id="calendarView" class="hidden space-y-6">
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 flex justify-between items-center shadow-sm">
                        <div class="flex items-center gap-4">
                            <button onclick="changeMonth(-1)" class="w-8 h-8 rounded-full border hover:bg-slate-100"><i class="fas fa-chevron-left"></i></button>
                            <div class="text-center"><h2 id="calMonthName" class="text-2xl font-black text-blue-900 capitalize">Mês</h2><p id="calYearName" class="text-sm font-bold text-slate-400">Ano</p></div>
                            <button onclick="changeMonth(1)" class="w-8 h-8 rounded-full border hover:bg-slate-100"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <button onclick="openCalendarModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold uppercase text-xs">Novo Evento</button>
                    </div>
                    <div class="overflow-x-auto"><div id="calendarGrid" class="grid grid-cols-7 gap-2 min-w-[800px]"></div></div>
                    <div class="bg-white p-6 rounded-2xl border border-slate-200">
                        <div class="flex justify-between mb-4"><h3 id="eventListTitle" class="font-black text-slate-500 uppercase">Eventos do Mês</h3><button id="clearDayFilterBtn" onclick="filterCalendarByDay(null)" class="hidden text-xs text-blue-600 font-bold">Limpar Filtro</button></div>
                        <div id="calendarEventsList" class="space-y-2"></div>
                    </div>
                </div>

                <div id="portariaView" class="hidden space-y-6">
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-6">
                        <button onclick="setPortariaFilter('all')" class="portaria-filter-btn filter-all active" id="pf-all">Todos</button>
                        <button onclick="setPortariaFilter('Diretoria')" class="portaria-filter-btn filter-diretoria" id="pf-Diretoria">Diretoria</button>
                        <button onclick="setPortariaFilter('Coordenadoria')" class="portaria-filter-btn filter-coordenadoria" id="pf-Coordenadoria">Coordenadorias</button>
                        <button onclick="setPortariaFilter('Divisão')" class="portaria-filter-btn filter-divisao" id="pf-Divisão">Divisões</button>
                        <button onclick="setPortariaFilter('Serviço')" class="portaria-filter-btn filter-servico" id="pf-Serviço">Serviços</button>
                    </div>
                    <div id="portariaList" class="space-y-4"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- CONFIGURAÇÃO GLOBAL ---
        const firebaseConfig = {
            apiKey: "AIzaSyBVT30qEXkwHw1Le012oKnEJyAUYcwQC8U",
            authDomain: "painel-gestao-d674d.firebaseapp.com",
            projectId: "painel-gestao-d674d",
            storageBucket: "painel-gestao-d674d.firebasestorage.app",
            messagingSenderId: "993067198876",
            appId: "1:993067198876:web:36e56d669c61437c5ec059"
        };
        
        const app = initializeApp(firebaseConfig);
        window.auth = getAuth(app);
        window.db = getFirestore(app);
        
        // --- DADOS E VARIÁVEIS ---
        const appId = 'painel-gestao-main';
        let currentUser = null;
        let activeTab = 'projects';
        let currentFilter = 'all';
        let currentListFilter = 'all';
        let currentPortariaFilter = 'all';
        let currentDate = new Date(2026, 0, 1);
        let selectedCalendarDay = null;

        const UNIFIED_STATUS = ["Backlog", "Iniciado", "Em Planejamento", "Em Execução (Dentro do Planejado)", "Em Execução (Atenção)", "Em Execução (Em Risco / Atrasado)", "Crítico", "Concluído"];
        const STATUS_COLORS_BG = { "Backlog": "bg-slate-300", "Iniciado": "bg-sky-400", "Em Planejamento": "bg-indigo-500", "Em Execução (Dentro do Planejado)": "bg-green-500", "Em Execução (Atenção)": "bg-amber-400", "Em Execução (Em Risco / Atrasado)": "bg-orange-500", "Crítico": "bg-red-600", "Concluído": "bg-emerald-600" };
        const areasList = ["DSV", "EPT", "CEC", "CET", "CGSV", "COST", "CIST", "SCCE", "SDCG", "SFP", "SIEDU", "SOPED", "SETEF", "SDMP", "SDAP", "SAST", "RENAEST", "SESV", "SMO", "SEP", "STSV", "SISV", "SIM", "SGR", "SAT", "SENT", "SFI"];

        let dataStore = { projects: [], contracts: [], operational: [], calendarEvents: [], indicators: [] };

        // --- DADOS ESTÁTICOS ---
        const INITIAL_INDICATORS = [
            { id: 'ind_5736', code: '5736', product: 'RESPEITO À VIDA', name: 'NÚMERO DE MUNICÍPIOS INTEGRADOS AO SNT', meta: 75, unit: 'un', rule: 'Soma', type: 'ppa', monthly: [0,0,0,0,0,0,0,0,0,0,0,0], ppa: { '2024': 50, '2025': 75, '2026': 75, '2027': 103 }, ppaRealized: { '2025': 0 } },
            { id: 'ind_5737', code: '5737', product: 'RESPEITO À VIDA', name: 'TAXA DE ÓBITOS POR SINISTROS (/100k hab)', meta: 9.55, unit: '/100k hab', rule: 'Último', type: 'ppa', monthly: [0,0,0,0,0,0,0,0,0,0,0,0], ppa: { '2024': 10.18, '2025': 9.87, '2026': 9.55, '2027': 9.24 }, ppaRealized: { '2025': 0 } },
            { id: 'ind_5801', code: '5801', product: 'CAPACITAÇÃO', name: 'VAGAS OFERECIDAS (EPT)', meta: 228131, unit: 'un', rule: 'Último', type: 'ppa', monthly: [0,0,0,0,0,0,0,0,0,0,0,0], ppa: { '2024': 172500, '2025': 198375, '2026': 228131, '2027': 330789 }, ppaRealized: { '2025': 0 } },
            { id: 'ind_5802', code: '5802', product: 'CAPACITAÇÃO', name: 'PERCENTUAL CERTIFICADOS', meta: 90, unit: '%', rule: 'Último', type: 'ppa', monthly: [0,0,0,0,0,0,0,0,0,0,0,0], ppa: { '2024': 86, '2025': 88, '2026': 90, '2027': 92 }, ppaRealized: { '2025': 0 } },
            { id: 'ind_other_01', code: 'SISTRAN', product: 'OUTROS', name: 'MUNICÍPIOS NO SISTRAN', meta: 0, unit: 'un', rule: 'Soma', type: 'other', monthly: [0,0,0,0,0,0,0,0,0,0,0,0], ppa: { '2026': 0 }, ppaRealized: {} },
            { id: 'ind_other_03', code: 'INFOSIGA', product: 'DADOS', name: 'ACESSOS INFOSIGA', meta: 0, unit: 'acessos', rule: 'Soma', type: 'other', monthly: [0,0,0,0,0,0,0,0,0,0,0,0], monthly_2025: [0,0,0,0,0,0,0,0,0,0,0,0], ppa: { '2025': 0, '2026': 0 }, ppaRealized: { '2025': 0 } }
        ];

        const PORTARIA_DATA = [
            { art: 'Art. 256', title: 'Diretoria de Segurança Viária', type: 'Diretoria', items: ['Gestão da Segurança Viária', 'Educação Corporativa', 'Gestão de Convênios'] },
            { art: 'Art. 257', title: 'Escola Pública de Trânsito', type: 'Coordenadoria', items: ['Educação para o Trânsito', 'Cidadania', 'Campanhas'] },
            { art: 'Art. 258', title: 'Coord. Educação Corporativa', type: 'Coordenadoria', items: ['Treinamento Interno', 'Gestão do Conhecimento'] },
            { art: 'Art. 268', title: 'Coord. Geral de Segurança Viária', type: 'Coordenadoria', items: ['Planos de Redução de Mortes', 'Estatísticas'] },
            { art: 'Art. 270', title: 'Divisão de Estatísticas', type: 'Divisão', items: ['Banco de Dados', 'Análise de Sinistros'] }
            // (Adicionei alguns principais para resumir, o código aceita mais se quiser)
        ];

        // --- FUNÇÕES DE INICIALIZAÇÃO ---
        async function initAuth() {
            try {
                await signInAnonymously(window.auth);
            } catch (error) {
                console.error("Auth Error:", error);
                document.getElementById('sysStatusText').innerText = "Erro Auth (Ver Console)";
                document.getElementById('sysStatusDot').classList.replace('bg-slate-500', 'bg-red-600');
            }
        }

        function initListeners() {
            ['projects', 'contracts', 'operational', 'calendar_events', 'indicators'].forEach(colName => {
                const storeKey = colName === 'calendar_events' ? 'calendarEvents' : colName;
                onSnapshot(collection(window.db, 'artifacts', appId, 'public', 'data', colName), (snapshot) => {
                    let items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (colName === 'indicators' && items.length === 0) dataStore[storeKey] = INITIAL_INDICATORS;
                    else dataStore[storeKey] = items;
                    
                    document.getElementById('sysStatusText').innerText = snapshot.metadata.hasPendingWrites ? 'Sincronizando...' : 'Online';
                    document.getElementById('sysStatusDot').className = `w-2 h-2 rounded-full ${snapshot.metadata.hasPendingWrites ? 'bg-amber-400' : 'bg-emerald-400'}`;
                    renderData();
                });
            });
        }

        // --- FUNÇÕES DE UI E LÓGICA ---
        window.toggleModal = (id) => { const m = document.getElementById(id); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; };

        window.switchTab = (tab) => {
            activeTab = tab; currentListFilter = 'all'; currentFilter = 'all';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('bg-blue-600', 'text-white', 'bg-purple-600', 'bg-orange-500', 'bg-pink-600', 'bg-indigo-600', 'bg-cyan-600'));
            const colors = { projects: 'bg-blue-600', contracts: 'bg-purple-600', operational: 'bg-orange-500', indicators: 'bg-pink-600', calendar: 'bg-indigo-600', portaria: 'bg-cyan-600' };
            document.getElementById(`tab-${tab}`).classList.add(colors[tab], 'text-white');
            
            ['standardView', 'indicatorsView', 'calendarView', 'portariaView'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById('operationalFilters').classList.add('hidden');
            document.getElementById('addBtn').parentElement.classList.add('hidden');

            if (tab === 'indicators') { document.getElementById('indicatorsView').classList.remove('hidden'); renderIndicators(); }
            else if (tab === 'calendar') { document.getElementById('calendarView').classList.remove('hidden'); renderCalendar(); }
            else if (tab === 'portaria') { document.getElementById('portariaView').classList.remove('hidden'); renderPortaria(); }
            else {
                document.getElementById('standardView').classList.remove('hidden');
                document.getElementById('addBtn').parentElement.classList.remove('hidden');
                if (tab === 'operational') document.getElementById('operationalFilters').classList.remove('hidden');
                renderData();
            }
        };

        // --- CRUD PROJETOS/CONTRATOS/OPERACIONAL ---
        window.openNewModal = () => {
            document.getElementById('projectForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('roadmapContainer').innerHTML = '';
            document.getElementById('actorsTagContainer').innerHTML = '<input type="text" id="actorInput" class="bg-transparent outline-none flex-1 min-w-[100px]" placeholder="Digite + Enter">';
            document.getElementById('btnDeleteProject').classList.add('hidden'); // Esconde deletar
            
            // Configura campos baseados na aba
            ['contractTypeField', 'contractRelationWrapper', 'resourceLogicField', 'resourceValueField', 'relationalField', 'serviceField', 'operationalDurationField', 'riskField'].forEach(id => document.getElementById(id).classList.add('hidden-field'));
            
            const statusSelect = document.getElementById('projStatus');
            statusSelect.innerHTML = UNIFIED_STATUS.map(s => `<option value="${s}">${s}</option>`).join('');

            if (activeTab === 'contracts') {
                ['contractTypeField', 'contractRelationWrapper', 'resourceLogicField'].forEach(id => document.getElementById(id).classList.remove('hidden-field'));
                document.getElementById('modalTitle').innerText = 'Novo Contrato';
            } else if (activeTab === 'operational') {
                ['relationalField', 'serviceField', 'operationalDurationField'].forEach(id => document.getElementById(id).classList.remove('hidden-field'));
                document.getElementById('modalTitle').innerText = 'Nova Atividade';
            } else {
                document.getElementById('modalTitle').innerText = 'Novo Projeto';
            }
            toggleModal('projectModal');
        };

        window.saveProject = async () => {
            if (!currentUser) return alert('Aguarde autenticação...');
            const id = document.getElementById('editId').value || Date.now().toString();
            
            const roadmap = [];
            document.querySelectorAll('#roadmapContainer > div').forEach(row => {
                const d = row.querySelector('.rd-date').value;
                const e = row.querySelector('.rd-step').value;
                if (d && e) roadmap.push({ data: d, etapa: e });
            });

            const actors = Array.from(document.querySelectorAll('.actor-tag span')).map(s => s.innerText);

            const data = {
                name: document.getElementById('projName').value,
                desc: document.getElementById('projDesc').value,
                obs: document.getElementById('projObs').value,
                manager: document.getElementById('projManager').value,
                actors: actors,
                sei: document.getElementById('projSei').value,
                prazo: document.getElementById('projPrazo').value,
                coord: document.getElementById('projCoord').value,
                status: document.getElementById('projStatus').value,
                priority: document.getElementById('projPriority').value,
                docLink: document.getElementById('projDocs').value,
                risks: document.getElementById('projRisks').value,
                updatedAt: Date.now()
            };

            if (activeTab === 'contracts') {
                data.type = document.getElementById('projType').value;
                data.hasResource = document.getElementById('projHasResource').value;
                data.resourceValue = document.getElementById('projResourceValue').value;
            } else if (activeTab === 'operational') {
                data.service = document.getElementById('projService').value;
                data.duration = document.getElementById('projDuration').value;
            }

            try {
                await setDoc(doc(window.db, 'artifacts', appId, 'public', 'data', activeTab, id), data);
                toggleModal('projectModal');
            } catch (err) { console.error(err); alert('Erro ao salvar.'); }
        };

        window.deleteProject = async () => {
            const id = document.getElementById('editId').value;
            if (!id) return;
            if (confirm("Tem certeza que deseja EXCLUIR este registro?")) {
                try {
                    await deleteDoc(doc(window.db, 'artifacts', appId, 'public', 'data', activeTab, id));
                    toggleModal('projectModal');
                } catch (err) { console.error(err); alert('Erro ao excluir.'); }
            }
        };

        window.editItem = (id, tab = activeTab) => {
            const item = dataStore[tab]?.find(i => i.id === id);
            if (!item) return;
            window.openNewModal();
            document.getElementById('btnDeleteProject').classList.remove('hidden'); // Mostra deletar
            document.getElementById('editId').value = item.id;
            
            // Preenche campos
            document.getElementById('projName').value = item.name || '';
            document.getElementById('projDesc').value = item.desc || '';
            document.getElementById('projObs').value = item.obs || '';
            document.getElementById('projManager').value = item.manager || '';
            document.getElementById('projSei').value = item.sei || '';
            document.getElementById('projPrazo').value = item.prazo || '';
            document.getElementById('projCoord').value = item.coord || 'EPT';
            document.getElementById('projStatus').value = item.status || 'Backlog';
            document.getElementById('projPriority').value = item.priority || 'Média';
            document.getElementById('projDocs').value = item.docLink || '';
            document.getElementById('projRisks').value = item.risks || '';
            
            if (item.actors) {
                const container = document.getElementById('actorsTagContainer');
                const input = document.getElementById('actorInput');
                item.actors.forEach(act => {
                    const tag = document.createElement('div');
                    tag.className = 'actor-tag';
                    tag.innerHTML = `<span>${act}</span><i class="fas fa-times cursor-pointer" onclick="this.parentElement.remove()"></i>`;
                    container.insertBefore(tag, input);
                });
            }

            if (item.roadmap) item.roadmap.forEach(r => addRoadmapRow(r.data, r.etapa));
            window.toggleRiskInput();
            
            if (tab === 'contracts') {
                document.getElementById('projType').value = item.type || 'Contrato';
                if(item.resourceValue) {
                    document.getElementById('projHasResource').value = 'Sim';
                    document.getElementById('projResourceValue').value = item.resourceValue;
                    window.toggleResourceInput();
                }
            } else if (tab === 'operational') {
                document.getElementById('projService').value = item.service || 'SCCE';
                document.getElementById('projDuration').value = item.duration || '';
            }
        };

        // --- RENDERIZAÇÃO ---
        window.renderData = () => {
            const list = document.getElementById('projectsList');
            list.innerHTML = '';
            
            let data = dataStore[activeTab] || [];
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            if (search) data = data.filter(i => i.name.toLowerCase().includes(search));
            if (currentFilter !== 'all') data = data.filter(i => i.coord === currentFilter);
            if (currentListFilter !== 'all') data = data.filter(i => i.status === currentListFilter);
            if (activeTab === 'operational' && document.getElementById('filterService').value !== 'all') {
                data = data.filter(i => i.service === document.getElementById('filterService').value);
            }

            // Atualiza Cards
            const counts = {}; UNIFIED_STATUS.forEach(s => counts[s] = 0);
            data.forEach(i => counts[i.status] = (counts[i.status] || 0) + 1);
            document.getElementById('statTotal').innerText = data.length;
            ['Backlog','Iniciado','Crítico','Concluído'].forEach(s => document.getElementById('stat'+s).innerText = counts[s]);
            document.getElementById('statPlanejado').innerText = counts['Em Planejamento'];
            document.getElementById('statExecDP').innerText = counts['Em Execução (Dentro do Planejado)'];
            document.getElementById('statExecEA').innerText = counts['Em Execução (Atenção)'];

            data.forEach(item => {
                const color = STATUS_COLORS_BG[item.status] || 'bg-slate-200';
                const div = document.createElement('div');
                div.className = 'accordion-row bg-white border border-slate-200 rounded-xl overflow-hidden';
                div.innerHTML = `
                    <div class="p-4 flex flex-col sm:flex-row gap-4 items-center cursor-pointer" onclick="this.parentElement.classList.toggle('active')">
                        <div class="w-2 h-10 rounded-full ${color}"></div>
                        <div class="flex-1">
                            <h4 class="font-bold text-slate-800">${item.name}</h4>
                            <div class="flex gap-2 text-[10px] font-bold uppercase text-slate-400 mt-1">
                                <span>${item.coord}</span> <span>•</span> <span>${item.status}</span>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); editItem('${item.id}')" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:text-blue-600"><i class="fas fa-edit"></i></button>
                    </div>
                    <div class="accordion-content bg-slate-50 px-6">
                        <div class="py-4 space-y-2 text-sm text-slate-600">
                            <p><strong>Descrição:</strong> ${item.desc || '-'}</p>
                            <p><strong>Gestor:</strong> ${item.manager || '-'}</p>
                            <p><strong>Prazo:</strong> ${item.prazo ? new Date(item.prazo+"T00:00:00").toLocaleDateString('pt-BR') : '-'}</p>
                            ${item.risks ? `<p class="text-red-600 font-bold bg-red-50 p-2 rounded">⚠️ ${item.risks}</p>` : ''}
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        };

        // --- UTILITÁRIOS E OUTRAS ABAS (Resumido para caber, mas funcional) ---
        window.addRoadmapRow = (d='', e='') => {
            const row = document.createElement('div');
            row.className = 'flex gap-2';
            row.innerHTML = `<input type="date" class="rd-date input-style w-1/3" value="${d}"><input type="text" class="rd-step input-style flex-1" value="${e}" placeholder="Etapa"><button type="button" onclick="this.parentElement.remove()" class="text-red-400"><i class="fas fa-trash"></i></button>`;
            document.getElementById('roadmapContainer').appendChild(row);
        };
        
        window.toggleContractRelInput = () => document.getElementById('projectSelectWrapper').classList.toggle('hidden-field', !document.querySelector('input[name="contractRelType"][value="sim"]').checked);
        window.toggleResourceInput = () => document.getElementById('resourceValueField').classList.toggle('hidden-field', document.getElementById('projHasResource').value !== 'Sim');
        window.toggleOriginInput = () => document.getElementById('projectSelectWrapper').classList.toggle('hidden-field', !document.querySelector('input[name="originType"][value="projeto"]').checked);
        window.toggleRiskInput = () => document.getElementById('riskField').classList.toggle('hidden-field', !["Em Execução (Atenção)", "Em Execução (Em Risco / Atrasado)", "Crítico"].includes(document.getElementById('projStatus').value));
        window.setListFilter = (f) => { currentListFilter = f; document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active-filter')); renderData(); };
        window.setFilter = (f) => { currentFilter = f; renderData(); };
        
        // --- PORTARIA ---
        window.setPortariaFilter = (f) => { currentPortariaFilter = f; document.querySelectorAll('.portaria-filter-btn').forEach(b => b.classList.remove('active')); document.getElementById('pf-'+f)?.classList.add('active'); renderPortaria(); };
        window.renderPortaria = () => {
            const c = document.getElementById('portariaList'); c.innerHTML = '';
            let d = PORTARIA_DATA.filter(i => currentPortariaFilter === 'all' || i.type === currentPortariaFilter);
            d.forEach(i => c.innerHTML += `<div class="portaria-card type-${i.type.toLowerCase()}"><div class="flex justify-between mb-2"><span class="text-xs font-black text-slate-400">${i.art}</span><span class="portaria-badge badge-${i.type.toLowerCase()}">${i.type}</span></div><h4 class="font-bold mb-2">${i.title}</h4><ul class="list-disc pl-4 text-xs text-slate-600">${i.items.map(x => `<li>${x}</li>`).join('')}</ul></div>`);
        };

        // --- CALENDÁRIO (Simplificado) ---
        window.changeMonth = (o) => { currentDate.setMonth(currentDate.getMonth() + o); renderCalendar(); };
        window.filterCalendarByDay = (d) => { selectedCalendarDay = d; renderCalendar(); };
        window.renderCalendar = () => {
            const grid = document.getElementById('calendarGrid'); grid.innerHTML = '';
            const list = document.getElementById('calendarEventsList'); list.innerHTML = '';
            const y = currentDate.getFullYear(), m = currentDate.getMonth();
            const mn = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            document.getElementById('calMonthName').innerText = mn[m]; document.getElementById('calYearName').innerText = y;
            
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            
            for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
            
            let monthEvents = [];
            ['projects', 'contracts', 'operational', 'calendarEvents'].forEach(k => {
                (dataStore[k] || []).forEach(e => {
                    if (e.prazo) {
                        const [ey, em, ed] = e.prazo.split('-');
                        if(parseInt(ey) === y && parseInt(em) === m+1) monthEvents.push({...e, day: parseInt(ed), type: k});
                    }
                });
            });

            for(let d=1; d<=daysInMonth; d++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-new-day-cell';
                const dayEvts = monthEvents.filter(e => e.day === d);
                cell.innerHTML = `<span class="text-[10px] font-bold text-slate-400 block text-right">${d}</span>`;
                if(dayEvts.length > 0) cell.innerHTML += `<span class="block bg-blue-100 text-blue-600 text-[9px] font-bold px-1 rounded text-center cursor-pointer" onclick="filterCalendarByDay('${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}')">${dayEvts.length} eventos</span>`;
                grid.appendChild(cell);
            }
            
            const displayEvts = selectedCalendarDay ? monthEvents.filter(e => e.prazo === selectedCalendarDay) : monthEvents;
            document.getElementById('clearDayFilterBtn').classList.toggle('hidden', !selectedCalendarDay);
            displayEvts.forEach(e => list.innerHTML += `<div class="p-2 border rounded text-xs flex justify-between"><span>${e.name}</span><span class="font-bold text-slate-400">${e.prazo}</span></div>`);
        };
        
        window.openCalendarModal = () => { document.getElementById('calendarForm').reset(); document.getElementById('calEventId').value = ''; toggleModal('calendarModal'); };
        window.saveCalendarEvent = async () => {
            const id = document.getElementById('calEventId').value || Date.now().toString();
            await setDoc(doc(window.db, 'artifacts', appId, 'public', 'data', 'calendarEvents', id), {
                name: document.getElementById('calEventName').value,
                prazo: document.getElementById('calEventDate').value,
                area: document.getElementById('calEventArea').value,
                obs: document.getElementById('calEventObs').value
            });
            toggleModal('calendarModal');
        };

        // --- INDICADORES (Simplificado) ---
        window.renderIndicators = () => {
            const c1 = document.getElementById('indicatorsList'); c1.innerHTML = '';
            const c2 = document.getElementById('otherIndicatorsList'); c2.innerHTML = '';
            const data = dataStore.indicators.length ? dataStore.indicators : INITIAL_INDICATORS;
            
            data.forEach(ind => {
                const total = ind.rule === 'Soma' ? ind.monthly.reduce((a,b)=>a+Number(b),0) : Number(ind.monthly.filter(x=>x>0).pop()||0);
                const pct = ind.meta > 0 ? Math.round((total/ind.meta)*100) : 0;
                const html = `
                    <div class="indicator-card" onclick="openIndicatorModal('${ind.id}')">
                        <div class="flex justify-between mb-2"><div><span class="text-[10px] font-black uppercase text-pink-500">${ind.code}</span><h4 class="font-bold">${ind.name}</h4></div><span class="text-xl font-black text-pink-700">${total}</span></div>
                        <div class="progress-bg"><div class="progress-fill" style="width: ${Math.min(pct,100)}%"></div></div>
                        <div class="grid grid-cols-6 gap-1 mt-2">${ind.monthly.map((v,i) => `<div class="month-cell"><div class="month-label">${i+1}</div><div class="month-value">${v}</div></div>`).join('')}</div>
                    </div>`;
                if(ind.type === 'ppa') c1.innerHTML += html; else c2.innerHTML += html;
            });
        };
        
        window.openIndicatorModal = (id) => {
            const ind = (dataStore.indicators.length ? dataStore.indicators : INITIAL_INDICATORS).find(i => i.id === id);
            document.getElementById('indId').value = ind.id;
            document.getElementById('indNameDisplay').innerText = ind.name;
            document.getElementById('indMetaDisplay').innerText = ind.meta;
            document.getElementById('indMonthsGrid').innerHTML = ind.monthly.map((v,i) => `<div><label class="text-[9px] uppercase font-bold text-slate-400">${['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'][i]}</label><input type="number" id="indM_${i}" value="${v}" class="input-style text-center"></div>`).join('');
            toggleModal('indicatorModal');
        };

        window.saveIndicator = async () => {
            const id = document.getElementById('indId').value;
            let data = dataStore.indicators.length ? [...dataStore.indicators] : [...INITIAL_INDICATORS];
            const idx = data.findIndex(i => i.id === id);
            if(idx >= 0) {
                for(let i=0; i<12; i++) data[idx].monthly[i] = Number(document.getElementById(`indM_${i}`).value);
                await setDoc(doc(window.db, 'artifacts', appId, 'public', 'data', 'indicators', id), data[idx]);
                toggleModal('indicatorModal');
            }
        };

        // --- AUTH OBSERVER ---
        onAuthStateChanged(window.auth, (user) => {
            currentUser = user;
            if (user) {
                initListeners();
                switchTab('projects');
                document.getElementById('actorInput').addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if(this.value.trim()) {
                            const t = document.createElement('div'); t.className = 'actor-tag'; t.innerHTML = `<span>${this.value}</span><i class="fas fa-times cursor-pointer" onclick="this.parentElement.remove()"></i>`;
                            document.getElementById('actorsTagContainer').insertBefore(t, this); this.value = '';
                        }
                    }
                });
                const sel = document.getElementById('calEventArea'); 
                if(sel.options.length === 0) sel.innerHTML = areasList.map(a => `<option value="${a}">${a}</option>`).join('');
            }
        });

    </script>
</body>
</html>
