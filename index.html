<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSV 2026 - Painel de Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Open Sans', sans-serif; }
        
        .h-dvh { height: 100dvh; }

        /* Modal e Scrollbars */
        #projectModal, #indicatorModal, #newIndicatorModal, #pmgLegendModal, #dispatchModal, #meetingModal, #editMeetingModal, #addBacklogItemModal, #calendarModal, #rasciLegendModal { 
            display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); 
        }
        .modal-container { max-height: 80vh; overflow-y: auto; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        nav::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        nav::-webkit-scrollbar-track { background: transparent; }

        /* Campos de Formulário */
        .field-label { display: block; font-size: 11px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.05em; }
        .input-style { width: 100%; background-color: white; border: 1px solid #dbeafe; border-radius: 0.75rem; padding: 0.75rem 1rem; font-size: 0.95rem; outline: none; transition: all 0.2s; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); appearance: none; color: #0f172a; font-weight: 400; }
        .input-style:focus { box-shadow: 0 0 0 2px #3b82f6; border-color: transparent; }

        .tag-container { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.5rem 1rem; border: 1px solid #dbeafe; border-radius: 0.75rem; min-height: 44px; transition: all 0.2s; cursor: text; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); background-color: #ffffff !important; align-items: center; }
        .tag-container:focus-within { box-shadow: 0 0 0 2px #3b82f6; }

        .actor-tag { font-size: 0.85rem; font-weight: 600; padding: 0.25rem 0.75rem; border-radius: 0.5rem; display: flex; align-items: center; gap: 0.5rem; border: 1px solid; }
        
        /* Cores específicas para tags RASCI */
        .tag-blue { background-color: #dbeafe; color: #1d4ed8; border-color: #bfdbfe; }
        .tag-red { background-color: #fee2e2; color: #b91c1c; border-color: #fecaca; }
        .tag-orange { background-color: #ffedd5; color: #c2410c; border-color: #fed7aa; }
        .tag-purple { background-color: #f3e8ff; color: #7e22ce; border-color: #e9d5ff; }
        .tag-green { background-color: #dcfce7; color: #15803d; border-color: #bbf7d0; }

        .form-section-title { display: flex; align-items: center; gap: 0.5rem; color: #1e293b; font-weight: 900; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.1em; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.75rem; margin-bottom: 1.5rem; }
        .doc-link-container { display: flex; align-items: center; justify-content: center; border: 2px dashed #bfdbfe; border-radius: 0.75rem; padding: 0.75rem; background-color: rgba(239, 246, 255, 0.3); transition: all 0.2s; cursor: pointer; color: #3b82f6; font-weight: 700; font-size: 0.85rem; gap: 0.75rem; }
        .doc-link-container:hover { background-color: #eff6ff; border-color: #60a5fa; }
        .hidden-field { display: none !important; }

        .radio-group { display: flex; gap: 1rem; padding: 0.75rem; background-color: white; border: 1px solid #dbeafe; border-radius: 0.75rem; }
        .radio-option { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.95rem; font-weight: 500; color: #334155; }

        /* Botões de Abas */
        .tab-btn { color: #94a3b8; transition: all 0.2s; }
        .tab-btn:hover { background-color: #1e293b; color: white; }
        
        .btn-theme-project { color: #94a3b8; } .btn-theme-project:hover { color: #2563eb; border-color: #93c5fd; }
        .btn-theme-contract { color: #94a3b8; } .btn-theme-contract:hover { color: #9333ea; border-color: #d8b4fe; }
        .btn-theme-operational { color: #94a3b8; } .btn-theme-operational:hover { color: #ea580c; border-color: #fdba74; }
        .btn-theme-portaria { color: #94a3b8; } .btn-theme-portaria:hover { color: #0891b2; border-color: #67e8f9; }
        .btn-theme-indicators { color: #94a3b8; } .btn-theme-indicators:hover { color: #be185d; border-color: #fbcfe8; }
        .btn-theme-despachos { color: #94a3b8; } .btn-theme-despachos:hover { color: #0f172a; border-color: #475569; }

        /* Acordeão */
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease; }
        .accordion-row.active .accordion-content { max-height: 3000px; padding-bottom: 2rem; }
        .accordion-row.active .chevron-icon { transform: rotate(180deg); }

        /* PMG Styles */
        .pmg-column { min-height: 200px; background-color: #f8fafc; border-radius: 1rem; padding: 1rem; border: 1px solid #e2e8f0; }
        .pmg-header { font-size: 13px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 3px solid; display: flex; justify-content: space-between; align-items: center; }
        .pmg-g { border-color: #ef4444; color: #b91c1c; }
        .pmg-m { border-color: #f59e0b; color: #b45309; }
        .pmg-p { border-color: #3b82f6; color: #1d4ed8; }
        
        .pmg-tag { font-size: 11px; font-weight: 900; padding: 2px 8px; border-radius: 6px; border: 1px solid; }
        .tag-g { background-color: #fef2f2; color: #ef4444; border-color: #fecaca; }
        .tag-m { background-color: #fffbeb; color: #f59e0b; border-color: #fde68a; }
        .tag-p { background-color: #eff6ff; color: #3b82f6; border-color: #bfdbfe; }

        /* --- ESTILOS DA PORTARIA --- */
        .portaria-card { background-color: white; border-width: 1px; border-style: solid; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: all 0.2s; position: relative; overflow: hidden; }
        .portaria-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .portaria-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        
        /* Tipos de Portaria */
        .type-diretoria { border-color: #e2e8f0; } .type-diretoria::before { background-color: #1e293b; }
        .badge-diretoria { background-color: #f1f5f9; color: #1e293b; border: 1px solid #e2e8f0; }
        
        .type-coordenadoria { border-color: #dbeafe; } .type-coordenadoria::before { background-color: #3b82f6; }
        .badge-coordenadoria { background-color: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
        
        .type-divisao { border-color: #e0e7ff; } .type-divisao::before { background-color: #6366f1; }
        .badge-divisao { background-color: #eef2ff; color: #4338ca; border: 1px solid #e0e7ff; }
        
        .type-servico { border-color: #f1f5f9; } .type-servico::before { background-color: #cbd5e1; }
        .badge-servico { background-color: #f8fafc; color: #64748b; border: 1px solid #f1f5f9; }

        .portaria-badge { font-size: 11px; font-weight: 800; text-transform: uppercase; padding: 6px 10px; border-radius: 8px; letter-spacing: 0.05em; }

        /* --- BOTÕES DE FILTRO DA PORTARIA (AUMENTADOS) --- */
        .portaria-filter-btn {
            height: 42px; 
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: white;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom-width: 0;
            opacity: 0.7;
            cursor: pointer;
            width: 100%;
            filter: grayscale(80%);
            transform: scale(0.98);
        }

        .portaria-filter-btn:hover { opacity: 1; filter: grayscale(0%); transform: scale(1); }

        .portaria-filter-btn.active {
            opacity: 1;
            filter: grayscale(0%);
            transform: scale(1.02);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 2px solid white;
            outline: 2px solid currentColor;
            outline-offset: 1px;
        }

        .filter-all { background-color: #475569; color: white; }
        .filter-diretoria { background-color: #0f172a; color: white; }
        .filter-coordenadoria { background-color: #2563eb; color: white; }
        .filter-divisao { background-color: #7c3aed; color: white; }
        .filter-servico { background-color: #059669; color: white; }

        /* Calendário e Gráficos */
        .calendar-new-wrapper { background-color: white; border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); border: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; }
        .calendar-new-header { background-color: white; border-bottom: 1px solid #f1f5f9; padding: 1.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0; gap: 0.75rem; }
        .calendar-new-main { padding: 1rem; overflow-x: auto; display: flex; justify-content: center; }
        #calendarGrid { min-height: 550px; min-width: 800px; }
        
        .calendar-new-day-cell { min-height: 120px; background-color: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.5rem; transition: all 0.2s; display: flex; flex-direction: column; justify-content: space-between; overflow: hidden; position: relative; cursor: default; }
        .calendar-new-day-cell:hover { border-color: #60a5fa; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .calendar-day-active { background-color: #eff6ff !important; border-color: #3b82f6 !important; box-shadow: inset 0 0 0 1px #3b82f6; }
        .calendar-new-day-empty { min-height: 120px; background-color: #f8fafc; border: 1px solid transparent; border-radius: 0.5rem; }

        .chart-pie { width: 100px; height: 100px; border-radius: 50%; transition: all 0.5s ease; }
        
        .stat-card { cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; min-height: 90px; display: flex; flex-direction: column; justify-content: center; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        .stat-card.active-filter { box-shadow: 0 0 0 3px #60a5fa; border-color: transparent; background-color: #eff6ff; transform: scale(1.02); z-index: 10; }
        .operational-theme .stat-card.active-filter { box-shadow: 0 0 0 3px #fb923c; background-color: #fff7ed; }
        .contracts-theme .stat-card.active-filter { box-shadow: 0 0 0 3px #c084fc; background-color: #faf5ff; }
        .portaria-theme .stat-card.active-filter { box-shadow: 0 0 0 3px #22d3ee; background-color: #ecfeff; }

        .coord-btn { transition: all 0.3s ease; border: 1px solid transparent; opacity: 1; }
        .coord-btn.active-coord { background-color: #2563eb !important; color: white !important; border-color: #60a5fa !important; box-shadow: 0 10px 15px -3px rgba(30, 58, 138, 0.5) !important; transform: scale(1.1); opacity: 1 !important; z-index: 10; }
        #coordBtnContainer.coord-list-active .coord-btn:not(.active-coord) { opacity: 0.4; filter: grayscale(100%); transform: scale(0.95); }
        #coordBtnContainer.coord-list-active .coord-btn:not(.active-coord):hover { opacity: 1; filter: grayscale(0%); background-color: #1e293b; color: #cbd5e1; transform: scale(1); }
        
        /* Legenda como Botões */
        .chart-legend-item { cursor: pointer; transition: all 0.2s; padding: 0.25rem 0.5rem; border-radius: 0.5rem; opacity: 0.5; filter: grayscale(100%); border: 1px solid transparent; }
        .chart-legend-item:hover { opacity: 0.8; background-color: #f1f5f9; filter: grayscale(0); border-color: #cbd5e1; }
        .chart-legend-item.active-legend { background-color: #eff6ff; border-color: #bfdbfe; font-weight: 900; opacity: 1; filter: grayscale(0); transform: scale(1.02); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .chart-legend-container:not(.has-filter) .chart-legend-item { opacity: 1; filter: grayscale(0); }

        .responsive-stats-grid { display: grid; gap: 1rem; grid-template-columns: repeat(2, 1fr); }
        @media (min-width: 640px) { .responsive-stats-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1280px) { .responsive-stats-grid { grid-template-columns: repeat(5, 1fr); } }

        /* Estilo Indicadores */
        .indicator-card { background: white; border: 1px solid #fbcfe8; border-radius: 1rem; padding: 1.5rem; transition: all 0.2s; position: relative; overflow: hidden; }
        .indicator-card:hover { box-shadow: 0 10px 15px -3px rgba(190, 24, 93, 0.1), 0 4px 6px -4px rgba(190, 24, 93, 0.1); border-color: #f9a8d4; transform: translateY(-2px); cursor: pointer; }
        .indicator-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #be185d; }
        .month-cell { background: #fdf2f8; border: 1px solid #fbcfe8; border-radius: 0.375rem; padding: 0.25rem; text-align: center; }
        .month-label { font-size: 10px; font-weight: 900; color: #9d174d; text-transform: uppercase; margin-bottom: 2px; }
        .month-value { font-size: 13px; font-bold; color: #831843; }
        .progress-bg { background: #fce7f3; border-radius: 999px; height: 8px; width: 100%; overflow: hidden; margin-top: 0.5rem; }
        .progress-fill { background: #db2777; height: 100%; border-radius: 999px; transition: width 0.5s ease-out; }
        
        /* Novo estilo para anos do PPA */
        .ppa-year-box { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.5rem; text-align: center; }
        .ppa-year-box.current { background-color: #fdf2f8; border-color: #fbcfe8; box-shadow: 0 0 0 1px #fbcfe8; }
        .ppa-year-label { font-size: 11px; font-black; color: #64748b; text-transform: uppercase; margin-bottom: 2px; }
        .ppa-year-box.current .ppa-year-label { color: #be185d; }
        .ppa-year-value { font-size: 14px; font-bold; color: #334155; }
        .ppa-year-box.current .ppa-year-value { color: #be185d; }
        .ppa-subtext { font-size: 10px; color: #94a3b8; margin-top: 2px; font-weight: 500; }

        /* Botão Despacho no Card */
        .btn-dispatch { 
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; 
            border-radius: 10px; transition: all 0.2s; background: #f1f5f9; color: #94a3b8; font-size: 1.1rem;
        }
        .btn-dispatch:hover { background: #e2e8f0; color: #475569; }
        .btn-dispatch.active-dispatch { background: #0f172a; color: #f8fafc; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-dispatch.active-dispatch:hover { background: #1e293b; }


        /* Botão Planner no Card (Acompanhamento Presidência) */
        .btn-planner { 
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; 
            border-radius: 10px; transition: all 0.2s; background: #f1f5f9; color: #94a3b8; font-size: 1.05rem;
        }
        .btn-planner:hover { background: #e2e8f0; color: #475569; }
        .btn-planner.active-planner { background: #2563eb; color: #f8fafc; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-planner.active-planner:hover { background: #1d4ed8; }

        /* Estilos da Nova View de Despachos */
        .meeting-card { cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .meeting-card:hover { background-color: #f1f5f9; border-color: #e2e8f0; }
        .meeting-card.active { background-color: #eff6ff; border-color: #bfdbfe; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .meeting-card.active .meeting-date-box { background-color: #3b82f6; color: white; border-color: #2563eb; }
        
        .meeting-date-box { background-color: #f8fafc; border: 1px solid #e2e8f0; color: #64748b; }
        
        .dispatch-item-row { transition: all 0.2s; }
        .dispatch-item-row:hover { background-color: #f8fafc; }
        .dispatch-checkbox:checked + div { background-color: #eff6ff; border-color: #3b82f6; }

        /* --- ESTILOS DO GANTT (NOVO) --- */
        .gantt-wrapper { overflow-x: auto; position: relative; border: 1px solid #e2e8f0; border-radius: 1rem; background: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .gantt-header { display: flex; min-width: 1450px; border-bottom: 2px solid #e2e8f0; background: #f8fafc; position: sticky; top: 0; z-index: 30; }
        .gantt-header-spacer { position: sticky; left: 0; min-width: 250px; width: 250px; background: #f8fafc; border-right: 2px solid #e2e8f0; z-index: 35; padding: 1rem; display: flex; align-items: center; font-weight: 900; color: #475569; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; }
        .gantt-header-months { flex: 1; display: flex; }
        .gantt-month-cell { flex: 1; padding: 1rem 0.5rem; text-align: center; font-weight: 800; font-size: 10px; text-transform: uppercase; color: #64748b; border-right: 1px dashed #cbd5e1; min-width: 100px; display: flex; flex-col; justify-content: center; }
        
        .gantt-body { min-width: 1450px; position: relative; }
        .gantt-row { display: flex; border-bottom: 1px solid #f1f5f9; min-height: 64px; position: relative; transition: background 0.1s; }
        .gantt-row:hover { background-color: #f8fafc; }
        
        .gantt-item-col { position: sticky; left: 0; min-width: 250px; width: 250px; background: white; z-index: 20; border-right: 2px solid #e2e8f0; padding: 0.75rem 1rem; display: flex; flex-direction: column; justify-content: center; box-shadow: 2px 0 5px rgba(0,0,0,0.02); transition: background 0.1s; }
        .gantt-row:hover .gantt-item-col { background-color: #f8fafc; }
        
        .gantt-timeline-area { flex: 1; position: relative; display: flex; }
        .gantt-grid-col { flex: 1; border-right: 1px dashed #f1f5f9; min-width: 100px; }
        
        .gantt-bar { position: absolute; top: 50%; transform: translateY(-50%); height: 20px; border-radius: 6px; z-index: 10; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer; min-width: 4px; overflow: hidden; }
        .gantt-bar:hover { transform: translateY(-50%) scaleY(1.15); z-index: 15; box-shadow: 0 4px 6px rgba(0,0,0,0.15); filter: brightness(1.05); }
        .gantt-bar-label { font-size: 9px; font-weight: 800; color: rgba(255,255,255,0.9); margin-left: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 4px; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        
        /* ESTILO DOS MARCOS COM POP-UP (Alterado) */
        .gantt-milestone-wrapper { 
            position: absolute; 
            top: 50%; 
            transform: translate(-50%, -50%); 
            z-index: 20; 
            width: 14px; 
            height: 14px; 
            cursor: pointer; 
        }

        .gantt-milestone-diamond {
            width: 100%;
            height: 100%;
            transform: rotate(45deg);
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            border-radius: 2px;
            transition: all 0.2s;
        }

        .gantt-milestone-wrapper:hover .gantt-milestone-diamond {
            transform: rotate(45deg) scale(1.3);
            z-index: 25;
            border-color: #f1f5f9;
        }

        .gantt-milestone-tooltip {
            position: absolute;
            bottom: 140%;
            left: 50%;
            transform: translateX(-50%) scale(0.95);
            background: #0f172a;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
            min-width: 120px;
            text-align: center;
        }

        .gantt-milestone-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #0f172a transparent transparent transparent;
        }

        .gantt-milestone-wrapper:hover .gantt-milestone-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) scale(1);
            bottom: 160%;
        }
        
        .gantt-today-line { position: absolute; top: 0; bottom: 0; width: 2px; background: #ef4444; z-index: 5; opacity: 0.6; pointer-events: none; border-right: 1px dashed #fecaca; }
        .gantt-today-label { position: absolute; top: -20px; transform: translateX(-50%); background: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-bold; z-index: 30; white-space: nowrap; }

        .btn-theme-gantt { color: #94a3b8; } .btn-theme-gantt:hover { color: #059669; border-color: #6ee7b7; }
    
        .clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
        .title-fixed{min-height:2.6em;}
        .card-top-actions{margin-top:2px;}
</style>
</head>
<body id="mainBody" class="bg-slate-50 text-slate-900 text-sm overflow-hidden">
    <!-- ... (Modais e Sidebar iguais, sem alterações) ... -->
    <!-- Modal Novo Indicador -->
    <div id="newIndicatorModal" class="items-center justify-center p-2 sm:p-4" style="display: none;">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden border border-slate-200 flex flex-col max-h-[90vh]">
            <div class="bg-gradient-to-r from-pink-600 to-rose-500 px-6 py-4 flex justify-between items-center text-white shrink-0">
                <div class="flex items-center gap-3">
                    <i class="fas fa-plus-circle text-lg"></i>
                    <h3 class="font-black uppercase tracking-tight">Novo Indicador</h3>
                </div>
                <button onclick="toggleModal('newIndicatorModal')" class="hover:text-pink-200 transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 flex-1 overflow-y-auto">
                <form id="newIndicatorForm" class="space-y-4">
                    <div class="flex flex-col">
                        <label class="field-label">Nome do Indicador</label>
                        <input type="text" id="newIndName" class="input-style" required placeholder="Ex: Taxa de Eficiência...">
                    </div>
                    <div class="flex flex-col">
                        <label class="field-label">Produto / Categoria</label>
                        <input type="text" id="newIndProduct" class="input-style" placeholder="Ex: Capacitação, Gestão...">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col">
                            <label class="field-label">Meta 2026</label>
                            <input type="number" step="0.01" id="newIndMeta" class="input-style" required placeholder="0.00">
                        </div>
                        <div class="flex flex-col">
                            <label class="field-label">Unidade</label>
                            <input type="text" id="newIndUnit" class="input-style" placeholder="%, un, dias...">
                        </div>
                    </div>

                    <!-- PPA SIMPLIFICADO -->
                    <div id="newIndPpaSimpleWrapper" class="mt-2 p-4 bg-slate-50 rounded-xl border border-slate-100">
                        <h5 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-3 border-b border-slate-200 pb-2">
                            Indicador – PPA 2024 a 2027
                        </h5>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="field-label">Meta 2024</label>
                                <input type="number" id="newIndMeta2024" class="input-style" placeholder="0">
                            </div>
                            <div>
                                <label class="field-label">Alcançado 2024</label>
                                <input type="number" id="newIndReal2024" class="input-style" placeholder="0">
                            </div>
                            <div>
                                <label class="field-label">Meta 2025</label>
                                <input type="number" id="newIndMeta2025" class="input-style" placeholder="0">
                            </div>
                            <div>
                                <label class="field-label">Alcançado 2025</label>
                                <input type="number" id="newIndReal2025" class="input-style" placeholder="0">
                            </div>
                            <div>
                                <label class="field-label">Meta 2026</label>
                                <input type="number" id="newIndMeta2026" class="input-style" placeholder="0">
                            </div>
                            <div class="text-xs text-slate-500 flex items-center">
                                Acompanhamento 2026 será feito mensalmente
                            </div>
                            <div>
                                <label class="field-label">Meta 2027</label>
                                <input type="number" id="newIndMeta2027" class="input-style" placeholder="0">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col">
                            <label class="field-label">Tipo</label>
                            <select id="newIndType" class="input-style">
                                <option value="ppa">Estratégico (PPA)</option>
                                <option value="other">Outros (Gerencial)</option>
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label class="field-label">Regra de Cálculo</label>
                            <select id="newIndRule" class="input-style">
                                <option value="Soma">Soma (Acumulado)</option>
                                <option value="Último valor">Último Valor (Status)</option>
                            </select>
                        </div>
                    </div>
                    
                    

                    <details class="bg-slate-50 border border-slate-100 rounded-2xl p-4">
                        <summary class="cursor-pointer select-none flex items-center justify-between text-xs font-black text-slate-600 uppercase tracking-widest">
                            <span><i class="fas fa-sliders-h mr-2 text-slate-400"></i>Acompanhamento inicial (opcional)</span>
                            <span class="text-[10px] text-slate-400 font-bold normal-case tracking-normal">(clique para abrir)</span>
                        </summary>
                        <div class="pt-4 space-y-6">
                            <div id="newIndPpaOptionalWrapper">
                                <h5 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-3 border-b border-slate-100 pb-2">PPA (opcional)</h5>
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="flex flex-col">
                                        <label class="field-label">Meta PPA 2025</label>
                                        <input type="number" step="0.01" id="newIndPpa2025" class="input-style" placeholder="0.00">
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="field-label">Meta PPA 2026</label>
                                        <input type="number" step="0.01" id="newIndPpa2026" class="input-style" placeholder="0.00">
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="field-label">Realizado PPA 2025</label>
                                        <input type="number" step="0.01" id="newIndPpaReal2025" class="input-style" placeholder="0.00">
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h5 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-3 border-b border-slate-100 pb-2">Lançamento mensal 2025 (histórico)</h5>
                                <div class="grid grid-cols-3 sm:grid-cols-4 gap-4" id="newIndMonthsGrid2025"></div>
                            </div>

                            <div>
                                <h5 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-3 border-b border-slate-100 pb-2">Lançamento mensal 2026 (realizado)</h5>
                                <div class="grid grid-cols-3 sm:grid-cols-4 gap-4" id="newIndMonthsGrid2026"></div>
                            </div>
                        </div>
                    </details>
<div class="flex justify-end pt-4">
                        <button id="btnCreateIndicator" type="button" onclick="createIndicator()" class="bg-pink-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-pink-200 hover:bg-pink-700 transition-all uppercase text-xs tracking-widest flex items-center gap-2">
                            <i class="fas fa-save"></i> Criar Indicador
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nova Pauta/Reunião -->
    <div id="meetingModal" class="items-center justify-center p-2 sm:p-4" style="display: none;">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden border border-slate-200 flex flex-col">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-slate-800 text-white rounded-lg flex items-center justify-center shadow-lg">
                        <i class="fas fa-calendar-plus text-lg"></i>
                    </div>
                    <div><h3 class="font-black text-slate-800 uppercase tracking-tight text-base">Nova Pauta de Despacho</h3></div>
                </div>
                <button onclick="toggleModal('meetingModal')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:text-red-500 transition-all flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <form id="meetingForm" class="space-y-5">
                    <div class="flex flex-col">
                        <label class="field-label">Nome da Pauta (Opcional)</label>
                        <input type="text" id="newMeetingTitle" class="input-style" placeholder="Ex: Reunião Semanal, Pauta Extra...">
                    </div>
                    <div class="flex flex-col">
                        <label class="field-label">Data da Reunião</label>
                        <input type="date" id="newMeetingDate" class="input-style" required>
                    </div>
                    <div class="flex flex-col">
                        <label class="field-label">Participantes</label>
                        <textarea id="newMeetingAttendees" rows="2" class="input-style resize-none" placeholder="Ex: Diretor Presidente, Chefe de Gabinete..."></textarea>
                    </div>
                    
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <div class="flex justify-between items-center mb-2">
                            <label class="field-label mb-0">Itens Selecionados do Backlog</label>
                            <span id="selectedCountBadge" class="bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                        </div>
                        <p class="text-xs text-slate-500 italic">Os itens selecionados na tela anterior serão incluídos nesta pauta.</p>
                    </div>

                    <div class="flex justify-end pt-2">
                        <button type="button" onclick="createNewMeeting()" class="bg-slate-800 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-slate-900 transition-all uppercase text-xs tracking-widest flex items-center gap-2">
                            <i class="fas fa-check"></i> Criar Pauta
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Editar Pauta -->
    <div id="editMeetingModal" class="items-center justify-center p-2 sm:p-4" style="display: none;">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden border border-slate-200 flex flex-col">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-slate-700 text-white rounded-lg flex items-center justify-center shadow-lg">
                        <i class="fas fa-edit text-lg"></i>
                    </div>
                    <div><h3 class="font-black text-slate-800 uppercase tracking-tight text-base">Editar Pauta</h3></div>
                </div>
                <button onclick="toggleModal('editMeetingModal')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:text-red-500 transition-all flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <form id="editMeetingForm" class="space-y-5">
                    <input type="hidden" id="editMeetingId">
                    <div class="flex flex-col">
                        <label class="field-label">Nome da Pauta</label>
                        <input type="text" id="editMeetingTitle" class="input-style" placeholder="Ex: Reunião Semanal...">
                    </div>
                    <div class="flex flex-col">
                        <label class="field-label">Data da Reunião</label>
                        <input type="date" id="editMeetingDate" class="input-style" required>
                    </div>
                    <div class="flex flex-col">
                        <label class="field-label">Participantes</label>
                        <textarea id="editMeetingAttendees" rows="3" class="input-style resize-none"></textarea>
                    </div>
                    
                    <div class="flex justify-end pt-2 gap-3">
                        <button type="button" onclick="toggleModal('editMeetingModal')" class="bg-slate-100 text-slate-500 font-bold py-3 px-6 rounded-xl hover:bg-slate-200 transition-all uppercase text-xs tracking-widest">Cancelar</button>
                        <button type="button" onclick="saveMeetingEdit()" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:bg-blue-700 transition-all uppercase text-xs tracking-widest flex items-center gap-2">
                            <i class="fas fa-save"></i> Salvar Alterações
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Itens do Backlog (NOVO) -->
    <div id="addBacklogItemModal" class="items-center justify-center p-2 sm:p-4" style="display: none;">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden border border-slate-200 flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-indigo-600 text-white rounded-lg flex items-center justify-center shadow-lg shadow-indigo-100">
                        <i class="fas fa-list-ul text-lg"></i>
                    </div>
                    <div>
                        <h3 class="font-black text-slate-800 uppercase tracking-tight text-base">Adicionar Itens</h3>
                        <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Selecione para incluir na pauta</p>
                    </div>
                </div>
                <button onclick="toggleModal('addBacklogItemModal')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:text-red-500 transition-all flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto bg-slate-50/50 p-4 sm:p-6">
                <div id="backlogItemsListForModal" class="space-y-3">
                    <!-- Itens serão injetados aqui via JS -->
                </div>
                
                <div id="emptyBacklogMsg" class="hidden text-center py-10 flex flex-col items-center opacity-60">
                    <i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
                    <span class="text-slate-500 italic text-xs font-bold uppercase">Todos os itens disponíveis já estão nesta pauta.</span>
                </div>
            </div>

            <div class="p-4 border-t border-slate-100 bg-white flex justify-end gap-3 shrink-0">
                <button onclick="toggleModal('addBacklogItemModal')" class="px-6 py-3 rounded-xl text-slate-500 font-bold text-xs uppercase hover:bg-slate-100 transition-colors">Cancelar</button>
                <button onclick="addSelectedBacklogItems()" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all uppercase text-xs tracking-widest flex items-center gap-2">
                    <i class="fas fa-plus"></i> Adicionar Selecionados
                </button>
            </div>
        </div>
    </div>

    <!-- Modal (Universal Project) -->
    <div id="projectModal" class="items-center justify-center p-2 sm:p-4" style="display: none;">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl overflow-hidden border border-slate-200 flex flex-col max-h-[95vh] sm:max-h-[90vh]">
            <div class="px-4 sm:px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                <div class="flex items-center space-x-3">
                    <div id="modalIcon" class="w-10 h-10 bg-blue-600 text-white rounded-lg flex items-center justify-center shadow-lg shadow-blue-100 transition-colors">
                        <i id="modalIconImg" class="fas fa-project-diagram text-lg"></i>
                    </div>
                    <div>
                        <h3 id="modalTitle" class="font-black text-slate-800 uppercase tracking-tight text-sm sm:text-base">Novo Registro</h3>
                    </div>
                </div>
                <button onclick="toggleModal('projectModal')" class="w-10 h-10 rounded-full bg-slate-50 text-slate-400 hover:text-red-500 transition-all flex items-center justify-center">
                    <i class="fas fa-times text-base"></i>
                </button>
            </div>
            <div class="modal-container flex-1 overflow-y-auto">
                <form id="projectForm" class="p-4 md:p-8">
                    <input type="hidden" id="editId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-10">
                        <!-- Identificação -->
                        <div class="space-y-8">
                            <div class="bg-slate-50 p-4 sm:p-6 rounded-3xl border border-slate-100 space-y-5">
                                <h4 class="form-section-title"><strong>01. Identificação</strong></h4>
                                <div id="contractTypeField" class="flex flex-col hidden-field">
                                    <label class="field-label">Tipo de Objeto</label>
                                    <select id="projType" class="input-style">
                                        <option value="Contrato">Contrato</option>
                                        <option value="Acordo de Cooperação Técnica">Acordo de Cooperação Técnica</option>
                                        <option value="Convênio">Convênio</option>
                                    </select>
                                </div>
                                <div id="contractProgramField" class="flex flex-col hidden-field">
                                    <label class="field-label">Programa</label>
                                    <select id="contractProgram" class="input-style" onchange="toggleContractProgramFields()">
                                        <option value="">(Nenhum)</option>
                                        <option value="Respeito à Vida">Respeito à Vida</option>
                                    </select>
                                </div>
                                <div id="contractComponentField" class="flex flex-col hidden-field">
                                    <label class="field-label">Componente (Repasse)</label>
                                    <select id="contractComponent" class="input-style">
                                        <option value="">Selecione...</option>
                                        <option value="1">Componente 1</option>
                                        <option value="3">Componente 3</option>
                                    </select>
                                </div>
                                <div class="flex flex-col">
                                    <label id="labelName"  class="field-label">Nome do Registro</label>
                                    <input type="text" id="projName" required class="input-style">
                                </div>
                                <div class="flex flex-col">
                                    <label class="field-label">Descrição / Escopo</label>
                                    <textarea id="projDesc" rows="3" class="input-style resize-none"></textarea>
                                </div>
                                <!-- NOVO CAMPO: Complexidade PMG (Apenas Projetos) -->
                                <div id="complexityField" class="flex flex-col hidden-field animate-fade-in">
                                    <label class="field-label text-blue-800">Complexidade (Matriz PMG)</label>
                                    <select id="projComplexity" class="input-style border-blue-200 focus:ring-blue-200">
                                        <option value="Baixa">P - Baixa Complexidade (Rotina)</option>
                                        <option value="Média" selected>M - Média Complexidade (Tático)</option>
                                        <option value="Alta">G - Alta Complexidade (Estratégico)</option>
                                    </select>
                                </div>
                                <div class="flex flex-col">
                                    <label class="field-label">Observações Gerais</label>
                                    <textarea id="projObs" rows="3" class="input-style resize-none" placeholder="Informações adicionais..."></textarea>
                                </div>
                                <div id="contractRelationWrapper" class="flex flex-col hidden-field space-y-3 pt-3 border-t border-slate-100">
                                    <label class="field-label">Relação com Projeto?</label>
                                    <div class="radio-group flex-col sm:flex-row">
                                        <label class="radio-option"><input type="radio" name="contractRelType" value="nao" checked onclick="toggleContractRelInput()"> Não</label>
                                        <label class="radio-option"><input type="radio" name="contractRelType" value="sim" onclick="toggleContractRelInput()"> Sim</label>
                                    </div>
                                </div>
                                <div id="projectSelectWrapper" class="hidden-field animate-fade-in">
                                    <label class="field-label">Qual projeto?</label>
                                    <select id="projRelation" class="input-style"></select>
                                </div>
                                <div id="resourceLogicField" class="hidden-field space-y-3 pt-3 border-t border-slate-100">
                                    <div class="flex flex-col"><label class="field-label">Repasse de recurso?</label><select id="projHasResource" class="input-style" onchange="toggleResourceInput()"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                    <div id="resourceValueField" class="flex flex-col hidden-field"><label class="field-label">Valor (R$)</label><input type="text" id="projResourceValue" class="input-style text-emerald-600 font-bold" placeholder="0,00" oninput="this.value = this.value.replace(/[^0-9,.]/g, '')"></div>
                                </div>
                                <div id="relationalField" class="flex flex-col hidden-field space-y-3">
                                    <label class="field-label">Origem da Demanda</label>
                                    <div class="radio-group flex-col sm:flex-row">
                                        <label class="radio-option"><input type="radio" name="originType" value="pontual" checked onclick="toggleOriginInput()"> Pontual / Rotina</label>
                                        <label class="radio-option"><input type="radio" name="originType" value="projeto" onclick="toggleOriginInput()"> Projeto</label>
                                        <label class="radio-option"><input type="radio" name="originType" value="contrato" onclick="toggleOriginInput()"> Contrato</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Processos -->
                        <div class="space-y-8">
                            <div class="bg-slate-50 p-4 sm:p-6 rounded-3xl border border-slate-100 space-y-5">
                                <h4 class="form-section-title"><strong>02. Processos e Prazos</strong></h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                                    <div id="priorityField" class="flex flex-col">
                                        <label class="field-label">Prioridade</label>
                                        <select id="projPriority" class="input-style"><option value="Urgente">Urgente</option><option value="Alta">Alta</option><option value="Média" selected>Média</option><option value="Baixa">Baixa</option></select>
                                    </div>
                                    <div class="flex flex-col" id="seiField">
                                        <label class="field-label">Processo SEI</label>
                                        <input type="text" id="projSei" class="input-style">
                                    </div>
                                    <div class="flex flex-col">
                                        <label id="labelPrazo" class="field-label">Prazo Final</label>
                                        <input type="date" id="projPrazo" class="input-style">
                                    </div>
                                    <!-- NOVO CAMPO: DURAÇÃO (DIAS) -->
                                    <div class="flex flex-col hidden-field" id="operationalDurationField">
                                        <label class="field-label">Duração (Dias)</label>
                                        <input type="number" id="projDuration" class="input-style" placeholder="Ex: 5" min="0">
                                    </div>
                                </div>
                                <div class="flex flex-col" id="docsField">
                                    <div class="flex items-center justify-between">
                                        <label class="field-label mb-0">Links de Documentos</label>
                                        <button type="button" onclick="addDocLinkRow('')" class="text-[10px] font-black uppercase tracking-wider text-blue-600 hover:text-blue-800 flex items-center gap-1">
                                            <i class="fas fa-plus"></i> Adicionar
                                        </button>
                                    </div>
                                    <div id="projDocsContainer" class="space-y-2"></div>
                                    <p class="text-[11px] text-slate-400 font-medium mt-1">Cole URLs (SharePoint/Drive/SEI etc.).</p>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-4 sm:p-6 rounded-3xl border border-slate-100 space-y-5">
                                <h4 class="form-section-title"><strong>03. Acompanhamento</strong></h4>
                                <div class="grid grid-cols-1 gap-5">
                                    <div class="flex flex-col">
                                        <!-- Rótulo alterado de 'Coordenação' para 'Responsável' -->
                                        <label class="field-label">Responsável</label>
                                        <select id="projCoord" class="input-style">
                                            <option value="DSV">DSV</option>
                                            <option value="EPT">EPT</option>
                                            <option value="CEC">CEC</option>
                                            <option value="CET">CET</option>
                                            <option value="CGSV">CGSV</option>
                                            <option value="COST">COST</option>
                                            <option value="CIST">CIST</option>
                                        </select>
                                    </div>
                                    
                                    <!-- CAMPO SERVIÇO ATUALIZADO PARA MULTI-SELECT (TAGS) -->
                                    <div id="serviceField" class="flex flex-col hidden-field">
                                        <label class="field-label">Serviços Envolvidos</label>
                                        <div id="serviceTagsContainer" class="tag-container bg-white mb-2 min-h-[44px] flex-wrap gap-2"></div>
                                        <select id="projServiceAdder" class="input-style" onchange="addServiceTag(this.value); this.value='';">
                                            <option value="">+ Adicionar Serviço...</option>
                                            <option value="SCCE">SCCE</option><option value="SDCG">SDCG</option><option value="SFP">SFP</option><option value="SIEDU">SIEDU</option><option value="SOPED">SOPED</option><option value="SETEF">SETEF</option><option value="SDMP">SDMP</option><option value="SDAP">SDAP</option><option value="SAST">SAST</option><option value="RENAEST">RENAEST</option><option value="SESV">SESV</option><option value="SMO">SMO</option><option value="SEP">SEP</option><option value="STSV">STSV</option><option value="SISV">SISV</option><option value="SIM">SIM</option><option value="SGR">SGR</option><option value="SAT">SAT</option><option value="SENT">SENT</option><option value="SFI">SFI</option>
                                        </select>
                                    </div>

                                    <div class="flex flex-col">
                                        <label class="field-label">Status</label>
                                        <select id="projStatus" class="input-style" onchange="toggleRiskInput()"></select>
                                    </div>
                                    <!-- NOVO CAMPO DE RISCOS -->
                                    <div id="riskField" class="flex flex-col hidden-field animate-fade-in">
                                        <label class="field-label text-red-600"><i class="fas fa-exclamation-triangle mr-1"></i> Riscos e Pontos de Atenção</label>
                                        <textarea id="projRisks" rows="3" class="input-style resize-none border-red-200 bg-red-50 focus:ring-red-200 placeholder-red-300 text-red-900" placeholder="Descreva os riscos, impedimentos ou motivos do atraso..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SEÇÃO 04: ROADMAP -->
                    <div id="roadmapSection" class="mt-6 bg-slate-50 p-4 sm:p-6 rounded-3xl border border-slate-100 space-y-5">
                        <div class="flex justify-between items-center border-b border-slate-200 pb-3">
                            <h4 class="form-section-title !mb-0 !border-0 !pb-0"><strong>04. Roadmap</strong></h4>
                            <button type="button" onclick="addRoadmapRow()" id="addRoadmapBtn" class="text-[10px] font-black bg-blue-600 text-white px-4 py-2 rounded-xl shadow-md uppercase transition-colors hover:bg-blue-700 hover:shadow-lg transform hover:-translate-y-0.5">+ Nova Etapa</button>
                        </div>
                        <div id="roadmapContainer" class="space-y-3"></div>
                    </div>

                    <!-- SEÇÃO 05: MATRIZ RASCI -->
                    <div class="mt-6 bg-slate-50 p-4 sm:p-6 rounded-3xl border border-slate-100">
                        <div class="flex items-center gap-3 border-b border-slate-200 pb-3 mb-5">
                            <h4 class="form-section-title !mb-0 !border-0 !pb-0"><strong>05. Matriz RASCI</strong></h4>
                            <!-- Botão Estilo PMG (Azul) -->
                            <button type="button" onclick="toggleModal('rasciLegendModal')" class="bg-blue-50 text-blue-600 hover:bg-blue-100 text-[11px] font-bold uppercase px-3 py-1.5 rounded-lg transition-colors border border-blue-200 flex items-center gap-1">
                                <i class="fas fa-info-circle mr-1"></i> O que é?
                            </button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                            <!-- R - Responsável -->
                            <div class="flex flex-col">
                                <label class="field-label text-blue-600" title="Responsável pela execução">R - Responsável</label>
                                <div class="tag-container bg-white" id="rasciContainerR">
                                    <input type="text" id="rasciInputR" class="bg-transparent outline-none text-xs font-normal flex-1 min-w-[50px] placeholder-slate-400" placeholder="Insira o ator + Enter">
                                </div>
                            </div>
                            <!-- A - Aprovador -->
                            <div class="flex flex-col">
                                <label class="field-label text-red-600" title="Quem aprova e responde">A - Aprovador</label>
                                <div class="tag-container bg-white" id="rasciContainerA">
                                    <input type="text" id="rasciInputA" class="bg-transparent outline-none text-xs font-normal flex-1 min-w-[50px] placeholder-slate-400" placeholder="Insira o ator + Enter">
                                </div>
                            </div>
                            <!-- S - Suporte -->
                            <div class="flex flex-col">
                                <label class="field-label text-orange-600" title="Quem dá suporte/apoio">S - Suporte</label>
                                <div class="tag-container bg-white" id="rasciContainerS">
                                    <input type="text" id="rasciInputS" class="bg-transparent outline-none text-xs font-normal flex-1 min-w-[50px] placeholder-slate-400" placeholder="Insira o ator + Enter">
                                </div>
                            </div>
                            <!-- C - Consultado -->
                            <div class="flex flex-col">
                                <label class="field-label text-purple-600" title="Quem deve ser consultado">C - Consultado</label>
                                <div class="tag-container bg-white" id="rasciContainerC">
                                    <input type="text" id="rasciInputC" class="bg-transparent outline-none text-xs font-normal flex-1 min-w-[50px] placeholder-slate-400" placeholder="Insira o ator + Enter">
                                </div>
                            </div>
                            <!-- I - Informado -->
                            <div class="flex flex-col">
                                <label class="field-label text-emerald-600" title="Quem deve ser informado">I - Informado</label>
                                <div class="tag-container bg-white" id="rasciContainerI">
                                    <input type="text" id="rasciInputI" class="bg-transparent outline-none text-xs font-normal flex-1 min-w-[50px] placeholder-slate-400" placeholder="Insira o ator + Enter">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-12 flex gap-4 pb-8">
                        <button type="button" id="deleteBtn" onclick="deleteProject()" class="bg-red-50 text-red-600 font-bold px-6 rounded-2xl shadow-sm hover:bg-red-100 transition-all uppercase text-xs tracking-widest hidden"><i class="fas fa-trash mr-2"></i> Excluir</button>
                        <button type="button" id="saveBtn" onclick="saveProject()" class="flex-1 bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-xl hover:bg-blue-700 transition-all uppercase text-xs tracking-[0.2em]">Gravar Dados</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ... (Demais Modais, como RASCI Legend, PMG, Indicator, etc, permanecem iguais) ... -->
     <!-- Modal Legenda RASCI (NOVO) -->
    <div id="rasciLegendModal" class="items-center justify-center p-4" style="display: none;" onclick="if(event.target === this) toggleModal('rasciLegendModal')">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6 border border-slate-200 overflow-y-auto max-h-[90vh]">
            <h3 class="text-lg font-black text-slate-800 uppercase tracking-tight mb-4 flex items-center gap-2"><i class="fas fa-users-cog text-indigo-600"></i> Matriz de Responsabilidades (RASCI)</h3>
            <div class="space-y-3">
                <div class="flex gap-4 p-3 bg-blue-50 rounded-xl border border-blue-100 items-start">
                    <div class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center font-black shrink-0 text-lg">R</div>
                    <div>
                        <h4 class="font-bold text-blue-800 text-sm uppercase">Responsável (Responsible)</h4>
                        <p class="text-xs text-blue-700 mt-1">Quem efetivamente trabalha na tarefa. É o "executor". Pode haver mais de um R, mas o ideal é manter focado.</p>
                    </div>
                </div>
                <div class="flex gap-4 p-3 bg-red-50 rounded-xl border border-red-100 items-start">
                    <div class="w-8 h-8 rounded-lg bg-red-100 text-red-600 flex items-center justify-center font-black shrink-0 text-lg">A</div>
                    <div>
                        <h4 class="font-bold text-red-800 text-sm uppercase">Aprovador (Accountable)</h4>
                        <p class="text-xs text-red-700 mt-1">Quem responde pelo resultado final. É quem tem autoridade para vetar ou aprovar. <strong>Deve haver apenas um "A" por atividade</strong>.</p>
                    </div>
                </div>
                <div class="flex gap-4 p-3 bg-orange-50 rounded-xl border border-orange-100 items-start">
                    <div class="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center font-black shrink-0 text-lg">S</div>
                    <div>
                        <h4 class="font-bold text-orange-800 text-sm uppercase">Suporte (Support)</h4>
                        <p class="text-xs text-orange-700 mt-1">Quem fornece recursos, apoio logístico ou ajuda prática ao Responsável durante a execução.</p>
                    </div>
                </div>
                <div class="flex gap-4 p-3 bg-purple-50 rounded-xl border border-purple-100 items-start">
                    <div class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center font-black shrink-0 text-lg">C</div>
                    <div>
                        <h4 class="font-bold text-purple-800 text-sm uppercase">Consultado (Consulted)</h4>
                        <p class="text-xs text-purple-700 mt-1">Especialistas ou partes interessadas que devem ser ouvidas <strong>antes</strong> da decisão ou ação. A comunicação é de via dupla.</p>
                    </div>
                </div>
                <div class="flex gap-4 p-3 bg-emerald-50 rounded-xl border border-emerald-100 items-start">
                    <div class="w-8 h-8 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center font-black shrink-0 text-lg">I</div>
                    <div>
                        <h4 class="font-bold text-emerald-800 text-sm uppercase">Informado (Informed)</h4>
                        <p class="text-xs text-emerald-700 mt-1">Quem precisa ser avisado <strong>após</strong> a decisão ou ação ter sido tomada. A comunicação é de via única (apenas notificação).</p>
                    </div>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button onclick="toggleModal('rasciLegendModal')" class="bg-slate-800 text-white font-bold py-2 px-6 rounded-lg text-xs uppercase hover:bg-slate-700">Entendido</button>
            </div>
        </div>
    </div>

    <!-- Modal Legenda PMG -->
    <div id="pmgLegendModal" class="items-center justify-center p-4" style="display: none;" onclick="if(event.target === this) toggleModal('pmgLegendModal')">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-6 border border-slate-200">
            <h3 class="text-lg font-black text-slate-800 uppercase tracking-tight mb-4 flex items-center gap-2"><i class="fas fa-layer-group text-blue-600"></i> Entenda a Matriz PMG</h3>
            <div class="space-y-4">
                <div class="flex gap-4 p-3 bg-red-50 rounded-xl border border-red-100 items-start">
                    <div class="w-8 h-8 rounded-lg bg-red-100 text-red-600 flex items-center justify-center font-black shrink-0">G</div>
                    <div>
                        <h4 class="font-bold text-red-800 text-sm">Alta Complexidade (Grande)</h4>
                        <p class="text-xs text-red-700 mt-1">Projetos estratégicos, de longo prazo, alto risco ou alto investimento. Envolvem múltiplas áreas e impacto sistêmico.</p>
                    </div>
                </div>
                <div class="flex gap-4 p-3 bg-amber-50 rounded-xl border border-amber-100 items-start">
                    <div class="w-8 h-8 rounded-lg bg-amber-100 text-amber-600 flex items-center justify-center font-black shrink-0">M</div>
                    <div>
                        <h4 class="font-bold text-amber-800 text-sm">Média Complexidade (Médio)</h4>
                        <p class="text-xs text-amber-700 mt-1">Projetos táticos, médio prazo. Mudanças importantes mas com escopo definido e risco moderado.</p>
                    </div>
                </div>
                <div class="flex gap-4 p-3 bg-blue-50 rounded-xl border border-blue-100 items-start">
                    <div class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center font-black shrink-0">P</div>
                    <div>
                        <h4 class="font-bold text-blue-800 text-sm">Baixa Complexidade (Pequeno)</h4>
                        <p class="text-xs text-blue-700 mt-1">Ações de rotina, melhorias pontuais, baixo risco e curto prazo. "Quick wins".</p>
                    </div>
                </div>
            </div>
            <div class="mt-6 text-right">
                <button onclick="toggleModal('pmgLegendModal')" class="bg-slate-800 text-white font-bold py-2 px-6 rounded-lg text-xs uppercase hover:bg-slate-700">Entendido</button>
            </div>
        </div>
    </div>

    <!-- Modal Edição Indicador -->
    <div id="indicatorModal" class="items-center justify-center p-2 sm:p-4" style="display: none;">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl overflow-hidden border border-slate-200 flex flex-col max-h-[90vh]">
            <div class="bg-gradient-to-r from-pink-600 to-rose-500 px-6 py-4 flex justify-between items-center text-white shrink-0">
                <div class="flex items-center gap-3">
                    <i class="fas fa-chart-line text-lg"></i>
                    <h3 class="font-black uppercase tracking-tight">Atualizar Indicador</h3>
                </div>
                <button onclick="toggleModal('indicatorModal')" class="hover:text-pink-200 transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <form id="indicatorForm">
                    <input type="hidden" id="indId">
                    <div class="mb-6">
                        <h4 id="indNameDisplay" class="text-xl font-black text-slate-800 leading-tight mb-1">Nome do Indicador</h4>
                        <p class="text-sm text-slate-500 font-bold uppercase tracking-wider">Meta Anual 2026: <span id="indMetaDisplay" class="text-pink-600">0</span></p>
                    </div>

                    <!-- Seção PPA Dinâmica (Preenchida via JS) -->
                    <div id="indPpaSection" class="hidden mb-8 p-4 bg-slate-50 rounded-xl border border-slate-100">
                        <h5 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-3 border-b border-slate-200 pb-2">Histórico PPA (2024-2027)</h5>
                        <div id="indPpaGrid" class="grid grid-cols-2 gap-4"></div>
                    </div>
                    
                    <!-- NOVA SEÇÃO: Lançamento Mensal 2025 -->
                    <div id="indMonths2025Wrapper" class="hidden mb-8 p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                        <h5 class="text-[11px] font-black text-indigo-400 uppercase tracking-widest mb-4 border-b border-indigo-200 pb-2">Lançamento Mensal 2025 (Histórico)</h5>
                        <div class="grid grid-cols-3 sm:grid-cols-4 gap-4" id="indMonthsGrid2025">
                            <!-- Gerado via JS -->
                        </div>
                    </div>
                    
                    <h5 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-4 border-b border-slate-100 pb-2">Lançamento Mensal 2026 (Realizado)</h5>
                    <div class="grid grid-cols-3 sm:grid-cols-4 gap-4" id="indMonthsGrid">
                        <!-- Gerado via JS -->
                    </div>
                    
                    <div class="mt-8 flex justify-between items-center gap-4">
                        <button type="button" id="btnDeleteIndicator" onclick="deleteIndicator()" class="bg-red-50 text-red-600 font-bold py-3 px-6 rounded-xl shadow-sm hover:bg-red-100 transition-all uppercase text-xs tracking-widest flex items-center"><i class="fas fa-trash mr-2"></i> Excluir</button>
                        <button type="button" onclick="saveIndicator()" class="bg-pink-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg shadow-pink-200 hover:bg-pink-700 transition-all uppercase text-xs tracking-widest">Salvar Lançamentos</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- App Shell (Sidebar, Main, etc.) -->
    <div id="appShell" class="flex flex-col md:flex-row h-dvh md:h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-full md:w-64 bg-slate-900 text-white flex flex-col shadow-xl shrink-0 z-30 h-auto md:h-full">
            <div class="p-3 md:p-5 border-b border-slate-800 flex justify-between md:block items-center">
                <div>
                    <h1 class="text-lg md:text-2xl font-bold tracking-tight uppercase">DSV <span class="text-blue-400">2026</span></h1>
                    <p class="text-[10px] md:text-[11px] text-slate-400 uppercase tracking-widest font-bold mt-1">Painel de Gestão</p>
                </div>
                <div id="sysStatus" class="md:mt-5 flex items-center gap-2 text-[10px] font-black uppercase tracking-wider py-1 md:py-2 px-2 md:px-3 rounded-lg w-auto md:w-full transition-all border border-slate-700/50 bg-slate-800">
                    <span id="sysStatusDot" class="w-2 h-2 rounded-full bg-slate-500"></span>
                    <span id="sysStatusText" class="text-slate-400 hidden sm:inline">Iniciando...</span>
                </div>
            </div>
            
            <nav class="flex-1 flex md:flex-col flex-row overflow-x-auto md:overflow-y-auto px-2 py-2 md:px-3 md:mt-3 space-x-2 md:space-x-0 md:space-y-3 bg-slate-900 scrollbar-hide shrink-0 items-center md:items-stretch">
                <div class="flex-none min-w-[140px] md:w-full">
                    <p class="text-[11px] font-normal text-slate-500 uppercase tracking-widest mb-2 px-2 hidden md:block">Visualização</p>
                    <div class="flex md:block space-x-2 md:space-x-0 md:space-y-1">
                        <button onclick="switchTab('projects')" id="tab-projects" class="tab-btn w-auto md:w-full flex items-center space-x-2 md:space-x-3 p-2 md:p-3 rounded-lg whitespace-nowrap">
                            <i class="fas fa-folder w-5 text-base md:text-lg"></i><span class="text-sm md:text-base font-medium">Projetos</span>
                        </button>
                        <button onclick="switchTab('contracts')" id="tab-contracts" class="tab-btn w-auto md:w-full flex items-center space-x-2 md:space-x-3 p-2 md:p-3 rounded-lg whitespace-nowrap">
                            <i class="fas fa-file-contract w-5 text-base md:text-lg"></i><span class="text-sm md:text-base font-medium">Contratos</span>
                        </button>
                        <button onclick="switchTab('operational')" id="tab-operational" class="tab-btn w-auto md:w-full flex items-center space-x-2 md:space-x-3 p-2 md:p-3 rounded-lg whitespace-nowrap">
                            <i class="fas fa-tasks w-5 text-base md:text-lg"></i><span class="text-sm md:text-base font-medium">Operacional</span>
                        </button>
                        <button onclick="switchTab('gantt')" id="tab-gantt" class="tab-btn w-auto md:w-full flex items-center space-x-2 md:space-x-3 p-2 md:p-3 rounded-lg whitespace-nowrap">
                            <i class="fas fa-stream w-5 text-base md:text-lg"></i><span class="text-sm md:text-base font-medium">Cronograma</span>
                        </button>
                        <button onclick="switchTab('indicators')" id="tab-indicators" class="tab-btn w-auto md:w-full flex items-center space-x-2 md:space-x-3 p-2 md:p-3 rounded-lg whitespace-nowrap">
                            <i class="fas fa-chart-line w-5 text-base md:text-lg"></i><span class="text-sm md:text-base font-medium">Indicadores</span>
                        </button>
                         <button onclick="switchTab('despachos')" id="tab-despachos" class="tab-btn w-auto md:w-full flex items-center space-x-2 md:space-x-3 p-2 md:p-3 rounded-lg whitespace-nowrap">
                            <i class="fas fa-clipboard-list w-5 text-base md:text-lg"></i><span class="text-sm md:text-base font-medium">Despachos</span>
                        </button>
                        <button onclick="switchTab('calendar')" id="tab-calendar" class="tab-btn w-auto md:w-full flex items-center space-x-2 md:space-x-3 p-2 md:p-3 rounded-lg whitespace-nowrap">
                            <i class="fas fa-calendar-alt w-5 text-base md:text-lg"></i><span class="text-sm md:text-base font-medium">Calendário</span>
                        </button>
                        <button onclick="switchTab('portaria')" id="tab-portaria" class="tab-btn w-auto md:w-full flex items-center space-x-2 md:space-x-3 p-2 md:p-3 rounded-lg whitespace-nowrap">
                            <i class="fas fa-balance-scale w-5 text-base md:text-lg"></i><span class="text-sm md:text-base font-medium">Portaria nº44/25</span>
                        </button>
                    </div>
                </div>
                
                <div class="flex-none min-w-[200px] md:w-full border-l md:border-l-0 border-slate-700 pl-2 md:pl-0 h-full md:h-auto flex items-center md:block">
                    <div class="w-full">
                        <p class="text-[11px] font-normal text-slate-500 uppercase tracking-widest mb-1 px-2 hidden md:block">Coordenações</p>
                        <div id="coordBtnContainer" class="flex md:grid md:grid-cols-2 gap-2 px-1">
                            <button id="coord-EPT" onclick="setFilter('EPT')" class="coord-btn bg-slate-800 p-2 rounded-lg text-xs font-bold text-white hover:bg-slate-700 min-w-[50px]">EPT</button>
                            <button id="coord-CEC" onclick="setFilter('CEC')" class="coord-btn bg-slate-800 p-2 rounded-lg text-xs font-bold text-white hover:bg-slate-700 min-w-[50px]">CEC</button>
                            <button id="coord-CET" onclick="setFilter('CET')" class="coord-btn bg-slate-800 p-2 rounded-lg text-xs font-bold text-white hover:bg-slate-700 min-w-[50px]">CET</button>
                            <button id="coord-CGSV" onclick="setFilter('CGSV')" class="coord-btn bg-slate-800 p-2 rounded-lg text-xs font-bold text-white hover:bg-slate-700 min-w-[50px]">CGSV</button>
                            <button id="coord-COST" onclick="setFilter('COST')" class="coord-btn bg-slate-800 p-2 rounded-lg text-xs font-bold text-white hover:bg-slate-700 min-w-[50px]">COST</button>
                            <button id="coord-CIST" onclick="setFilter('CIST')" class="coord-btn bg-slate-800 p-2 rounded-lg text-xs font-bold text-white hover:bg-slate-700 min-w-[50px]">CIST</button>
                            <button id="coord-all" onclick="setFilter('all')" class="coord-btn md:col-span-2 bg-slate-700 p-2 rounded-lg text-xs font-bold text-white text-center uppercase whitespace-nowrap hover:bg-slate-600">Limpar</button>
                        </div>
                    </div>
                </div>
            </nav>
        </aside>

        <main class="flex-1 flex flex-col overflow-y-auto overflow-x-hidden relative">
            <header class="bg-white border-b border-slate-200 px-4 md:px-6 py-4 md:py-5 flex flex-col md:flex-row justify-between items-start md:items-center shadow-sm sticky top-0 z-20 gap-3">
                <div class="flex items-center gap-3">
                    <h2 id="viewTitle" class="text-lg md:text-2xl font-black text-slate-800 uppercase tracking-tight">Portfólio de Projetos</h2>
                    <!-- Info PMG (Apenas Projetos) -->
                    <button id="pmgInfoBtn" onclick="toggleModal('pmgLegendModal')" class="hidden bg-blue-50 text-blue-600 hover:bg-blue-100 text-[11px] font-bold uppercase px-3 py-1.5 rounded-lg transition-colors border border-blue-200">
                        <i class="fas fa-info-circle mr-1"></i> Matriz PMG
                    </button>
                </div>
                <div class="relative w-full md:w-72">
                    <i class="fas fa-search absolute left-3 top-3 text-slate-300 text-sm"></i>
                    <input type="text" id="searchInput" oninput="renderData();" placeholder="Pesquisar..." class="w-full bg-slate-50 border border-slate-100 rounded-xl pl-10 pr-3 py-3 text-sm outline-none focus:ring-2 focus:ring-blue-100 transition-all font-medium">
                </div>
            </header>

            <!-- Container Principal -->
            <div id="standardView" class="flex-1 flex flex-col transition-colors duration-300 pb-20 md:pb-0">
                <div id="statsWrapper" class="px-4 md:px-6 pt-6 flex flex-col xl:flex-row gap-6">
                    <div id="statsRow1" class="flex-1 responsive-stats-grid transition-all duration-500">
                        <!-- Stats Cards -->
                        <div id="cardTotal" onclick="setListFilter('all')" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm stat-card active-filter">
                            <p class="text-[10px] text-slate-400 uppercase font-black mb-1">Total</p><div id="statTotal" class="text-2xl font-black text-slate-800">0</div>
                        </div>
                        <div id="cardBacklog" onclick="setListFilter('Backlog')" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm stat-card">
                            <p class="text-[10px] text-slate-500 uppercase font-black mb-1">Backlog</p><div id="statBacklog" class="text-2xl font-black text-slate-700">0</div>
                        </div>
                        <div id="cardIniciado" onclick="setListFilter('Iniciado')" class="bg-white p-4 rounded-xl border border-sky-200 shadow-sm stat-card">
                            <p class="text-[10px] text-sky-600 uppercase font-black mb-1">Iniciado</p><div id="statIniciado" class="text-2xl font-black text-slate-800">0</div>
                        </div>
                        <div id="cardPlanejado" onclick="setListFilter('Em Planejamento')" class="bg-white p-4 rounded-xl border border-indigo-200 shadow-sm stat-card">
                            <p class="text-[10px] text-indigo-600 uppercase font-black mb-1 truncate">Em Planejamento</p><div id="statPlanejado" class="text-2xl font-black text-slate-800">0</div>
                        </div>
                        <div id="cardExecDP" onclick="setListFilter('Em Execução (Dentro do Planejado)')" class="bg-white p-4 rounded-xl border border-green-200 shadow-sm stat-card">
                            <p class="text-[10px] text-green-600 uppercase font-black mb-1 leading-tight">Execução<br>(Dentro)</p><div id="statExecDP" class="text-2xl font-black text-slate-800">0</div>
                        </div>
                        <div id="cardExecEA" onclick="setListFilter('Em Execução (Atenção)')" class="bg-white p-4 rounded-xl border border-yellow-200 shadow-sm stat-card">
                            <p class="text-[10px] text-yellow-600 uppercase font-black mb-1 leading-tight">Execução<br>(Atenção)</p><div id="statExecEA" class="text-2xl font-black text-slate-800">0</div>
                        </div>
                        <div id="cardExecRA" onclick="setListFilter('Em Execução (Em Risco / Atrasado)')" class="bg-white p-4 rounded-xl border border-orange-200 shadow-sm stat-card">
                            <p class="text-[10px] text-orange-600 uppercase font-black mb-1 leading-tight">Execução<br>(Risco/Atr)</p><div id="statExecRA" class="text-2xl font-black text-slate-800">0</div>
                        </div>
                        <div id="cardCritico" onclick="setListFilter('Crítico')" class="bg-white p-4 rounded-xl border border-red-300 shadow-sm stat-card">
                            <p class="text-[10px] text-red-600 uppercase font-black mb-1">Crítico</p><div id="statCritico" class="text-2xl font-black text-slate-800">0</div>
                        </div>
                        <div id="cardCancelado" onclick="setListFilter('Cancelado')" class="bg-white p-4 rounded-xl border border-slate-300 shadow-sm stat-card hidden">
                            <p class="text-[10px] text-slate-500 uppercase font-black mb-1">Cancelado</p><div id="statCancelado" class="text-2xl font-black text-slate-800">0</div>
                        </div>
                        <div id="cardConcluido" onclick="setListFilter('Concluído')" class="bg-white p-4 rounded-xl border border-emerald-200 shadow-sm stat-card">
                            <p class="text-[10px] text-emerald-600 uppercase font-black mb-1">Concluído</p><div id="statConcluido" class="text-2xl font-black text-slate-800">0</div>
                        </div>
                    </div>
                    <!-- Chart Section -->
                    <div id="chartsSection" class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hidden transition-all duration-500 gap-4 chart-legend-container flex-col sm:flex-row w-full xl:w-auto xl:min-w-[320px] xl:max-w-[420px] shrink-0">
                        <div id="statusChartWrapper" class="flex flex-col items-center gap-3 flex-1 justify-center border-b sm:border-b-0 sm:border-r border-slate-100 pb-3 sm:pb-0 sm:pr-3">
                             <div class="flex flex-col items-center justify-center"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Status</p><div id="statusChart" class="chart-pie shadow-inner"></div></div>
                             <div id="statusLegendContainer" class="grid grid-cols-2 gap-x-2 gap-y-1 justify-center w-full"></div>
                        </div>
                        <div id="priorityChartWrapper" class="flex flex-col items-center gap-3 flex-1 justify-center sm:pl-3">
                             <div class="flex flex-col items-center justify-center"><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Prioridade</p><div id="priorityChart" class="chart-pie shadow-inner"></div></div>
                             <div class="flex flex-col gap-1 justify-center w-full px-2">
                                <div onclick="setPriorityFilter('Urgente')" id="legend-prio-urg" class="chart-legend-item flex items-center gap-2 text-[10px] font-bold text-slate-600 uppercase"><span class="w-2 h-2 rounded-full bg-red-500 shrink-0"></span> <span>Urgente <span id="count-prio-urg" class="text-slate-400 font-normal ml-0.5"></span></span></div>
                                <div onclick="setPriorityFilter('Alta')" id="legend-prio-high" class="chart-legend-item flex items-center gap-2 text-[10px] font-bold text-slate-600 uppercase"><span class="w-2 h-2 rounded-full bg-orange-500 shrink-0"></span> <span>Alta <span id="count-prio-high" class="text-slate-400 font-normal ml-0.5"></span></span></div>
                                <div onclick="setPriorityFilter('Média')" id="legend-prio-mid" class="chart-legend-item flex items-center gap-2 text-[10px] font-bold text-slate-600 uppercase"><span class="w-2 h-2 rounded-full bg-yellow-500 shrink-0"></span> <span>Média <span id="count-prio-mid" class="text-slate-400 font-normal ml-0.5"></span></span></div>
                                <div onclick="setPriorityFilter('Baixa')" id="legend-prio-low" class="chart-legend-item flex items-center gap-2 text-[10px] font-bold text-slate-600 uppercase"><span class="w-2 h-2 rounded-full bg-green-500 shrink-0"></span> <span>Baixa <span id="count-prio-low" class="text-slate-400 font-normal ml-0.5"></span></span></div>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- ... (Demais Filtros e Botão Adicionar mantidos) ... -->
                
<div id="statsRow2" class="px-4 md:px-6 pt-5 hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm w-full flex flex-col sm:flex-row items-center justify-between gap-4 text-center sm:text-left">
            <div>
                <p class="text-xs text-purple-500 uppercase font-black mb-1 tracking-widest">Total de Recurso Utilizado</p>
                <p class="text-sm text-slate-400">Somatório de todos os contratos e convênios ativos</p>
            </div>
            <div id="statResource" class="text-3xl sm:text-4xl font-black text-slate-800"><span class="text-xl sm:text-2xl text-slate-400 mr-2 align-middle">R$</span>0,00</div>
        </div>

        <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm w-full flex items-center justify-between gap-4">
            <div>
                <p class="text-xs text-purple-500 uppercase font-black mb-1 tracking-widest">Respeito à Vida</p>
                <p class="text-sm text-slate-400">Componente 1 — total de repasse</p>
            </div>
            <div id="statRV1" class="text-3xl sm:text-4xl font-black text-slate-800"><span class="text-xl sm:text-2xl text-slate-400 mr-2 align-middle">R$</span>0,00</div>
        </div>

        <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm w-full flex items-center justify-between gap-4">
            <div>
                <p class="text-xs text-purple-500 uppercase font-black mb-1 tracking-widest">Respeito à Vida</p>
                <p class="text-sm text-slate-400">Componente 3 — total de repasse</p>
            </div>
            <div id="statRV3" class="text-3xl sm:text-4xl font-black text-slate-800"><span class="text-xl sm:text-2xl text-slate-400 mr-2 align-middle">R$</span>0,00</div>
        </div>
    </div>
</div>
<div id="operationalFilters" class="px-4 md:px-6 pt-5 flex flex-col sm:flex-row gap-4 hidden">
                    <div class="flex-1">
                        <label class="text-[11px] font-black text-slate-400 uppercase ml-2 mb-1 block">Filtrar por Serviço</label>
                        <select id="filterService" onchange="renderData()" class="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm outline-none font-medium">
                            <option value="all">Todos os Serviços</option><option value="SCCE">SCCE</option><option value="SDCG">SDCG</option><option value="SFP">SFP</option><option value="SIEDU">SIEDU</option><option value="SOPED">SOPED</option><option value="SETEF">SETEF</option><option value="SDMP">SDMP</option><option value="SDAP">SDAP</option><option value="SAST">SAST</option><option value="RENAEST">RENAEST</option><option value="SESV">SESV</option><option value="SMO">SMO</option><option value="SEP">SEP</option><option value="STSV">STSV</option><option value="SISV">SISV</option><option value="SIM">SIM</option><option value="SGR">SGR</option><option value="SAT">SAT</option><option value="SENT">SENT</option><option value="SFI">SFI</option>
                        </select>
                    </div>
                </div>

                <div class="px-4 md:px-6 pt-5">
                    <button id="addBtn" onclick="openNewModal()" class="action-btn w-full py-4 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 transition-all text-sm font-black uppercase tracking-widest hover:border-current btn-theme-project">
                        <i id="addBtnIcon" class="fas fa-plus-circle mr-2"></i> <span id="addBtnText">Adicionar Projeto</span>
                    </button>
                </div>

                <div class="flex-1 px-4 md:px-6 py-6 space-y-4" id="listContainer">
                    <div id="projectsList" class="space-y-4"></div>
                </div>

                <!-- ... (Legend Section) ... -->
            </div>

            <!-- ... (Outras Views: Despachos, Indicadores, Portaria, Calendario, Gantt) ... -->
             <!-- NOVA ABA: DESPACHOS ATUALIZADA -->
            <div id="despachosView" class="hidden flex-1 flex flex-col h-full bg-slate-100 overflow-hidden">
                <div class="flex flex-col md:flex-row h-full">
                    <!-- Coluna Esquerda: Lista de Reuniões -->
                    <div class="w-full md:w-64 lg:w-72 bg-white border-r border-slate-200 flex flex-col h-full z-10 shadow-md">
                        <div class="p-4 border-b border-slate-100 shrink-0">
                            <h3 class="text-sm font-black text-slate-800 uppercase tracking-tight mb-1">Histórico de Pautas</h3>
                            <p class="text-xs text-slate-500 mb-4">Reuniões realizadas e agendadas</p>
                            <button onclick="toggleModal('meetingModal')" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-2.5 rounded-xl text-xs uppercase tracking-wide flex items-center justify-center gap-2 transition-all shadow-lg shadow-slate-200">
                                <i class="fas fa-plus"></i> Nova Pauta
                            </button>
                        </div>
                        <div id="meetingsList" class="flex-1 overflow-y-auto p-2 space-y-2 bg-slate-50/50">
                            <!-- Lista de Pautas Renderizada via JS -->
                        </div>
                    </div>

                    <!-- Coluna Direita: Detalhes ou Backlog -->
                    <div class="flex-1 flex flex-col h-full overflow-hidden bg-slate-50 relative">
                        <!-- HEADER DA ÁREA DIREITA (AUMENTADO) -->
                        <div class="bg-white border-b border-slate-200 p-5 shrink-0 flex justify-between items-center shadow-sm z-10" id="dispatchRightHeader">
                            <div>
                                <h3 id="drTitle" class="text-2xl font-black text-slate-800 uppercase tracking-tight">Painel de Preparação</h3>
                                <p id="drSubtitle" class="text-sm text-slate-500 font-bold mt-1 uppercase tracking-wider text-blue-600">Backlog de Itens Marcados</p>
                            </div>
                            <!-- Botão de ação contextual (ex: gerar pauta) -->
                             <div id="drActionArea"></div>
                        </div>

                        <!-- CONTEÚDO PRINCIPAL (FONTES MAIORES) -->
                        <div id="dispatchMainContent" class="flex-1 overflow-y-auto p-6">
                            <!-- Backlog ou Detalhes da Reunião -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- NOVA ABA: INDICADORES -->
            <div id="indicatorsView" class="hidden flex-1 flex flex-col p-4 md:p-6 bg-slate-50 space-y-6 overflow-y-auto pb-20 md:pb-6">
                <!-- ... Conteúdo de Indicadores ... -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-pink-100 text-pink-600 rounded-xl flex items-center justify-center shadow-sm"><i class="fas fa-flag-checkered text-xl"></i></div>
                        <div>
                            <h3 class="text-lg sm:text-xl font-black text-slate-800 uppercase tracking-tight">INDICADORES ESTRATÉGICOS</h3>
                            <p class="text-sm text-slate-500 font-medium"> | Monitoramento Mensal</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="bg-pink-50 px-4 py-2 rounded-lg border border-pink-100 hidden sm:block">
                            <span class="text-[11px] font-black text-pink-600 uppercase tracking-wider">Exercício 2026</span>
                        </div>
                    </div>
                </div>
                
                <!-- Barra de busca / filtros (Indicadores) -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
                    <div class="flex flex-col lg:flex-row gap-3 lg:items-center">
                        <div class="flex-1 flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 focus-within:ring-2 focus-within:ring-pink-100">
                            <i class="fas fa-search text-slate-400"></i>
                            <input id="indicatorSearch" type="text" placeholder="Buscar por nome, produto ou unidade..." class="w-full bg-transparent outline-none text-sm font-medium text-slate-700 placeholder-slate-400" />
                            <button id="indicatorClearSearch" type="button" class="text-slate-300 hover:text-slate-600 transition-colors" title="Limpar"><i class="fas fa-times-circle"></i></button>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 lg:w-[520px]">
                            <select id="indicatorTypeFilter" class="bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm font-bold text-slate-700 outline-none">
                                <option value="all">Todos os tipos</option>
                                <option value="ppa">PPA (Estratégicos)</option>
                                <option value="other">Outros</option>
                            </select>
                            <select id="indicatorProductFilter" class="bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm font-bold text-slate-700 outline-none">
                                <option value="all">Todos os produtos</option>
                            </select>
                            <select id="indicatorSort" class="bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm font-bold text-slate-700 outline-none">
                                <option value="name">Ordenar: Nome</option>
                                <option value="progress">Ordenar: Progresso</option>
                                <option value="meta">Ordenar: Meta (2026)</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center justify-between gap-3 mt-3">
                        <div class="text-[11px] font-bold text-slate-500">
                            <span id="indicatorCount" class="font-black text-slate-700">0</span> indicadores exibidos
                            <span class="text-slate-300 mx-2">•</span>
                            <span class="text-slate-500">Clique em um card para atualizar valores</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="openNewIndicatorModal('ppa')" class="text-[11px] font-black uppercase tracking-wider bg-pink-50 text-pink-700 border border-pink-200 hover:bg-pink-100 px-3 py-2 rounded-xl transition-colors flex items-center gap-2"><i class="fas fa-plus"></i> Novo PPA</button>
                            <button onclick="openNewIndicatorModal('other')" class="text-[11px] font-black uppercase tracking-wider bg-indigo-50 text-indigo-700 border border-indigo-200 hover:bg-indigo-100 px-3 py-2 rounded-xl transition-colors flex items-center gap-2"><i class="fas fa-plus"></i> Novo Outro</button>
                        </div>
                    </div>
                </div>

                <div id="indicatorsEmpty" class="hidden bg-white rounded-2xl border border-slate-200 p-10 text-center">
                    <div class="mx-auto w-16 h-16 rounded-2xl bg-pink-50 text-pink-600 flex items-center justify-center"><i class="fas fa-chart-line text-2xl"></i></div>
                    <h4 class="mt-4 text-lg font-black text-slate-800">Nenhum indicador encontrado</h4>
                    <p class="mt-1 text-sm text-slate-500 font-medium">Ajuste os filtros ou cadastre um novo indicador.</p>
                </div>

<div id="indicatorsList" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div>
                <div class="pt-6">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-6 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center shadow-sm"><i class="fas fa-chart-bar text-lg"></i></div>
                            <h3 class="text-lg sm:text-xl font-black text-slate-800 uppercase tracking-tight">Outros Indicadores de Acompanhamento</h3>
                        </div>
                        </div>
                    <div id="otherIndicatorsList" class="grid grid-cols-1 xl:grid-cols-2 gap-6"></div>
                </div>
            </div>

            <!-- Views Ocultas: Portaria, Calendario, Gantt, Modais... (Mantidas) -->
             <div id="portariaView" class="hidden flex-1 flex flex-col p-4 md:p-6 bg-slate-50 space-y-6 overflow-y-auto pb-20 md:pb-6">
                <!-- Conteúdo Portaria -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 flex flex-col xl:flex-row items-start xl:items-center justify-between gap-6">
                    <div class="flex items-center gap-3">
                         <div class="w-12 h-12 bg-cyan-100 text-cyan-600 rounded-xl flex items-center justify-center shadow-sm"><i class="fas fa-book-open text-xl"></i></div>
                         <div><h3 class="text-lg sm:text-xl font-black text-slate-800 uppercase tracking-tight">PORTARIA NORMATIVA DETRAN-SP Nº 44/2025</h3><p class="text-sm text-slate-500 font-medium">Regimento Interno e Atribuições</p></div>
                    </div>
                    <div class="grid grid-cols-12 gap-2 w-full max-w-xl xl:w-auto xl:min-w-[450px]" id="portariaFilters">
                        <button onclick="setPortariaFilter('all')" class="portaria-filter-btn col-span-12 filter-all active" id="pf-all">Todos</button>
                        <button onclick="setPortariaFilter('Diretoria')" class="portaria-filter-btn col-span-4 filter-diretoria" id="pf-Diretoria">Diretoria</button>
                        <button onclick="setPortariaFilter('Coordenadoria')" class="portaria-filter-btn col-span-8 filter-coordenadoria" id="pf-Coordenadoria">Coordenadorias</button>
                        <button onclick="setPortariaFilter('Divisão')" class="portaria-filter-btn col-span-6 filter-divisao" id="pf-Divisão">Divisões</button>
                        <button onclick="setPortariaFilter('Serviço')" class="portaria-filter-btn col-span-6 filter-servico" id="pf-Serviço">Serviços</button>
                    </div>
                </div>
                <div id="portariaList" class="space-y-4"></div>
            </div>
            
            <div id="calendarView" class="hidden flex-1 flex flex-col p-4 md:p-6 bg-slate-50 space-y-5 pb-20 md:pb-6">
                <!-- Conteúdo Calendário -->
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between bg-white p-5 rounded-2xl border border-slate-200 shadow-sm gap-4">
                     <div class="flex flex-wrap items-center gap-4 pl-2">
                        <div class="flex items-center gap-2 select-none opacity-100"><span class="w-3 h-3 rounded-full bg-blue-500"></span><span class="text-[11px] font-black text-slate-500 uppercase">Projetos</span></div>
                        <div class="flex items-center gap-2 select-none opacity-100"><span class="w-3 h-3 rounded-full bg-purple-500"></span><span class="text-[11px] font-black text-slate-500 uppercase">Contratos</span></div>
                        <div class="flex items-center gap-2 select-none opacity-100"><span class="w-3 h-3 rounded-full bg-orange-500"></span><span class="text-[11px] font-black text-slate-500 uppercase">Operacional</span></div>
                        <div class="flex items-center gap-2 select-none opacity-100"><span class="w-3 h-3 rounded-full bg-green-500"></span><span class="text-[11px] font-black text-slate-500 uppercase">Eventos</span></div>
                    </div>
                    <button onclick="openCalendarModal()" class="w-full md:w-auto bg-green-600 text-white px-6 py-3 rounded-xl text-[11px] font-bold uppercase hover:bg-green-700 transition-all shadow-lg shadow-green-100 flex items-center justify-center gap-2"><i class="fas fa-plus"></i> Novo Evento</button>
                </div>
                <div class="calendar-new-wrapper">
                    <div class="calendar-new-header">
                        <div class="flex items-center justify-center gap-4 sm:gap-8 w-full">
                            <button onclick="changeMonth(-1)" class="w-10 h-10 hover:bg-blue-50 rounded-full flex items-center justify-center border border-slate-200 text-slate-400 hover:text-blue-600 transition-all shadow-sm flex-none"><i class="fas fa-chevron-left text-lg"></i></button>
                            <div class="text-center min-w-[140px] sm:min-w-[200px]"><h2 id="calMonthName" class="text-2xl sm:text-3xl font-black capitalize tracking-tight leading-none text-blue-900">Mês</h2><p id="calYearName" class="text-blue-600 font-bold text-sm sm:text-base uppercase mt-1">Ano</p></div>
                            <button onclick="changeMonth(1)" class="w-10 h-10 hover:bg-blue-50 rounded-full flex items-center justify-center border border-slate-200 text-slate-400 hover:text-blue-600 transition-all shadow-sm flex-none"><i class="fas fa-chevron-right text-lg"></i></button>
                        </div>
                    </div>
                    <div class="calendar-new-main">
                        <div class="min-w-[700px]">
                            <div class="grid grid-cols-7 gap-2 mb-3">
                                <div class="text-center text-[10px] font-black text-slate-400 uppercase py-2 bg-slate-50 rounded-lg">Dom</div><div class="text-center text-[10px] font-black text-slate-400 uppercase py-2 bg-slate-50 rounded-lg">Seg</div><div class="text-center text-[10px] font-black text-slate-400 uppercase py-2 bg-slate-50 rounded-lg">Ter</div><div class="text-center text-[10px] font-black text-slate-400 uppercase py-2 bg-slate-50 rounded-lg">Qua</div><div class="text-center text-[10px] font-black text-slate-400 uppercase py-2 bg-slate-50 rounded-lg">Qui</div><div class="text-center text-[10px] font-black text-slate-400 uppercase py-2 bg-slate-50 rounded-lg">Sex</div><div class="text-center text-[10px] font-black text-slate-400 uppercase py-2 bg-slate-50 rounded-lg">Sáb</div>
                            </div>
                            <div id="calendarGrid" class="grid grid-cols-7 gap-2"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="flex justify-between items-center mb-5 border-b border-blue-100 pb-3">
                        <h3 class="text-xs font-black text-blue-900 uppercase tracking-widest" id="eventListTitle">Detalhamento de Eventos</h3>
                        <button id="clearDayFilterBtn" onclick="filterCalendarByDay(null)" class="hidden text-[10px] font-bold text-blue-600 hover:text-blue-800 bg-blue-50 px-3 py-1.5 rounded-lg transition-colors">
                            <i class="fas fa-undo mr-1"></i> Ver Mês Inteiro
                        </button>
                    </div>
                    <div id="calendarEventsList" class="space-y-3"><p class="text-slate-400 text-xs italic text-center py-4">Nenhum evento neste mês.</p></div>
                </div>
            </div>

            <div id="ganttView" class="hidden flex-1 flex flex-col p-4 md:p-6 bg-slate-50 space-y-5 pb-20 md:pb-6 h-full overflow-hidden">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between bg-white p-5 rounded-2xl border border-slate-200 shadow-sm gap-4 shrink-0">
                     <div class="flex items-center gap-3">
                         <div class="w-10 h-10 bg-emerald-100 text-emerald-600 rounded-xl flex items-center justify-center shadow-sm"><i class="fas fa-stream text-lg"></i></div>
                         <div><h3 class="text-lg font-black text-slate-800 uppercase tracking-tight">Cronograma Integrado 2026</h3><p class="text-xs text-slate-500 font-bold">Visão Temporal de Entregas</p></div>
                     </div>
                     <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-xl">
                         <button onclick="setGanttFilter('all')" id="btnGanttAll" class="px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all shadow-sm bg-white text-emerald-600">Todos</button>
                         <button onclick="setGanttFilter('projects')" id="btnGanttProj" class="px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all text-slate-400 hover:text-slate-600">Projetos</button>
                         <button onclick="setGanttFilter('contracts')" id="btnGanttContr" class="px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all text-slate-400 hover:text-slate-600">Contratos</button>
                     </div>
                </div>

                <div class="flex items-center gap-6 px-2 shrink-0">
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-blue-500"></div><span class="text-[10px] font-bold text-slate-500 uppercase">Projeto</span></div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded bg-purple-500"></div><span class="text-[10px] font-bold text-slate-500 uppercase">Contrato</span></div>
                    <div class="flex items-center gap-2"><div class="w-2 h-2 rotate-45 border-2 border-emerald-500 bg-white"></div><span class="text-[10px] font-bold text-slate-500 uppercase">Marco de Entrega</span></div>
                    <div class="flex items-center gap-2"><div class="w-0.5 h-3 bg-red-500"></div><span class="text-[10px] font-bold text-slate-500 uppercase">Hoje</span></div>
                </div>

                <div class="gantt-wrapper flex-1">
                    <div class="gantt-header">
                        <div class="gantt-header-spacer">Item / Responsável</div>
                        <div class="gantt-header-months">
                            <div class="gantt-month-cell">Jan 26</div><div class="gantt-month-cell">Fev 26</div><div class="gantt-month-cell">Mar 26</div><div class="gantt-month-cell">Abr 26</div>
                            <div class="gantt-month-cell">Mai 26</div><div class="gantt-month-cell">Jun 26</div><div class="gantt-month-cell">Jul 26</div><div class="gantt-month-cell">Ago 26</div>
                            <div class="gantt-month-cell">Set 26</div><div class="gantt-month-cell">Out 26</div><div class="gantt-month-cell">Nov 26</div><div class="gantt-month-cell">Dez 26</div>
                        </div>
                    </div>
                    <div class="gantt-body" id="ganttBodyContainer">
                        <!-- Linhas geradas via JS -->
                    </div>
                </div>
            </div>

            <!-- Modal Calendário -->
            <div id="calendarModal" class="items-center justify-center p-2 sm:p-4" style="display: none;">
                <!-- ... Modal Calendar Content ... -->
                <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden border border-slate-200 flex flex-col">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                         <div class="flex items-center gap-3"><div class="w-10 h-10 bg-indigo-600 text-white rounded-lg flex items-center justify-center shadow-lg shadow-indigo-100"><i class="fas fa-calendar-plus text-lg"></i></div><h3 class="font-black text-slate-800 uppercase tracking-tight text-base">Evento de Calendário</h3></div>
                         <button onclick="toggleModal('calendarModal')" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:text-red-500 transition-all flex items-center justify-center"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-6">
                        <form id="calendarForm" class="space-y-4">
                            <input type="hidden" id="calEventId">
                            <div class="flex flex-col"><label class="field-label">Título do Evento</label><input type="text" id="calEventName" class="input-style" required></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="flex flex-col"><label class="field-label">Data</label><input type="date" id="calEventDate" class="input-style" required></div>
                                <div class="flex flex-col"><label class="field-label">Área</label><select id="calEventArea" class="input-style"></select></div>
                            </div>
                            <div class="flex flex-col"><label class="field-label">Observações</label><textarea id="calEventObs" rows="3" class="input-style resize-none"></textarea></div>
                            <div class="flex gap-3 pt-4">
                                <button type="button" id="btnDeleteEvent" onclick="deleteCalendarEvent()" class="px-4 py-3 bg-red-50 text-red-600 rounded-xl font-bold text-xs uppercase hover:bg-red-100 hidden"><i class="fas fa-trash"></i></button>
                                <button type="button" onclick="saveCalendarEvent()" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all uppercase text-xs tracking-widest">Salvar Evento</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, getDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- CONFIGURAÇÃO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBVT30qEXkwHw1Le012oKnEJyAUYcwQC8U",
            authDomain: "painel-gestao-d674d.firebaseapp.com",
            projectId: "painel-gestao-d674d",
            storageBucket: "painel-gestao-d674d.firebasestorage.app",
            messagingSenderId: "993067198876",
            appId: "1:993067198876:web:36e56d669c61437c5ec059",
            measurementId: "G-ESGFQTL8L5"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'painel-gestao-main';

        // ... (Variaveis Globais e Constantes mantidas) ...
        let currentUser = null;
        let activeTab = 'projects';
        let currentFilter = 'all';
        let currentListFilter = 'all'; 
        let currentPriorityFilter = 'all';
        let currentPortariaFilter = 'all';
        let currentGanttFilter = 'all';
        let currentDate = new Date(2026, 0, 1);
        let selectedCalendarDay = null; 
        let selectedMeetingId = null; 
        let selectedBacklogItems = new Set();
        
        const areasList = ["DSV", "EPT", "CEC", "CET", "CGSV", "COST", "CIST", "SCCE", "SDCG", "SFP", "SIEDU", "SOPED", "SETEF", "SDMP", "SDAP", "SAST", "RENAEST", "SESV", "SMO", "SEP", "STSV", "SISV", "SIM", "SGR", "SAT", "SENT", "SFI"];
        const UNIFIED_STATUS = ["Backlog", "Iniciado", "Em Planejamento", "Em Execução (Dentro do Planejado)", "Em Execução (Atenção)", "Em Execução (Em Risco / Atrasado)", "Crítico", "Concluído"];
        const CONTRACT_STATUS = [...UNIFIED_STATUS, "Cancelado"];
        const PROJECT_STATUS = [...UNIFIED_STATUS, "Cancelado"];
        const STATUS_COLORS_HEX = { "Backlog": "#cbd5e1", "Iniciado": "#38bdf8", "Em Planejamento": "#6366f1", "Em Execução (Dentro do Planejado)": "#22c55e", "Em Execução (Atenção)": "#fbbf24", "Em Execução (Em Risco / Atrasado)": "#f97316", "Crítico": "#dc2626", "Concluído": "#059669", "Cancelado": "#64748b" };
        const STATUS_COLORS_TW_BG = { "Backlog": "bg-slate-300", "Iniciado": "bg-sky-400", "Em Planejamento": "bg-indigo-500", "Em Execução (Dentro do Planejado)": "bg-green-500", "Em Execução (Atenção)": "bg-amber-400", "Em Execução (Em Risco / Atrasado)": "bg-orange-500", "Crítico": "bg-red-600", "Concluído": "bg-emerald-600", "Cancelado": "bg-slate-500" };

        let dataStore = { projects: [], contracts: [], operational: [], calendarEvents: [], indicators: [], dispatchMeetings: [] };
        
        // ... (Constantes PORTARIA_DATA e INITIAL_INDICATORS mantidas) ...
        const PORTARIA_DATA = [
            { art: 'Art. 256', title: 'Diretoria de Segurança Viária', type: 'Diretoria', preamble: 'Compete dirigir, planejar, coordenar, controlar, executar e avaliar as atividades referentes a:', items: ['Segurança viária e educação para o trânsito', 'Educação corporativa e governança da aprendizagem', 'Aplicação e repasse de valores arrecadados para segurança viária', 'Estatística, estudos, pesquisas e integração de informações para segurança viária', 'Diretrizes para a fiscalização de trânsito e policiamento ostensivo', 'Integração e atuação em rede com os órgãos do Sistema Estadual de Trânsito (SISTRAN)'] },
            { art: 'Art. 257', title: 'Escola Pública de Trânsito', type: 'Coordenadoria', preamble: 'Compete coordenar, controlar, executar e avaliar as atividades referentes a:', items: ['Educação de crianças, adolescentes, jovens e adultos sobre legislação', 'Promoção da Política Nacional de Trânsito (PNT) e cidadania', 'Campanhas de conscientização para o trânsito seguro', 'Ações de educação para condutores profissionais', 'Gestão da educação corporativa, formação e desenvolvimento contínuo'] },
            { art: 'Art. 258', title: 'Coordenadoria de Educação Corporativa', type: 'Coordenadoria', preamble: 'Compete coordenar, controlar, executar e avaliar as atividades referentes a:', items: ['Programas de capacitação e desenvolvimento profissional', 'Gestão do conhecimento organizacional', 'Avaliação de desempenho e competências', 'Programas de educação corporativa e gamificação', 'Monitoramento e avaliação de resultados de capacitação', 'Articulação com instituições de ensino e parceiros', 'Gestão das plataformas tecnológicas de ensino', 'Desenvolvimento de lideranças e gestão estratégica'] },
            { art: 'Art. 259', title: 'Serviço de Desenvolvimento de Competências Específicas', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Mapeamento de competências técnicas', 'Elaboração de programas de treinamento específicos', 'Avaliação de aprendizagem'] },
            { art: 'Art. 260', title: 'Serviço de Desenvolvimento de Competências Gerais', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Desenvolvimento de habilidades comportamentais', 'Implementação de programas de liderança', 'Promoção de cultura organizacional'] },
            { art: 'Art. 261', title: 'Serviço de Formação Profissional', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Desenvolvimento de programas de formação inicial', 'Gestão de estágios e trainee', 'Implementação de programas de certificação'] },
            { art: 'Art. 262', title: 'Coordenadoria de Educação para o Trânsito', type: 'Coordenadoria', preamble: 'Compete coordenar, controlar, executar e avaliar as atividades referentes a:', items: ['Desenvolvimento de programas educacionais', 'Articulação com instituições de ensino', 'Promoção da cidadania no trânsito'] },
            { art: 'Art. 263', title: 'Serviço de Integração da Educação', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Articulação com instituições educacionais', 'Desenvolvimento de parcerias educativas', 'Implementação de projetos pedagógicos'] },
            { art: 'Art. 264', title: 'Serviço de Operações de Educação', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Organização de eventos educativos', 'Gestão logística de ações educacionais', 'Implementação de campanhas de trânsito'] },
            { art: 'Art. 265', title: 'Serviço de Promoção de Educação no Ensino Fundamental', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Desenvolvimento de material didático', 'Capacitação de educadores', 'Implementação de projetos escolares'] },
            { art: 'Art. 266', title: 'Serviço de Desenvolvimento de Motoristas Profissionais', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Elaboração de programas de capacitação para motoristas profissionais', 'Avaliação de competências de condutores', 'Promoção de práticas de direção segura'] },
            { art: 'Art. 267', title: 'Serviço de Desenvolvimento de Agentes Públicos', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Capacitação de agentes de trânsito', 'Atualização em legislação e procedimentos', 'Desenvolvimento de habilidades de fiscalização'] },
            { art: 'Art. 268', title: 'Coordenadoria Geral de Segurança Viária', type: 'Coordenadoria', preamble: 'Compete coordenar, controlar, executar e avaliar as atividades referentes a:', items: ['Implementação e monitoramento dos Planos de Redução de Mortes e Lesões', 'Execução de programas e acordos de cooperação', 'Coleta e gestão de dados estatísticos sobre sinistros', 'Aplicação, transparência e prestação de contas dos investimentos'] },
            { art: 'Art. 269', title: 'Coordenadoria do Observatório de Segurança no Trânsito', type: 'Coordenadoria', preamble: 'Compete coordenar, controlar, executar e avaliar as atividades referentes a:', items: ['Elaboração e implantação do Plano Estadual de Segurança Viária', 'Desdobramento do Pnatrans e compartilhamento de dados', 'Análise de dados estatísticos de segurança viária', 'Produção de relatórios estatísticos', 'Desenvolvimento de indicadores de desempenho', 'Estudo de padrões e tendências em sinistros', 'Articulação com órgãos do SNT e instituições acadêmicas', 'Gestão das plataformas tecnológicas e painéis de dados'] },
            { art: 'Art. 270', title: 'Divisão de Estatísticas de Trânsito', type: 'Divisão', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Gestão de banco de dados de trânsito', 'Análise estatística avançada', 'Elaboração de relatórios técnicos'] },
            { art: 'Art. 271', title: 'Serviço de Análise de Sinistro de Trânsito', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Investigação de acidentes de trânsito', 'Análise de fatores de risco', 'Elaboração de relatórios técnicos'] },
            { art: 'Art. 272', title: 'Serviço de Integração da Informação', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Gestão de sistemas de informação', 'Integração de bases de dados', 'Desenvolvimento de ferramentas de análise'] },
            { art: 'Art. 273', title: 'Divisão de Redução de Mortes e Lesões no Trânsito', type: 'Divisão', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Planejamento de ações de segurança viária', 'Monitoramento de indicadores de segurança', 'Articulação intersetorial'] },
            { art: 'Art. 274', title: 'Serviço de Estratégia de Segurança Viária', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Desenvolvimento de estratégias de prevenção', 'Análise de eficácia de intervenções', 'Proposição de medidas de segurança'] },
            { art: 'Art. 275', title: 'Serviço de Monitoramento', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Acompanhamento de indicadores de segurança', 'Elaboração de relatórios de desempenho', 'Identificação de tendências e padrões'] },
            { art: 'Art. 276', title: 'Divisão de Estudos para Segurança no Trânsito', type: 'Divisão', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Desenvolvimento de pesquisas em segurança viária', 'Avaliação de políticas públicas de trânsito', 'Proposição de inovações em segurança'] },
            { art: 'Art. 277', title: 'Serviço de Estudos e Pesquisas', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Condução de pesquisas em segurança viária', 'Análise de tendências e comportamentos no trânsito', 'Elaboração de relatórios científicos'] },
            { art: 'Art. 278', title: 'Serviço de Tecnologia em Segurança Viária', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Avaliação de novas tecnologias', 'Implementação de soluções inovadoras', 'Monitoramento de tendências tecnológicas'] },
            { art: 'Art. 279', title: 'Coordenadoria de Integração dos Sistemas de Trânsito', type: 'Coordenadoria', preamble: 'Compete coordenar, controlar, executar e avaliar as atividades referentes a:', items: ['Articulação interinstitucional', 'Gestão de parcerias', 'Coordenação de projetos integrados'] },
            { art: 'Art. 280', title: 'Divisão de Integração para Segurança no Trânsito', type: 'Divisão', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Desenvolvimento de projetos interinstitucionais', 'Promoção de eventos de integração', 'Gestão de informações intersetoriais'] },
            { art: 'Art. 281', title: 'Serviço de Integração para Segurança Viária', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Implementação de ações integradas', 'Articulação com parceiros locais', 'Monitoramento de projetos conjuntos'] },
            { art: 'Art. 282', title: 'Divisão do Plano Estadual de Segurança Viária', type: 'Divisão', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Elaboração de planos estratégicos', 'Monitoramento de metas e indicadores', 'Articulação com municípios'] },
            { art: 'Art. 283', title: 'Serviço de Integração com os Municípios', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Articulação com gestores municipais', 'Apoio técnico a municípios', 'Promoção de ações conjuntas'] },
            { art: 'Art. 284', title: 'Serviço de Gestão de Recursos', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Planejamento orçamentário', 'Gestão financeira de projetos', 'Prestação de contas'] },
            { art: 'Art. 285', title: 'Serviço de Análise Técnica', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Avaliação técnica de projetos', 'Elaboração de pareceres técnicos', 'Suporte à tomada de decisões'] },
            { art: 'Art. 286', title: 'Divisão de Engenharia de Trânsito', type: 'Divisão', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Planejamento de infraestrutura viária', 'Análise de projetos de engenharia de tráfego', 'Proposição de melhorias viárias'] },
            { art: 'Art. 287', title: 'Serviço de Engenharia de Trânsito', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Elaboração de projetos de sinalização', 'Análise de segurança viária', 'Proposição de intervenções físicas'] },
            { art: 'Art. 288', title: 'Serviço de Fiscalização de Intervenções', type: 'Serviço', preamble: 'Compete controlar, executar e avaliar as atividades referentes a:', items: ['Gestão de contratos e fiscalização de obras', 'Avaliação de conformidade técnica e jurídica', 'Elaboração de relatórios de inspeção'] }
        ];

        const INITIAL_INDICATORS = [
            // Produto: RESPEITO À VIDA (Estratégico PPA)
            { 
                id: 'ind_5736', 
                code: '5736', 
                product: 'RESPEITO À VIDA',
                name: 'NÚMERO DE MUNICÍPIOS INTEGRADOS AO SNT', 
                meta: 75, 
                unit: 'un', 
                rule: 'Soma',
                type: 'ppa',
                monthly: [0,0,0,0,0,0,0,0,0,0,0,0],
                ppa: { '2024': 50, '2025': 75, '2026': 75, '2027': 103 },
                ppaRealized: { '2025': 0 }
            },
            { 
                id: 'ind_5737', 
                code: '5737', 
                product: 'RESPEITO À VIDA',
                name: 'TAXA DE ÓBITOS POR SINISTROS (/100k hab)', 
                meta: 9.55, 
                unit: '/100k hab', 
                rule: 'Último valor',
                type: 'ppa',
                monthly: [0,0,0,0,0,0,0,0,0,0,0,0],
                ppa: { '2024': 10.18, '2025': 9.87, '2026': 9.55, '2027': 9.24 },
                ppaRealized: { '2025': 0 }
            },
            // Produto: CAPACITAÇÃO (Estratégico PPA)
            { 
                id: 'ind_5801', 
                code: '5801', 
                product: 'CAPACITAÇÃO, EDUCAÇÃO E DADOS',
                name: 'NÚMERO DE VAGAS OFERECIDAS (EPT/CONTRATOS)', 
                meta: 228131, 
                unit: 'un', 
                rule: 'Último valor',
                type: 'ppa', 
                monthly: [0,0,0,0,0,0,0,0,0,0,0,0],
                ppa: { '2024': 172500, '2025': 198375, '2026': 228131, '2027': 330789 },
                ppaRealized: { '2025': 0 }
            },
            { 
                id: 'ind_5802', 
                code: '5802', 
                product: 'CAPACITAÇÃO, EDUCAÇÃO E DADOS',
                name: 'PERCENTUAL DE CERTIFICADOS EMITIDOS', 
                meta: 90, 
                unit: '%', 
                rule: 'Último valor',
                type: 'ppa',
                monthly: [0,0,0,0,0,0,0,0,0,0,0,0],
                ppa: { '2024': 86, '2025': 88, '2026': 90, '2027': 92 },
                ppaRealized: { '2025': 0 }
            },
            // OUTROS INDICADORES (Novos)
            {
                id: 'ind_other_01',
                code: 'SISTRAN',
                product: 'OUTROS INDICADORES',
                name: 'MUNICÍPIOS INTEGRADOS AO SISTRAN',
                meta: 0,
                unit: 'un',
                rule: 'Soma',
                type: 'other',
                monthly: [0,0,0,0,0,0,0,0,0,0,0,0],
                ppa: { '2024': 0, '2025': 0, '2026': 0 }, // Acompanhamento 24/25/26
                ppaRealized: { '2024': 0, '2025': 0 }
            },
            {
                id: 'ind_other_02',
                code: 'META BR',
                product: 'META BR',
                name: 'META BR - RESPONSABILIDADE DSV',
                meta: 0,
                unit: '%',
                rule: 'Último valor',
                type: 'other',
                monthly: [0,0,0,0,0,0,0,0,0,0,0,0],
                ppa: { '2026': 0 },
                ppaRealized: {}
            },
            {
                id: 'ind_other_03',
                code: 'INFOSIGA',
                product: 'GESTÃO DA INFORMAÇÃO',
                name: 'NÚMERO DE ACESSOS AO INFOSIGA',
                meta: 0,
                unit: 'acessos',
                rule: 'Soma',
                type: 'other',
                monthly: [0,0,0,0,0,0,0,0,0,0,0,0],
                monthly_2025: [0,0,0,0,0,0,0,0,0,0,0,0], // Array para 2025
                ppa: { '2025': 0, '2026': 0 },
                ppaRealized: { '2025': 0 }
            }
        ];

        async function initAuth() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                const statusDiv = document.getElementById('sysStatus');
                const statusText = document.getElementById('sysStatusText');
                const statusDot = document.getElementById('sysStatusDot');

                if(statusDiv) {
                    statusDiv.className = "md:mt-5 flex items-center gap-2 text-[10px] font-black uppercase tracking-wider py-1 md:py-2 px-2 md:px-3 rounded-lg w-auto md:w-full transition-all border border-red-900/50 bg-red-50 cursor-pointer animate-pulse";
                    statusDiv.onclick = () => window.open('https://console.firebase.google.com/project/painel-gestao-d674d/authentication/providers', '_blank');
                    statusDiv.title = "Clique para ativar a Autenticação Anônima no console";
                }
                
                if(statusDot) {
                    statusDot.className = "w-2 h-2 rounded-full bg-red-600";
                }

                if(statusText) {
                    statusText.className = "text-red-600 hidden sm:inline font-bold";
                    statusText.innerText = "Erro Auth (Ativar)";
                }
            }
        }
        initAuth();

        function initListeners() {
            ['projects', 'contracts', 'operational', 'calendar_events', 'indicators', 'dispatch_meetings'].forEach(colName => {
                const storeKey = colName === 'calendar_events' ? 'calendarEvents' : (colName === 'dispatch_meetings' ? 'dispatchMeetings' : colName);
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', colName), (snapshot) => {
                    // IMPORTANTE: garante que o id do Firestore prevaleça mesmo que exista um campo "id" no documento
                    // (isso evita comportamentos estranhos como cards duplicando/colidindo por id sobrescrito).
                    let items = snapshot.docs.map(d => ({ ...d.data(), id: d.id }));
                    
                    if (colName === 'indicators' && items.length === 0) {
                        dataStore[storeKey] = INITIAL_INDICATORS;
                    } else {
                        dataStore[storeKey] = items;
                    }
                    
                    window.updateStatusUI(snapshot.metadata.hasPendingWrites ? 'syncing' : 'online');

                    // Atualiza a view correta sem depender de trocar de aba/recarregar
                    if (colName === 'indicators') {
                        if (activeTab === 'indicators') window.renderIndicators();
                    } else if (colName === 'calendar_events') {
                        if (activeTab === 'calendar') window.renderCalendar();
                    } else if (colName === 'dispatch_meetings') {
                        if (activeTab === 'despachos') window.renderDespachos();
                    } else {
                        // projects/contracts/operational (e demais)
                        if (activeTab === 'gantt') window.renderGantt();
                        else if (activeTab !== 'portaria' && activeTab !== 'calendar' && activeTab !== 'indicators' && activeTab !== 'despachos') window.renderData();
                    }
                }, (err) => console.error("Erro snapshot:", err));
            });
        }
        
        // ... (Todas as demais funções: modal, save, delete, meetings etc... permanecem) ...
        // ... (Para economizar espaço, não repito código que não mudou, mas a função createCardHtml será substituída abaixo) ...

        window.toggleModal = id => { const m = document.getElementById(id); m.style.display = (m.style.display === 'flex' || m.style.display === 'block') ? 'none' : 'flex'; };
        
        window.openNewModal = () => {
            const form = document.getElementById('projectForm');
            form.reset();
            // Reset de links de documentos (multi-links)
            const docsC = document.getElementById('projDocsContainer');
            if (docsC) { docsC.innerHTML = ''; }
            if (typeof window.addDocLinkRow === 'function') { window.addDocLinkRow(''); }

            document.getElementById('editId').value = '';
            document.getElementById('roadmapContainer').innerHTML = '';
            document.getElementById('serviceTagsContainer').innerHTML = ''; 
            document.querySelectorAll('.actor-tag').forEach(el => el.remove());

            const typeField = document.getElementById('contractTypeField');
            const resourceField = document.getElementById('resourceLogicField');
            const relField = document.getElementById('relationalField');
            const serviceField = document.getElementById('serviceField');
            const durationField = document.getElementById('operationalDurationField');
            const complexityField = document.getElementById('complexityField');
            
                        const programField = document.getElementById('contractProgramField');
            const componentField = document.getElementById('contractComponentField');
typeField.classList.add('hidden-field');
            resourceField.classList.add('hidden-field');
            relField.classList.add('hidden-field');
            serviceField.classList.add('hidden-field');
            durationField.classList.add('hidden-field'); 
            complexityField.classList.add('hidden-field');
            
                        programField.classList.add('hidden-field');
            componentField.classList.add('hidden-field');
document.getElementById('projRisks').value = '';
            document.getElementById('riskField').classList.add('hidden-field');
            
            document.getElementById('rasciInputR').value = '';
            document.getElementById('rasciInputA').value = '';
            document.getElementById('rasciInputS').value = '';
            document.getElementById('rasciInputC').value = '';
            document.getElementById('rasciInputI').value = '';

            document.getElementById('deleteBtn').classList.add('hidden');

            const statusSelect = document.getElementById('projStatus');
            statusSelect.innerHTML = (activeTab === 'projects' ? PROJECT_STATUS : (activeTab === 'contracts' ? CONTRACT_STATUS : UNIFIED_STATUS)).map(s => `<option value="${s}">${s}</option>`).join('');

            if (activeTab === 'projects') {
                document.getElementById('modalTitle').innerText = 'Novo Projeto Estratégico';
                complexityField.classList.remove('hidden-field'); 
            } else if (activeTab === 'contracts') {
                document.getElementById('modalTitle').innerText = 'Novo Contrato / Convênio';
                typeField.classList.remove('hidden-field');
                resourceField.classList.remove('hidden-field');
                document.getElementById('contractRelationWrapper').classList.remove('hidden-field');
                            programField.classList.remove('hidden-field');
                document.getElementById('contractProgram').value = '';
                document.getElementById('contractComponent').value = '';
                toggleContractProgramFields();
} else if (activeTab === 'operational') {
                document.getElementById('modalTitle').innerText = 'Nova Atividade Operacional';
                relField.classList.remove('hidden-field');
                serviceField.classList.remove('hidden-field');
                durationField.classList.remove('hidden-field'); 
            }

            toggleModal('projectModal');
        };

        // ... (Funções auxiliares de toggle) ...
        window.toggleContractRelInput = () => { const isSim = document.querySelector('input[name="contractRelType"]:checked').value === 'sim'; const wrapper = document.getElementById('projectSelectWrapper'); if (isSim) { wrapper.classList.remove('hidden-field'); const select = document.getElementById('projRelation'); select.innerHTML = '<option value="">Selecione...</option>' + dataStore.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); } else { wrapper.classList.add('hidden-field'); } };
        window.toggleResourceInput = () => { const hasResource = document.getElementById('projHasResource').value === 'Sim'; document.getElementById('resourceValueField').classList.toggle('hidden-field', !hasResource); };

        // --- Documentos (multi-links) ---
        window.addDocLinkRow = (value = '') => {
            const container = document.getElementById('projDocsContainer');
            if (!container) return;
            const count = container.querySelectorAll('input[data-doc-link]').length;
            if (count >= 6) return; // limite simples p/ evitar excesso no modal

            const row = document.createElement('div');
            row.className = 'flex items-center gap-2';
            row.innerHTML = `
                <div class="doc-link-container flex-1 !justify-start" onclick="this.querySelector('input').focus()">
                    <i class="fas fa-link"></i>
                    <input type="text" data-doc-link="1" class="bg-transparent outline-none flex-1 text-slate-600" placeholder="Cole a URL do documento" value="${(value || '').replace(/"/g, '&quot;')}">
                </div>
                <button type="button" class="w-9 h-9 rounded-xl bg-slate-100 text-slate-400 hover:bg-red-50 hover:text-red-600 transition-colors flex items-center justify-center" title="Remover">
                    <i class="fas fa-times text-sm"></i>
                </button>
            `;
            const btn = row.querySelector('button');
            btn.addEventListener('click', () => {
                row.remove();
                // garante pelo menos 1 campo visível
                const remaining = container.querySelectorAll('input[data-doc-link]').length;
                if (remaining === 0) window.addDocLinkRow('');
            });

            container.appendChild(row);
        };

        window.getDocLinksFromForm = () => {
            const container = document.getElementById('projDocsContainer');
            if (!container) return [];
            return Array.from(container.querySelectorAll('input[data-doc-link]'))
                .map(i => (i.value || '').trim())
                .filter(v => v.length > 0);
        };


        function toggleContractProgramFields() {
            const programEl = document.getElementById('contractProgram');
            const componentField = document.getElementById('contractComponentField');
            const componentEl = document.getElementById('contractComponent');
            if (!componentField) return;
            const program = programEl ? programEl.value : '';
            const show = (program === 'Respeito à Vida');
            componentField.classList.toggle('hidden-field', !show);
            if (!show && componentEl) componentEl.value = '';
        }
        window.toggleContractProgramFields = toggleContractProgramFields;

        window.toggleOriginInput = () => { const originType = document.querySelector('input[name="originType"]:checked').value; const wrapper = document.getElementById('projectSelectWrapper'); const select = document.getElementById('projRelation'); const label = wrapper.querySelector('label'); if (originType === 'pontual') { wrapper.classList.add('hidden-field'); select.innerHTML = ''; } else { wrapper.classList.remove('hidden-field'); if (originType === 'projeto') { label.innerText = "Vincular a qual Projeto?"; select.innerHTML = '<option value="">Selecione o Projeto...</option>' + dataStore.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); } else if (originType === 'contrato') { label.innerText = "Vincular a qual Contrato?"; select.innerHTML = '<option value="">Selecione o Contrato...</option>' + dataStore.contracts.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); } } };
        window.toggleRiskInput = () => { const status = document.getElementById('projStatus').value; const riskField = document.getElementById('riskField'); const show = ["Em Execução (Atenção)", "Em Execução (Em Risco / Atrasado)", "Crítico"].includes(status); riskField.classList.toggle('hidden-field', !show); };

        // ... (Funções de Tag e RASCI - mantidas) ...
        const getTagsFromContainer = (containerId) => { const container = document.getElementById(containerId); if(!container) return []; return Array.from(container.querySelectorAll('.actor-tag span')).map(s => s.innerText); };
        const createTag = (text, containerId, inputId, colorClass = 'tag-blue') => { const container = document.getElementById(containerId); const input = inputId ? document.getElementById(inputId) : null; if(!container) return; const tag = document.createElement('div'); tag.className = `actor-tag ${colorClass}`; tag.innerHTML = `<span>${text}</span><i class="fas fa-times cursor-pointer hover:opacity-75" onclick="this.parentElement.remove()"></i>`; if(input) { container.insertBefore(tag, input); } else { container.appendChild(tag); } };
        window.addServiceTag = (val) => { if(!val) return; const container = document.getElementById('serviceTagsContainer'); const existing = Array.from(container.querySelectorAll('span')).map(s => s.innerText); if(existing.includes(val)) return; createTag(val, 'serviceTagsContainer', null, 'tag-orange'); };
        const setupTagInput = (inputId, containerId, colorClass) => { const input = document.getElementById(inputId); if(!input) return; input.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ',') { e.preventDefault(); const val = this.value.trim().replace(',', ''); if(val) { createTag(val, containerId, inputId, colorClass); this.value = ''; } } }); };
        
        window.addRoadmapRow = (data = '', etapa = '') => { const container = document.getElementById('roadmapContainer'); const row = document.createElement('div'); row.className = 'grid grid-cols-1 sm:grid-cols-12 gap-3 items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm'; row.innerHTML = `<div class="sm:col-span-4"><input type="date" class="input-style roadmap-date" value="${data}"></div><div class="sm:col-span-7"><input type="text" class="input-style roadmap-step" placeholder="Etapa..." value="${etapa}"></div><div class="sm:col-span-1 text-center"><button type="button" onclick="this.parentElement.parentElement.remove()" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></div>`; container.appendChild(row); };

        window.saveProject = async () => {
            if (!currentUser) return;
            const id = document.getElementById('editId').value || Date.now().toString();
            const roadmap = [];
            document.querySelectorAll('#roadmapContainer > div').forEach(row => { const d = row.querySelector('.roadmap-date').value; const e = row.querySelector('.roadmap-step').value; if (d && e) roadmap.push({ data: d, etapa: e }); });
            const servicesList = Array.from(document.querySelectorAll('#serviceTagsContainer .actor-tag span')).map(s => s.innerText);
            const data = {
                name: document.getElementById('projName').value, desc: document.getElementById('projDesc').value, obs: document.getElementById('projObs').value, sei: document.getElementById('projSei').value, prazo: document.getElementById('projPrazo').value, coord: document.getElementById('projCoord').value, status: document.getElementById('projStatus').value, priority: document.getElementById('projPriority').value, docLinks: window.getDocLinksFromForm(), risks: document.getElementById('projRisks').value, duration: document.getElementById('projDuration').value, complexity: document.getElementById('projComplexity').value, roadmap: roadmap,
                rasci: { r: getTagsFromContainer('rasciContainerR'), a: getTagsFromContainer('rasciContainerA'), s: getTagsFromContainer('rasciContainerS'), c: getTagsFromContainer('rasciContainerC'), i: getTagsFromContainer('rasciContainerI') }, updatedAt: Date.now()
            };
            if (activeTab === 'contracts') { data.type = document.getElementById('projType').value; data.hasResource = document.getElementById('projHasResource').value; data.resourceValue = document.getElementById('projResourceValue').value; data.program = document.getElementById('contractProgram').value; data.programComponent = document.getElementById('contractComponent').value; } else if (activeTab === 'operational') { data.services = servicesList; data.service = servicesList.length > 0 ? servicesList[0] : ''; data.originType = document.querySelector('input[name="originType"]:checked').value; data.projRelation = document.getElementById('projRelation').value; }
            try { if(document.getElementById('editId').value) { const existing = dataStore[activeTab].find(i => i.id === id); if(existing && existing.onDispatch) data.onDispatch = true; if(existing && existing.onPlanner) data.onPlanner = true; if(existing && existing.dispatchData) data.dispatchData = existing.dispatchData; } await setDoc(doc(db, 'artifacts', appId, 'public', 'data', activeTab, id), data, {merge: true}); toggleModal('projectModal'); } catch (err) { console.error("Erro ao salvar:", err); }
        };

        // ... (Delete Project, Dispatch Toggle, Meeting functions... mantidas) ...
        window.deleteProject = async () => { const id = document.getElementById('editId').value; if (!id) return; const btn = document.getElementById('deleteBtn'); if (btn.innerText.includes('Excluir')) { btn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> Confirmar?'; btn.classList.add('bg-red-600', 'text-white'); btn.classList.remove('bg-red-50', 'text-red-600'); setTimeout(() => { if(document.getElementById('projectModal').style.display !== 'none') { btn.innerHTML = '<i class="fas fa-trash mr-2"></i> Excluir'; btn.classList.remove('bg-red-600', 'text-white'); btn.classList.add('bg-red-50', 'text-red-600'); } }, 3000); return; } try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', activeTab, id)); toggleModal('projectModal'); } catch (err) { console.error("Erro ao excluir:", err); } };
        window.toggleDispatch = async (id, collectionName) => { if(!collectionName) collectionName = activeTab; const item = dataStore[collectionName].find(i => i.id === id); if(!item) return; const newVal = !item.onDispatch; try { item.onDispatch = newVal; await setDoc(doc(db, 'artifacts', appId, 'public', 'data', collectionName, id), { onDispatch: newVal }, { merge: true }); if(activeTab === 'despachos') window.renderDespachos(); else window.renderData(); } catch (err) { console.error("Erro ao atualizar despacho:", err); } };


        window.togglePlanner = async (id, collectionName) => {
            if(!collectionName) collectionName = activeTab;
            const item = dataStore[collectionName]?.find(i => i.id === id);
            if(!item) return;
            const newVal = !item.onPlanner;
            try {
                item.onPlanner = newVal;
                await setDoc(
                    doc(db, 'artifacts', appId, 'public', 'data', collectionName, id),
                    { onPlanner: newVal },
                    { merge: true }
                );
                if(activeTab === 'despachos') window.renderDespachos();
                else window.renderData();
            } catch (err) {
                console.error("Erro ao atualizar Planner:", err);
            }
        };

        window.toggleBacklogSelection = (checkbox) => { const val = JSON.parse(checkbox.value); if (checkbox.checked) { selectedBacklogItems.add(checkbox.value); } else { selectedBacklogItems.delete(checkbox.value); } const btn = document.getElementById('createMeetingBtn'); const count = selectedBacklogItems.size; if(btn) { if(count > 0) { btn.classList.remove('opacity-50', 'cursor-not-allowed'); btn.innerText = `Gerar Pauta (${count} itens)`; btn.disabled = false; } else { btn.classList.add('opacity-50', 'cursor-not-allowed'); btn.innerText = `Gerar Pauta`; btn.disabled = true; } } document.getElementById('selectedCountBadge').innerText = count; };
        window.openCreateMeetingModal = () => { document.getElementById('meetingForm').reset(); document.getElementById('newMeetingDate').valueAsDate = new Date(); document.getElementById('selectedCountBadge').innerText = selectedBacklogItems.size; toggleModal('meetingModal'); };
        window.createNewMeeting = async () => { const title = document.getElementById('newMeetingTitle').value; const date = document.getElementById('newMeetingDate').value; const attendees = document.getElementById('newMeetingAttendees').value; const items = []; selectedBacklogItems.forEach(jsonStr => { const obj = JSON.parse(jsonStr); const realItem = dataStore[obj.collection]?.find(i => i.id === obj.id); if(realItem) { items.push({ itemId: obj.id, collection: obj.collection, name: realItem.name, status: 'Pendente', outcome: '' }); } }); const meetingData = { title, date, attendees, items, status: 'Agendada', createdAt: Date.now() }; try { const newId = Date.now().toString(); await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dispatch_meetings', newId), meetingData); selectedBacklogItems.clear(); toggleModal('meetingModal'); selectedMeetingId = newId; window.renderDespachos(); } catch(err) { console.error("Erro ao criar pauta:", err); } };
        window.selectMeeting = (id) => { selectedMeetingId = id; window.renderDespachos(); };
        window.closeMeetingDetails = () => { selectedMeetingId = null; window.renderDespachos(); };
        window.deleteMeeting = async (id, btn) => { if (btn.innerText.includes('Excluir')) { const originalContent = btn.innerHTML; btn.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i> Confirmar?'; btn.classList.add('bg-red-600', 'text-white', 'border-red-600'); btn.classList.remove('text-red-400', 'hover:text-red-600', 'hover:bg-red-50'); setTimeout(() => { if(document.body.contains(btn)) { btn.innerHTML = originalContent; btn.classList.remove('bg-red-600', 'text-white', 'border-red-600'); btn.classList.add('text-red-400', 'hover:text-red-600', 'hover:bg-red-50'); } }, 3000); return; } try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dispatch_meetings', id)); selectedMeetingId = null; window.renderDespachos(); } catch (err) { console.error("Erro ao excluir reunião:", err); } };
        window.removeMeetingItem = async (meetingId, itemIndex) => { const meeting = dataStore.dispatchMeetings.find(m => m.id === meetingId); if(!meeting) return; const updatedItems = [...meeting.items]; updatedItems.splice(itemIndex, 1); try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dispatch_meetings', meetingId), { items: updatedItems }, { merge: true }); window.renderDespachos(); } catch(err) { console.error("Erro ao remover item da pauta:", err); } };
        window.openEditMeetingModal = (meetingId) => { const meeting = dataStore.dispatchMeetings.find(m => m.id === meetingId); if(!meeting) return; document.getElementById('editMeetingId').value = meeting.id; document.getElementById('editMeetingTitle').value = meeting.title || ''; document.getElementById('editMeetingDate').value = meeting.date; document.getElementById('editMeetingAttendees').value = meeting.attendees || ''; toggleModal('editMeetingModal'); };
        window.saveMeetingEdit = async () => { const id = document.getElementById('editMeetingId').value; const updates = { title: document.getElementById('editMeetingTitle').value, date: document.getElementById('editMeetingDate').value, attendees: document.getElementById('editMeetingAttendees').value }; try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dispatch_meetings', id), updates, { merge: true }); toggleModal('editMeetingModal'); window.renderDespachos(); } catch(err) { console.error("Erro ao editar reunião:", err); } };
        window.saveMeetingItemOutcome = async (meetingId, itemIndex, val, btnElement) => { const meeting = dataStore.dispatchMeetings.find(m => m.id === meetingId); if(!meeting) return; if(btnElement) { var originalHtml = btnElement.innerHTML; btnElement.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-1"></i> Salvando...'; btnElement.classList.add('opacity-75', 'cursor-not-allowed'); } const updatedItems = [...meeting.items]; updatedItems[itemIndex].outcome = val; try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dispatch_meetings', meetingId), { items: updatedItems }, { merge: true }); if(btnElement) { btnElement.innerHTML = '<i class="fas fa-check mr-1"></i> Salvo!'; btnElement.classList.remove('bg-blue-100', 'text-blue-600'); btnElement.classList.add('bg-green-100', 'text-green-600'); setTimeout(() => { btnElement.innerHTML = originalHtml; btnElement.classList.remove('bg-green-100', 'text-green-600', 'opacity-75', 'cursor-not-allowed'); btnElement.classList.add('bg-blue-100', 'text-blue-600'); }, 2000); } } catch(err) { console.error("Erro ao salvar deliberação:", err); if(btnElement) btnElement.innerHTML = '<i class="fas fa-times mr-1"></i> Erro'; } };
        window.saveMeetingItemStatus = async (meetingId, itemIndex, newStatus) => { const meeting = dataStore.dispatchMeetings.find(m => m.id === meetingId); if(!meeting) return; const updatedItems = [...meeting.items]; updatedItems[itemIndex].status = newStatus; try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dispatch_meetings', meetingId), { items: updatedItems }, { merge: true }); window.renderDespachos(); } catch(err) { console.error("Erro ao salvar status:", err); } };
        window.addMeetingItemDoc = async (meetingId, itemIndex, url) => { if(!url || !url.trim()) return; const meeting = dataStore.dispatchMeetings.find(m => m.id === meetingId); if(!meeting) return; const updatedItems = [...meeting.items]; const item = updatedItems[itemIndex]; let currentLinks = item.docLinks || []; if (!item.docLinks && item.docLink) currentLinks.push(item.docLink); currentLinks.push(url.trim()); item.docLinks = currentLinks; if(item.docLink) delete item.docLink; try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dispatch_meetings', meetingId), { items: updatedItems }, { merge: true }); } catch(err) { console.error("Erro ao adicionar documento:", err); } };
        window.removeMeetingItemDoc = async (meetingId, itemIndex, linkIndex) => { const meeting = dataStore.dispatchMeetings.find(m => m.id === meetingId); if(!meeting) return; const updatedItems = [...meeting.items]; const item = updatedItems[itemIndex]; let currentLinks = item.docLinks || (item.docLink ? [item.docLink] : []); currentLinks.splice(linkIndex, 1); item.docLinks = currentLinks; if(item.docLink) delete item.docLink; try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dispatch_meetings', meetingId), { items: updatedItems }, { merge: true }); } catch(err) { console.error("Erro ao remover documento:", err); } };
        
        window.editItem = (id, type) => {
            const t = type || activeTab;
            const item = dataStore[t]?.find(i => i.id === id);
            if (!item) return;

            window.openNewModal();
            if (t === 'contracts') {
                document.getElementById('modalTitle').innerText = 'Editar Contrato / Convênio';
                document.getElementById('contractTypeField').classList.remove('hidden-field');
                document.getElementById('resourceLogicField').classList.remove('hidden-field');
                document.getElementById('contractRelationWrapper').classList.remove('hidden-field');
                document.getElementById('complexityField').classList.add('hidden-field');
                            document.getElementById('contractProgramField').classList.remove('hidden-field');
                toggleContractProgramFields();
} else if (t === 'operational') {
                document.getElementById('modalTitle').innerText = 'Editar Atividade Operacional';
                document.getElementById('relationalField').classList.remove('hidden-field');
                document.getElementById('serviceField').classList.remove('hidden-field');
                document.getElementById('operationalDurationField').classList.remove('hidden-field');
                document.getElementById('complexityField').classList.add('hidden-field');
                const services = item.services || (item.service ? [item.service] : []);
                services.forEach(s => window.addServiceTag(s));
                if (item.originType) { const radio = document.querySelector(`input[name="originType"][value="${item.originType}"]`); if(radio) { radio.checked = true; window.toggleOriginInput(); setTimeout(() => { if(item.projRelation) document.getElementById('projRelation').value = item.projRelation; }, 50); } }
            } else {
                 document.getElementById('modalTitle').innerText = 'Editar Projeto Estratégico';
                 document.getElementById('complexityField').classList.remove('hidden-field');
            }

            document.getElementById('editId').value = item.id;
            const delBtn = document.getElementById('deleteBtn');
            delBtn.classList.remove('hidden');
            delBtn.innerHTML = '<i class="fas fa-trash mr-2"></i> Excluir';
            delBtn.classList.remove('bg-red-600', 'text-white');
            delBtn.classList.add('bg-red-50', 'text-red-600');

            document.getElementById('projName').value = item.name || '';
            document.getElementById('projDesc').value = item.desc || '';
            document.getElementById('projObs').value = item.obs || '';
            document.getElementById('projSei').value = item.sei || '';
            document.getElementById('projPrazo').value = item.prazo || '';
            document.getElementById('projCoord').value = item.coord || '';
            document.getElementById('projStatus').value = item.status || 'Backlog';
            document.getElementById('projPriority').value = item.priority || 'Média';
            // Documentos (multi-links)
            const docsC = document.getElementById('projDocsContainer');
            if (docsC) { docsC.innerHTML = ''; }
            const links = item.docLinks || (item.docLink ? [item.docLink] : []);
            if (links.length === 0) links.push('');
            links.forEach(l => window.addDocLinkRow(l));
            document.getElementById('projRisks').value = item.risks || ''; 
            document.getElementById('projDuration').value = item.duration || ''; 
            document.getElementById('projComplexity').value = item.complexity || 'Média';

            if (item.rasci) {
                const populateTags = (val, containerId, inputId, color) => { if (Array.isArray(val)) { val.forEach(t => createTag(t, containerId, inputId, color)); } else if (typeof val === 'string' && val.trim() !== '') { createTag(val, containerId, inputId, color); } };
                populateTags(item.rasci.r, 'rasciContainerR', 'rasciInputR', 'tag-blue');
                populateTags(item.rasci.a, 'rasciContainerA', 'rasciInputA', 'tag-red');
                populateTags(item.rasci.s, 'rasciContainerS', 'rasciInputS', 'tag-orange');
                populateTags(item.rasci.c, 'rasciContainerC', 'rasciInputC', 'tag-purple');
                populateTags(item.rasci.i, 'rasciContainerI', 'rasciInputI', 'tag-green');
            }

            window.toggleRiskInput(); 
            if (item.roadmap) { item.roadmap.forEach(r => window.addRoadmapRow(r.data, r.etapa)); }
            if (t === 'contracts') { document.getElementById('projType').value = item.type || 'Contrato'; document.getElementById('projHasResource').value = item.hasResource || 'Não'; document.getElementById('projResourceValue').value = item.resourceValue || ''; document.getElementById('contractProgram').value = item.program || ''; document.getElementById('contractComponent').value = item.programComponent || ''; window.toggleResourceInput(); window.toggleContractProgramFields(); } else if (t === 'operational') { document.getElementById('projService').value = item.service || 'SCCE'; }
        };

        // ... (Render Portaria, Switch Tab, Render Gantt, Backlog Items functions... mantidas) ...
        window.setPortariaFilter = (type) => { currentPortariaFilter = type; document.querySelectorAll('.portaria-filter-btn').forEach(btn => btn.classList.remove('active')); const activeBtn = document.getElementById('pf-' + type); if(activeBtn) activeBtn.classList.add('active'); window.renderPortaria(); };
        window.renderPortaria = () => { const container = document.getElementById('portariaList'); const search = document.getElementById('searchInput').value.toLowerCase(); container.innerHTML = ''; let filtered = PORTARIA_DATA.filter(item => item.title.toLowerCase().includes(search) || item.items.some(sub => sub.toLowerCase().includes(search)) || item.art.toLowerCase().includes(search)); if (currentPortariaFilter !== 'all') filtered = filtered.filter(item => item.type === currentPortariaFilter); if(filtered.length === 0) { container.innerHTML = '<p class="text-slate-400 italic text-center mt-10">Nenhum item encontrado.</p>'; return; } filtered.forEach(item => { let bc = '', tc = ''; if(item.type === 'Diretoria') { bc = 'badge-diretoria'; tc = 'type-diretoria'; } else if(item.type === 'Coordenadoria') { bc = 'badge-coordenadoria'; tc = 'type-coordenadoria'; } else if(item.type === 'Divisão') { bc = 'badge-divisao'; tc = 'type-divisao'; } else { bc = 'badge-servico'; tc = 'type-servico'; } const itemsHtml = item.items.map((sub, idx) => `<li class="flex items-start gap-3 relative pl-2 group/item"><span class="text-[10px] font-bold text-slate-400 mt-0.5 w-5 shrink-0 text-right">${['I','II','III','IV','V','VI','VII','VIII','IX','X'][idx] || '-'}</span><span class="text-sm text-slate-700 leading-snug border-l border-slate-200 pl-3">${sub}</span></li>`).join(''); container.innerHTML += `<div class="portaria-card ${tc}"><div class="flex items-start justify-between mb-4"><div><span class="text-[11px] font-black text-slate-400 uppercase tracking-widest block mb-1">${item.art}</span><h4 class="font-bold text-slate-800 text-lg leading-tight mb-2">${item.title}</h4><p class="text-xs text-slate-500 italic border-l-2 border-slate-200 pl-2 leading-relaxed max-w-2xl">${item.preamble}</p></div><span class="portaria-badge ${bc} ml-2 shrink-0">${item.type}</span></div><ul class="space-y-3 pt-2">${itemsHtml}</ul></div>`; }); };
        window.switchTab = (tab) => { activeTab = tab; currentListFilter = 'all'; currentFilter = 'all'; currentPriorityFilter = 'all'; const app = document.getElementById('appShell'); const addBtn = document.getElementById('addBtn'); const addBtnText = document.getElementById('addBtnText'); app.classList.remove('contracts-theme', 'operational-theme', 'portaria-theme'); document.querySelectorAll('.tab-btn').forEach(b => b.className = "tab-btn w-auto md:w-full flex items-center space-x-2 md:space-x-3 p-2 md:p-3 rounded-lg whitespace-nowrap text-slate-400"); const mapBg = { projects: "bg-blue-600", contracts: "bg-purple-600", operational: "bg-orange-500", portaria: "bg-cyan-600", calendar: "bg-indigo-600", indicators: "bg-pink-600", despachos: "bg-slate-800", gantt: "bg-emerald-600" }; document.getElementById(`tab-${tab}`).className += " " + mapBg[tab] + " text-white"; addBtn.className = "action-btn w-full py-4 border-2 border-dashed border-slate-200 rounded-2xl transition-all text-sm font-black uppercase tracking-widest hover:border-current"; document.getElementById('standardView').classList.add('hidden'); document.getElementById('portariaView').classList.add('hidden'); document.getElementById('calendarView').classList.add('hidden'); document.getElementById('indicatorsView').classList.add('hidden'); document.getElementById('despachosView').classList.add('hidden'); document.getElementById('ganttView').classList.add('hidden'); document.getElementById('statsWrapper').classList.add('hidden'); document.getElementById('addBtn').parentElement.classList.add('hidden'); document.getElementById('pmgInfoBtn').classList.add('hidden');
            if (document.getElementById('cardCancelado')) document.getElementById('cardCancelado').classList.add('hidden'); if (tab === 'projects' || tab === 'contracts') { if (document.getElementById('cardCancelado')) document.getElementById('cardCancelado').classList.remove('hidden'); } if (tab === 'projects') { addBtn.classList.add('btn-theme-project'); addBtnText.innerText = 'Adicionar Projeto'; document.getElementById('viewTitle').innerText = 'Portfólio de Projetos'; document.getElementById('standardView').classList.remove('hidden'); document.getElementById('statsWrapper').classList.remove('hidden'); document.getElementById('addBtn').parentElement.classList.remove('hidden'); document.getElementById('pmgInfoBtn').classList.remove('hidden'); showCharts(true, false); } else if (tab === 'contracts') { addBtn.classList.add('btn-theme-contract'); addBtnText.innerText = 'Adicionar Contrato'; app.classList.add('contracts-theme'); document.getElementById('viewTitle').innerText = 'Contratos | Convênios'; document.getElementById('standardView').classList.remove('hidden'); document.getElementById('statsWrapper').classList.remove('hidden'); document.getElementById('addBtn').parentElement.classList.remove('hidden'); showCharts(true, false); } else if (tab === 'operational') { addBtn.classList.add('btn-theme-operational'); addBtnText.innerText = 'Adicionar Atividade'; app.classList.add('operational-theme'); document.getElementById('viewTitle').innerText = 'Atividades Operacionais'; document.getElementById('standardView').classList.remove('hidden'); document.getElementById('statsWrapper').classList.remove('hidden'); document.getElementById('addBtn').parentElement.classList.remove('hidden'); showCharts(false, true); } else if (tab === 'portaria') { app.classList.add('portaria-theme'); document.getElementById('viewTitle').innerText = 'Portaria Detran nº 44/2025'; document.getElementById('portariaView').classList.remove('hidden'); window.renderPortaria(); } else if (tab === 'calendar') { document.getElementById('viewTitle').innerText = 'Calendário Estratégico'; document.getElementById('calendarView').classList.remove('hidden'); window.renderCalendar(); } else if (tab === 'indicators') { document.getElementById('viewTitle').innerText = 'Indicadores Estratégicos'; document.getElementById('indicatorsView').classList.remove('hidden'); window.renderIndicators(); } else if (tab === 'despachos') { document.getElementById('viewTitle').innerText = 'Pauta de Despachos'; document.getElementById('despachosView').classList.remove('hidden'); window.renderDespachos(); } else if (tab === 'gantt') { document.getElementById('viewTitle').innerText = 'Cronograma Integrado'; document.getElementById('ganttView').classList.remove('hidden'); window.renderGantt(); } document.getElementById('filterService').value = 'all'; document.getElementById('operationalFilters').style.display = tab === 'operational' ? 'flex' : 'none'; document.getElementById('statsRow2').style.display = tab === 'contracts' ? 'block' : 'none'; document.querySelectorAll('.active-coord').forEach(b => b.classList.remove('active-coord')); document.querySelectorAll('.active-filter').forEach(c => c.classList.remove('active-filter')); if(document.getElementById('cardTotal')) document.getElementById('cardTotal').classList.add('active-filter'); document.querySelectorAll('[id^="legend-prio-"]').forEach(el => el.classList.remove('active-legend')); if(tab !== 'portaria' && tab !== 'calendar' && tab !== 'indicators' && tab !== 'despachos' && tab !== 'gantt') window.renderData(); };
        window.setGanttFilter = (filter) => { currentGanttFilter = filter; document.getElementById('btnGanttAll').className = `px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all ${filter === 'all' ? 'shadow-sm bg-white text-emerald-600' : 'text-slate-400 hover:text-slate-600'}`; document.getElementById('btnGanttProj').className = `px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all ${filter === 'projects' ? 'shadow-sm bg-white text-emerald-600' : 'text-slate-400 hover:text-slate-600'}`; document.getElementById('btnGanttContr').className = `px-4 py-2 rounded-lg text-[10px] font-black uppercase transition-all ${filter === 'contracts' ? 'shadow-sm bg-white text-emerald-600' : 'text-slate-400 hover:text-slate-600'}`; window.renderGantt(); };
        window.renderGantt = () => { const container = document.getElementById('ganttBodyContainer'); container.innerHTML = ''; let items = []; if (currentGanttFilter === 'all' || currentGanttFilter === 'projects') { items = [...items, ...dataStore.projects.map(i => ({...i, type: 'project'}))]; } if (currentGanttFilter === 'all' || currentGanttFilter === 'contracts') { items = [...items, ...dataStore.contracts.map(i => ({...i, type: 'contract'}))]; } items = items.filter(i => i.prazo); items.sort((a,b) => a.prazo.localeCompare(b.prazo)); const yearStart = new Date('2026-01-01').getTime(); const yearEnd = new Date('2026-12-31').getTime(); const yearDuration = yearEnd - yearStart; const today = new Date().getTime(); if(items.length === 0) { container.innerHTML = '<p class="text-slate-400 italic text-center py-10">Nenhum item com prazo definido para 2026.</p>'; return; } items.forEach(item => { const deadlineDate = new Date(item.prazo).getTime(); let startDate = yearStart; if (item.roadmap && item.roadmap.length > 0) { const sorted = [...item.roadmap].sort((a,b) => a.data.localeCompare(b.data)); startDate = new Date(sorted[0].data).getTime(); } const safeStart = Math.max(startDate, yearStart); const safeEnd = Math.min(deadlineDate, yearEnd); if (safeEnd < safeStart) return; const left = ((safeStart - yearStart) / yearDuration) * 100; const width = ((safeEnd - safeStart) / yearDuration) * 100; const colorClass = item.type === 'project' ? 'bg-blue-500' : 'bg-purple-500'; const row = document.createElement('div'); row.className = 'gantt-row'; let milestonesHtml = ''; if (item.roadmap) { item.roadmap.forEach(r => { const mDate = new Date(r.data).getTime(); if (mDate >= yearStart && mDate <= yearEnd) { const mPos = ((mDate - yearStart) / yearDuration) * 100; const mColor = item.type === 'project' ? 'bg-blue-400' : 'bg-purple-400'; const fmtDate = new Date(r.data + "T00:00:00").toLocaleDateString('pt-BR'); milestonesHtml += `<div class="gantt-milestone-wrapper" style="left: ${mPos}%"><div class="gantt-milestone-diamond ${mColor}"></div><div class="gantt-milestone-tooltip"><div class="font-bold text-emerald-300 mb-0.5 uppercase tracking-wider">${fmtDate}</div><div class="font-medium text-white text-[11px] leading-tight">${r.etapa}</div></div></div>`; } }); } row.innerHTML = `<div class="gantt-item-col"><div class="flex items-center gap-2 mb-1"><div class="w-1.5 h-1.5 rounded-full ${item.type === 'project' ? 'bg-blue-500' : 'bg-purple-500'}"></div><span class="text-[9px] font-black uppercase text-slate-400">${item.coord || 'N/A'}</span></div><div class="font-bold text-slate-700 text-xs truncate" title="${item.name}">${item.name}</div></div><div class="gantt-timeline-area"><div class="gantt-grid-col"></div><div class="gantt-grid-col"></div><div class="gantt-grid-col"></div><div class="gantt-grid-col"></div><div class="gantt-grid-col"></div><div class="gantt-grid-col"></div><div class="gantt-grid-col"></div><div class="gantt-grid-col"></div><div class="gantt-grid-col"></div><div class="gantt-grid-col"></div><div class="gantt-grid-col"></div><div class="gantt-grid-col" style="border:none"></div><div class="gantt-bar ${colorClass}" style="left: ${left}%; width: ${width}%;" onclick="editItem('${item.id}', '${item.type === 'project' ? 'projects' : 'contracts'}')"><span class="gantt-bar-label">${item.status}</span></div>${milestonesHtml}</div>`; container.appendChild(row); }); if (today >= yearStart && today <= yearEnd) { const todayPos = ((today - yearStart) / yearDuration) * 100; const line = document.createElement('div'); line.className = 'gantt-today-line'; line.style.left = `${todayPos}%`; line.innerHTML = `<div class="gantt-today-label">Hoje</div>`; container.appendChild(line); } };
        window.openAddBacklogItemModal = (meetingId) => { if(meetingId) selectedMeetingId = meetingId; const list = document.getElementById('backlogItemsListForModal'); list.innerHTML = ''; const emptyMsg = document.getElementById('emptyBacklogMsg'); emptyMsg.classList.add('hidden'); const meeting = dataStore.dispatchMeetings.find(m => m.id === selectedMeetingId); const existingIds = meeting ? new Set(meeting.items.map(i => i.itemId)) : new Set(); let count = 0; ['projects', 'contracts', 'operational'].forEach(col => { if(dataStore[col]) { dataStore[col].filter(i => i.onDispatch === true && !existingIds.has(i.id)).forEach(item => { count++; const originColor = { projects: 'bg-blue-100 text-blue-700 border-blue-200', contracts: 'bg-purple-100 text-purple-700 border-purple-200', operational: 'bg-orange-100 text-orange-700 border-orange-200' }[col]; const originLabel = { projects: 'PROJETO', contracts: 'CONTRATO', operational: 'OPERACIONAL' }[col]; const row = document.createElement('label'); row.className = "flex items-start gap-3 cursor-pointer bg-white p-3 rounded-xl border border-slate-200 shadow-sm hover:border-indigo-300 hover:shadow-md transition-all select-none group relative overflow-hidden"; row.innerHTML = `<div class="pt-1"><input type="checkbox" class="w-5 h-5 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500 transition-all backlog-add-checkbox" data-id="${item.id}" data-col="${col}" onchange="toggleBacklogItemStyle(this)"></div><div class="flex-1 min-w-0 z-10"><div class="flex items-center gap-2 mb-1.5"><span class="text-[9px] font-black uppercase px-2 py-0.5 rounded border ${originColor}">${originLabel}</span>${item.priority === 'Urgente' ? '<span class="bg-red-50 text-red-600 text-[9px] font-black uppercase px-1.5 py-0.5 rounded border border-red-100">Urgente</span>' : ''}</div><p class="text-sm font-bold text-slate-800 leading-tight group-hover:text-indigo-700 transition-colors">${item.name}</p><p class="text-xs text-slate-400 mt-1 truncate">${item.desc || 'Sem descrição'}</p></div>`; list.appendChild(row); }); } }); if(count === 0) { emptyMsg.classList.remove('hidden'); } toggleModal('addBacklogItemModal'); };
        window.toggleBacklogItemStyle = (cb) => { const card = cb.parentElement.parentElement; if(cb.checked) { card.classList.add('border-indigo-500', 'bg-indigo-50', 'ring-1', 'ring-indigo-500'); } else { card.classList.remove('border-indigo-500', 'bg-indigo-50', 'ring-1', 'ring-indigo-500'); } };
        window.addSelectedBacklogItems = async () => { const checkedBoxes = document.querySelectorAll('.backlog-add-checkbox:checked'); if(checkedBoxes.length === 0) { const btn = document.querySelector('#addBacklogItemModal button[onclick="addSelectedBacklogItems()"]'); const originalText = btn.innerHTML; btn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Selecione um item'; btn.classList.add('bg-red-500'); setTimeout(() => { btn.innerHTML = originalText; btn.classList.remove('bg-red-500'); }, 2000); return; } const meeting = dataStore.dispatchMeetings.find(m => String(m.id) === String(selectedMeetingId)); if(!meeting) return; const newItems = meeting.items ? [...meeting.items] : []; checkedBoxes.forEach(cb => { const id = cb.getAttribute('data-id'); const col = cb.getAttribute('data-col'); const realItem = dataStore[col]?.find(i => String(i.id) === String(id)); if(realItem) { const alreadyExists = newItems.some(existing => String(existing.itemId) === String(id)); if (!alreadyExists) { newItems.push({ itemId: id, collection: col, name: realItem.name, status: 'Pendente', outcome: '' }); } } }); try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dispatch_meetings', meeting.id), { items: newItems }, { merge: true }); toggleModal('addBacklogItemModal'); window.renderDespachos(); } catch(err) { console.error("Erro ao adicionar itens:", err); } };
        window.renderDespachos = () => { /* ... Render Despachos (igual ao anterior) ... */ 
            // Para manter concisão, mantendo a função que você já tem, ela não foi alterada, 
            // mas o createCardHtml abaixo É A ALTERAÇÃO PRINCIPAL.
            // Copiar lógica do renderDespachos do input anterior se precisar, mas ela já está lá em cima.
            // Vou focar apenas na alteração solicitada: createCardHtml
            // (Re-inserindo o código completo da função Render Despachos para garantir integridade)
            
            const meetingsList = document.getElementById('meetingsList'); meetingsList.innerHTML = ''; const sortedMeetings = (dataStore.dispatchMeetings || []).sort((a,b) => b.date.localeCompare(a.date)); if(sortedMeetings.length === 0) { meetingsList.innerHTML = '<p class="text-xs text-slate-400 italic text-center mt-4">Nenhuma pauta criada.</p>'; } sortedMeetings.forEach(meeting => { const isActive = meeting.id === selectedMeetingId; const [y, m, d] = meeting.date.split('-'); const pendingCount = meeting.items ? meeting.items.filter(i => i.status !== 'Deliberado' && i.status !== 'Retirado').length : 0; const statusLabel = pendingCount === 0 && meeting.items.length > 0 ? 'Concluída' : 'Em Aberto'; const statusClass = pendingCount === 0 && meeting.items.length > 0 ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600'; const card = document.createElement('div'); card.className = `meeting-card p-3 rounded-xl border mb-2 ${isActive ? 'active' : 'bg-white border-slate-200'}`; card.onclick = () => selectMeeting(meeting.id); card.innerHTML = `<div class="flex items-center gap-3"><div class="meeting-date-box rounded-lg p-2 text-center min-w-[50px] shrink-0 flex flex-col justify-center"><span class="text-[10px] font-black uppercase leading-none block mb-0.5">${['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'][parseInt(m)-1]}</span><span class="text-lg font-black leading-none">${d}</span></div><div class="flex-1 min-w-0"><h4 class="font-bold text-slate-800 text-sm truncate">${meeting.title || 'Reunião de Pauta'}</h4><div class="flex items-center gap-2 mt-1"><span class="text-[10px] font-black px-1.5 py-0.5 rounded uppercase ${statusClass}">${statusLabel}</span><span class="text-[10px] text-slate-400 font-bold">${meeting.items ? meeting.items.length : 0} itens</span></div></div></div>`; meetingsList.appendChild(card); });
            const headerTitle = document.getElementById('drTitle'); const headerSub = document.getElementById('drSubtitle'); const actionArea = document.getElementById('drActionArea'); const mainContent = document.getElementById('dispatchMainContent'); mainContent.innerHTML = ''; actionArea.innerHTML = '';
            if (!selectedMeetingId) { headerTitle.innerText = 'Painel de Preparação'; headerSub.innerText = 'Backlog de Itens Marcados'; headerSub.className = 'text-sm text-slate-500 font-bold mt-1 uppercase tracking-wider text-blue-600'; let backlogItems = []; ['projects', 'contracts', 'operational'].forEach(col => { if(dataStore[col]) { const items = dataStore[col].filter(i => i.onDispatch === true).map(i => ({...i, originCollection: col})); backlogItems = [...backlogItems, ...items]; } }); actionArea.innerHTML = `<button id="createMeetingBtn" onclick="openCreateMeetingModal()" disabled class="opacity-50 cursor-not-allowed bg-blue-600 text-white font-bold py-2 px-6 rounded-xl text-xs uppercase tracking-wide flex items-center gap-2 shadow-lg transition-all"><i class="fas fa-calendar-plus"></i> Gerar Pauta</button>`; if(backlogItems.length === 0) { mainContent.innerHTML = '<div class="flex flex-col items-center justify-center py-20 opacity-50"><i class="fas fa-inbox text-5xl mb-4 text-slate-300"></i><p class="text-slate-400 italic font-medium">Nenhum item marcado para despacho.</p></div>'; return; } backlogItems.forEach(item => { const originLabel = { projects: 'Projeto', contracts: 'Contrato', operational: 'Operacional' }[item.originCollection]; const originColor = { projects: 'bg-blue-100 text-blue-700', contracts: 'bg-purple-100 text-purple-700', operational: 'bg-orange-100 text-orange-700' }[item.originCollection]; const jsonVal = JSON.stringify({id: item.id, collection: item.originCollection}); const isChecked = selectedBacklogItems.has(JSON.stringify({id: item.id, collection: item.originCollection})); const row = document.createElement('div'); row.className = "bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-3 flex items-start gap-4 dispatch-item-row"; if(isChecked) row.classList.add('bg-blue-50', 'border-blue-200'); row.innerHTML = `<div class="pt-1"><input type="checkbox" class="w-5 h-5 text-blue-600 rounded border-slate-300 focus:ring-blue-500 dispatch-checkbox cursor-pointer" value='${jsonVal}' onchange="toggleBacklogSelection(this)" ${isChecked ? 'checked' : ''}></div><div class="flex-1"><div class="flex items-center gap-2 mb-1"><span class="text-[10px] font-black uppercase px-2 py-0.5 rounded ${originColor}">${originLabel}</span><div class="w-1.5 h-3 rounded-full ${window.getStatusColorBg(item.status)}"></div>${item.priority === 'Urgente' ? '<span class="bg-red-100 text-red-600 text-[10px] font-black uppercase px-2 py-0.5 rounded">Urgente</span>' : ''}</div><h4 class="font-bold text-slate-800 text-base">${item.name}</h4><p class="text-xs text-slate-500 mt-1 line-clamp-2">${item.desc || 'Sem descrição.'}</p></div><button onclick="event.stopPropagation(); toggleDispatch('${item.id}', '${item.originCollection}')" class="text-slate-300 hover:text-red-500 transition-colors" title="Remover do Backlog"><i class="fas fa-times-circle text-lg"></i></button>`; mainContent.appendChild(row); }); } else { const meeting = dataStore.dispatchMeetings.find(m => m.id === selectedMeetingId); if(!meeting) { selectedMeetingId = null; window.renderDespachos(); return; } headerTitle.innerText = meeting.title || 'Reunião de Pauta'; const [y, m, d] = meeting.date.split('-'); headerSub.innerText = `${d}/${m}/${y} • ${meeting.items ? meeting.items.length : 0} Itens`; headerSub.className = 'text-sm text-slate-500 font-bold mt-1 uppercase tracking-wider text-slate-600'; actionArea.innerHTML = `<div class="flex items-center gap-2"><button onclick="openAddBacklogItemModal('${meeting.id}')" class="text-indigo-600 hover:text-indigo-800 text-xs font-bold uppercase bg-indigo-50 border border-indigo-200 hover:bg-indigo-100 px-3 py-1.5 rounded-lg transition-all flex items-center gap-1 shadow-sm"><i class="fas fa-plus-circle"></i> Adicionar Itens</button><div class="w-px h-6 bg-slate-200 mx-1"></div><button onclick="openEditMeetingModal('${meeting.id}')" class="text-blue-600 hover:text-blue-800 text-xs font-bold uppercase bg-blue-50 border border-blue-200 hover:bg-blue-100 px-3 py-1.5 rounded-lg transition-all"><i class="fas fa-edit mr-1"></i> Editar</button><button onclick="deleteMeeting('${meeting.id}', this)" class="text-red-400 hover:text-red-600 text-xs font-bold uppercase border border-red-200 hover:bg-red-50 px-3 py-1.5 rounded-lg transition-all"><i class="fas fa-trash mr-1"></i> Excluir</button><button onclick="closeMeetingDetails()" class="text-slate-400 hover:text-slate-600 text-xs font-bold uppercase px-3 py-1.5"><i class="fas fa-arrow-left mr-1"></i> Voltar</button></div>`;
                if(!meeting.items || meeting.items.length === 0) { mainContent.innerHTML = `<p class="text-slate-400 italic text-center mt-10">Nenhum item nesta pauta.</p>`; } else {
                    meeting.items.forEach((item, idx) => { const liveItem = dataStore[item.collection]?.find(i => i.id === item.itemId) || {}; const originLabel = { projects: 'PROJETO', contracts: 'CONTRATO', operational: 'OPERACIONAL' }[item.collection] || item.collection; const originColor = { projects: 'bg-blue-100 text-blue-700', contracts: 'bg-purple-100 text-purple-700', operational: 'bg-orange-100 text-orange-700' }[item.collection] || 'bg-slate-100';
                        const row = document.createElement('div'); row.className = "bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-4 relative group";
                        row.innerHTML = `<div class="flex items-center justify-between mb-3 border-b border-slate-100 pb-2"><div class="flex items-center gap-2"><span class="text-[10px] font-black uppercase px-1.5 py-0.5 rounded ${originColor}">${originLabel}</span><span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded uppercase">${liveItem.coord || 'N/A'}</span>${liveItem.priority === 'Urgente' ? '<span class="text-[10px] font-black bg-red-100 text-red-600 px-1.5 py-0.5 rounded animate-pulse">URGENTE</span>' : ''}</div><div class="flex items-center gap-3"><span class="text-xs text-slate-400 font-bold uppercase">Item #${idx + 1}</span><button onclick="removeMeetingItem('${meeting.id}', ${idx})" class="text-slate-300 hover:text-red-500 transition-colors" title="Remover da Pauta"><i class="fas fa-minus-circle"></i></button></div></div><div class="mb-4"><h4 class="font-bold text-slate-800 text-lg mb-1">${item.name}</h4><p class="text-sm text-slate-600 leading-relaxed mb-3">${liveItem.desc || 'Sem descrição detalhada.'}</p><div class="grid grid-cols-2 gap-3 bg-slate-50 p-2 rounded-lg border border-slate-100"><div><p class="text-[10px] font-black text-slate-400 uppercase mb-0.5">Prazo / Status Atual</p><p class="text-sm font-bold text-slate-700 flex items-center gap-1"><i class="far fa-calendar text-[10px]"></i> ${liveItem.prazo ? new Date(liveItem.prazo + "T00:00:00").toLocaleDateString('pt-BR') : '--'} <span class="text-slate-300">|</span> <span class="${window.getStatusColor(liveItem.status || 'Backlog').split(' ')[0]}">${liveItem.status || 'Backlog'}</span></p></div><div><p class="text-[10px] font-black text-slate-400 uppercase mb-0.5">Gestor</p><p class="text-sm font-bold text-slate-700 truncate">${liveItem.manager || 'Não informado'}</p></div>${liveItem.risks ? `<div class="col-span-2 pt-1 mt-1 border-t border-red-100"><p class="text-[10px] font-black text-red-500 uppercase flex items-center gap-1"><i class="fas fa-exclamation-triangle mr-1"></i> Ponto de Atenção</p><p class="text-[10px] text-red-700 font-medium leading-tight">${liveItem.risks}</p></div>` : ''}</div></div><div class="mb-4 bg-slate-50 p-3 rounded-lg border border-slate-100 transition-colors hover:border-blue-200"><div class="flex justify-between items-center mb-2"><p class="text-[10px] font-black text-slate-400 uppercase flex items-center gap-2"><i class="fas fa-folder-open"></i> Materiais de Apoio</p><span class="text-[9px] font-bold text-slate-300 uppercase">${(item.docLinks || (item.docLink ? [item.docLink] : [])).length} Arquivos</span></div><div class="space-y-2 mb-3">${(item.docLinks || (item.docLink ? [item.docLink] : [])).map((link, linkIdx) => `<div class="flex items-center gap-2 bg-white p-2 rounded-lg border border-slate-200 shadow-sm group/link"><div class="w-6 h-6 rounded bg-blue-50 text-blue-500 flex items-center justify-center text-xs shrink-0"><i class="fas fa-link"></i></div><a href="${link}" target="_blank" class="flex-1 text-xs font-bold text-slate-600 truncate hover:text-blue-600 hover:underline" title="${link}">${link}</a><div class="flex items-center gap-1 opacity-100 sm:opacity-0 sm:group-hover/link:opacity-100 transition-opacity"><a href="${link}" target="_blank" class="w-6 h-6 rounded hover:bg-slate-100 text-slate-400 hover:text-blue-600 flex items-center justify-center transition-colors"><i class="fas fa-external-link-alt text-[10px]"></i></a><button onclick="removeMeetingItemDoc('${meeting.id}', ${idx}, ${linkIdx})" class="w-6 h-6 rounded hover:bg-red-50 text-slate-300 hover:text-red-500 flex items-center justify-center transition-colors" title="Remover Link"><i class="fas fa-times text-[10px]"></i></button></div></div>`).join('')}${(!item.docLinks && !item.docLink) || (item.docLinks && item.docLinks.length === 0) ? '<p class="text-[10px] text-slate-400 italic pl-1">Nenhum documento anexado.</p>' : ''}</div><div class="flex items-center gap-2 bg-white p-1.5 rounded-lg border border-slate-200 focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-300 transition-all shadow-sm"><i class="fas fa-plus text-slate-300 ml-1.5 text-xs"></i><input type="text" id="newDoc_${meeting.id}_${idx}" class="flex-1 bg-transparent border-none text-xs font-medium text-slate-600 placeholder-slate-400 focus:ring-0 p-1" placeholder="Adicionar novo link (Cole a URL e aperte Enter)..." onkeydown="if(event.key === 'Enter') { addMeetingItemDoc('${meeting.id}', ${idx}, this.value); }"><button onclick="addMeetingItemDoc('${meeting.id}', ${idx}, document.getElementById('newDoc_${meeting.id}_${idx}').value)" class="px-3 py-1 rounded-md bg-slate-100 text-slate-500 hover:bg-blue-600 hover:text-white text-[10px] font-bold uppercase transition-colors">Adicionar</button></div></div><div class="bg-blue-50/50 rounded-lg p-3 border border-blue-100"><div class="flex justify-between items-center mb-2"><label class="text-xs font-black text-blue-700 uppercase flex items-center gap-1"><i class="fas fa-pen-nib"></i> Deliberação / Encaminhamento</label><div class="flex items-center gap-2"><span class="text-[10px] font-bold uppercase text-slate-400">Status na Pauta:</span><select onchange="saveMeetingItemStatus('${meeting.id}', ${idx}, this.value)" class="text-xs font-bold bg-white border border-slate-200 rounded px-1 py-0.5 outline-none text-slate-700 cursor-pointer"><option value="Pendente" ${item.status === 'Pendente' ? 'selected' : ''}>Pendente</option><option value="Deliberado" ${item.status === 'Deliberado' ? 'selected' : ''}>Deliberado</option><option value="Retirado" ${item.status === 'Retirado' ? 'selected' : ''}>Retirado</option></select></div></div><textarea id="outcome_${meeting.id}_${idx}" rows="3" class="w-full bg-white border border-blue-200 rounded-lg p-2.5 text-sm text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-200 resize-none shadow-sm mb-2" placeholder="Registre a decisão, responsáveis e prazos definidos na reunião..." onblur="saveMeetingItemOutcome('${meeting.id}', ${idx}, this.value)">${item.outcome || ''}</textarea><div class="flex justify-end"><button onclick="saveMeetingItemOutcome('${meeting.id}', ${idx}, document.getElementById('outcome_${meeting.id}_${idx}').value, this)" class="text-[10px] font-bold uppercase bg-blue-100 text-blue-600 hover:bg-blue-200 px-3 py-1.5 rounded transition-colors flex items-center shadow-sm"><i class="fas fa-save mr-1"></i> Salvar Escrita</button></div></div>`;
                        mainContent.appendChild(row); }); } }
        };

        
        // ===== Indicadores: estado de filtros =====
        let indicatorSearchQuery = '';
        let indicatorTypeFilter = 'all';
        let indicatorProductFilter = 'all';
        let indicatorSort = 'name';

        function calcIndicatorTotal(ind) {
            const monthly = Array.isArray(ind.monthly) ? ind.monthly : Array.from({length:12},()=>0);
            if (ind.rule === 'Soma') {
                return monthly.reduce((a, b) => a + Number(b || 0), 0);
            }
            const filled = monthly.map(v => Number(v || 0)).filter(v => v != 0);
            return filled.length > 0 ? filled[filled.length - 1] : 0;
        }

        window.renderIndicators = () => {
            const listPPA = document.getElementById('indicatorsList');
            const listOther = document.getElementById('otherIndicatorsList');
            const emptyState = document.getElementById('indicatorsEmpty');
            const countEl = document.getElementById('indicatorCount');
            const productSelect = document.getElementById('indicatorProductFilter');

            if (!listPPA || !listOther) return;

            const allData = (dataStore.indicators && dataStore.indicators.length > 0)
                ? dataStore.indicators
                : (Array.isArray(INITIAL_INDICATORS) ? INITIAL_INDICATORS : []);

            // Normaliza minimamente (evita quebra por campos ausentes)
            const normalized = allData.map(ind => normalizeIndicator({ ...ind }));
            // Dedupe por id (protege contra duplicidade no estado e/ou ids sobrescritos)
            const uniqueById = Array.from(new Map(normalized.map(i => [i.id, i])).values());

            // Monta opções de produtos (uma vez por render)
            if (productSelect) {
                const products = Array.from(new Set(normalized.map(i => (i.product || 'Sem produto').toString().trim()).filter(Boolean)))
                    .sort((a,b) => a.localeCompare(b, 'pt-BR'));
                const current = productSelect.value || 'all';
                productSelect.innerHTML = '<option value="all">Todos os produtos</option>' + products.map(p => `<option value="${p.replace(/"/g,'&quot;')}">${p}</option>`).join('');
                // preserva seleção
                if ([...productSelect.options].some(o => o.value === current)) productSelect.value = current;
            }

            const q = (indicatorSearchQuery || '').trim().toLowerCase();

            let filtered = uniqueById.filter(ind => {
                const matchesType = (indicatorTypeFilter === 'all')
                    ? true
                    : (indicatorTypeFilter === 'ppa' ? ind.type === 'ppa' : ind.type !== 'ppa');

                const prod = (ind.product || 'Sem produto').toString().trim();
                const matchesProduct = (indicatorProductFilter === 'all') ? true : prod === indicatorProductFilter;

                const hay = `${ind.name || ''} ${ind.product || ''} ${ind.unit || ''} ${ind.code || ''}`.toLowerCase();
                const matchesSearch = q ? hay.includes(q) : true;

                return matchesType && matchesProduct && matchesSearch;
            });

            // Ordenação
            filtered.sort((a,b) => {
                if (indicatorSort === 'progress') {
                    const pa = (Number(a.meta || 0) > 0) ? (calcIndicatorTotal(a) / Number(a.meta || 0)) : 0;
                    const pb = (Number(b.meta || 0) > 0) ? (calcIndicatorTotal(b) / Number(b.meta || 0)) : 0;
                    return pb - pa;
                }
                if (indicatorSort === 'meta') {
                    return Number(b.meta || 0) - Number(a.meta || 0);
                }
                return (a.name || '').localeCompare((b.name || ''), 'pt-BR');
            });

            listPPA.innerHTML = '';
            listOther.innerHTML = '';

            let shown = 0;

            filtered.forEach(ind => {
                const total = calcIndicatorTotal(ind);
                const meta = Number(ind.meta || 0);
                const formattedTotal = Number(total || 0).toLocaleString('pt-BR', { maximumFractionDigits: 2 });
                const formattedMeta = meta.toLocaleString('pt-BR', { maximumFractionDigits: 2 });
                const percent = meta > 0 ? Math.round((total / meta) * 100) : 0;

                const monthsHtml = (ind.monthly || Array.from({length:12},()=>0)).map((v, i) => {
                    const mName = ['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEZ'][i];
                    return `<div class="month-cell"><div class="month-label">${mName}</div><div class="month-value">${Number(v || 0).toLocaleString('pt-BR')}</div></div>`;
                }).join('');

                let ppaHtml = '';
                if (ind.ppa && Object.keys(ind.ppa).length > 0) {
                    const years = Object.keys(ind.ppa).sort();
                    ppaHtml = `<div class="mt-5 pt-4 border-t border-slate-100"><p class="text-[11px] font-black text-slate-400 uppercase mb-2 tracking-widest">Evolução Anual</p><div class="grid grid-cols-4 gap-2">${years.map(year => {
                        const isCurrent = year === '2026';
                        const metaVal = Number(ind.ppa?.[year] ?? 0);
                        const realVal = (ind.ppaRealized && ind.ppaRealized[year] != null) ? Number(ind.ppaRealized[year]) : null;
                        let displayVal = metaVal.toLocaleString('pt-BR');
                        if (realVal !== null && year !== '2026') {
                            displayVal = `<span class="text-[10px] text-slate-400 block">Meta: ${metaVal}</span><span class="text-pink-600 font-black">${realVal}</span>`;
                        } else if (year === '2025') {
                            displayVal = `<span class="text-[10px] text-slate-400 block">Meta</span><span class="text-slate-600 font-bold">${metaVal}</span>`;
                        }
                        return `<div class="ppa-year-box ${isCurrent ? 'current' : ''}"><div class="ppa-year-label">${year}</div><div class="ppa-year-value">${displayVal}</div></div>`;
                    }).join('')}</div></div>`;
                }

                const badge = ind.type === 'ppa'
                    ? `<span class="text-[11px] font-black text-pink-500 uppercase tracking-widest block mb-1">PPA</span>`
                    : `<span class="text-[11px] font-black text-indigo-500 uppercase tracking-widest block mb-1">OUTRO</span>`;

                const productLine = `<span class="text-[11px] font-black ${ind.type === 'ppa' ? 'text-pink-500' : 'text-indigo-500'} uppercase tracking-widest block mb-1">Produto ${ind.code || ''} <span class="text-slate-400">|</span> ${(ind.product || '').toString()}</span>`;

                const cardHtml = `
                    <div class="indicator-card" onclick="openIndicatorModal('${ind.id}')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                ${productLine}
                                <h4 class="font-bold text-slate-800 text-lg leading-tight">${ind.name || 'Indicador'}</h4>
                            </div>
                            <div class="text-right">
                                <span class="text-[11px] font-black text-slate-400 uppercase">${ind.rule === 'Soma' ? 'Acumulado' : 'Último'}</span>
                                <p class="text-2xl font-black ${ind.type === 'ppa' ? 'text-pink-700' : 'text-indigo-700'} leading-none">${formattedTotal} <span class="text-sm text-slate-400">${ind.unit || ''}</span></p>
                            </div>
                        </div>
                        <div class="mb-5">
                            <div class="flex justify-between text-[11px] font-bold text-slate-500 uppercase mb-1">
                                <span>Progresso da Meta (2026)</span>
                                <span>${percent}% de ${formattedMeta} ${ind.unit || ''}</span>
                            </div>
                            <div class="progress-bg">
                                <div class="progress-fill" style="width: ${Math.min(percent, 100)}%; background-color: ${ind.type === 'ppa' ? '#db2777' : '#4f46e5'};"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-6 gap-2">${monthsHtml}</div>
                        ${ppaHtml}
                    </div>
                `;

                if (ind.type === 'ppa') listPPA.insertAdjacentHTML('beforeend', cardHtml);
                else listOther.insertAdjacentHTML('beforeend', cardHtml);
                shown += 1;
            });

            if (countEl) countEl.textContent = String(shown);

            const hasAny = shown > 0;
            if (emptyState) emptyState.classList.toggle('hidden', hasAny);
        };

        /* ===================== INDICADORES: ABRIR / EDITAR / SALVAR ===================== */
        let selectedIndicatorId = null;

        const MONTHS = ['JAN','FEV','MAR','ABR','MAI','JUN','JUL','AGO','SET','OUT','NOV','DEZ'];

        function normalizeIndicator(ind) {
            // Garante estruturas mínimas para evitar erro ao editar/salvar
            if (!ind.monthly || !Array.isArray(ind.monthly) || ind.monthly.length !== 12) {
                ind.monthly = Array.from({ length: 12 }, (_, i) => Number(ind.monthly?.[i] || 0));
            }
            if (!ind.monthly_2025 || !Array.isArray(ind.monthly_2025) || ind.monthly_2025.length !== 12) {
                ind.monthly_2025 = Array.from({ length: 12 }, (_, i) => Number(ind.monthly_2025?.[i] || 0));
            }

            // PPA só existe para indicadores do tipo 'ppa'
            if (ind.type === "ppa") {
                if (!ind.ppa || typeof ind.ppa !== 'object') ind.ppa = { '2026': Number(ind.meta || 0) };
                if (!ind.ppaRealized || typeof ind.ppaRealized !== 'object') ind.ppaRealized = {};
            } else {
                ind.ppa = {};
                ind.ppaRealized = {};
            }

            return ind;
        }

        window.openIndicatorModal = (id) => {
            const list = (dataStore.indicators && dataStore.indicators.length > 0) ? dataStore.indicators : INITIAL_INDICATORS;
            const found = list.find(x => x.id === id);
            if (!found) { console.warn('Indicador não encontrado:', id); return; }

            const ind = normalizeIndicator(found);
            selectedIndicatorId = ind.id;

            // Cabeçalho
            document.getElementById('indId').value = ind.id;
            document.getElementById('indNameDisplay').innerText = ind.name || 'Indicador';
            document.getElementById('indMetaDisplay').innerText = (Number(ind.meta || 0)).toLocaleString('pt-BR', { maximumFractionDigits: 2 });

            // Seções condicionais
            const ppaSection = document.getElementById('indPpaSection');
            const ppaGrid = document.getElementById('indPpaGrid');
            const months2025Wrapper = document.getElementById('indMonths2025Wrapper');
            const monthsGrid2025 = document.getElementById('indMonthsGrid2025');

            // PPA
            const hasPpa = ind.type === 'ppa';
            if (hasPpa) {
                ppaSection.classList.remove('hidden');
                ppaGrid.innerHTML = '';
                const years = Array.from(new Set([ ...Object.keys(ind.ppa || {}), ...Object.keys(ind.ppaRealized || {}) ]))
                    .sort();
                years.forEach(y => {
                    const metaVal = Number(ind.ppa?.[y] ?? 0);
                    const realizedVal = (y !== '2026') ? Number(ind.ppaRealized?.[y] ?? 0) : null;

                    const box = document.createElement('div');
                    box.className = 'bg-white rounded-xl border border-slate-200 p-3';
                    box.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[10px] font-black uppercase tracking-widest text-slate-400">${y}</span>
                            ${y === '2026' ? '<span class="text-[10px] font-black uppercase tracking-widest text-pink-600">Meta</span>' : '<span class="text-[10px] font-black uppercase tracking-widest text-slate-500">Meta / Realizado</span>'}
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase">Meta</label>
                                <input type="number" step="any" data-ppa-year="${y}" class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg p-2 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-pink-100" value="${metaVal}">
                            </div>
                            ${y === '2026' ? '<div class="opacity-50"><label class="text-[10px] font-black text-slate-400 uppercase">Realizado</label><div class="w-full mt-1 bg-slate-100 border border-slate-200 rounded-lg p-2 text-sm font-bold text-slate-400">(editável em 2025)</div></div>' : `
                            <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase">Realizado</label>
                                <input type="number" step="any" data-ppa-real-year="${y}" class="w-full mt-1 bg-slate-50 border border-slate-200 rounded-lg p-2 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-pink-100" value="${realizedVal}">
                            </div>`}
                        </div>
                    `;
                    ppaGrid.appendChild(box);
                });
            } else {
                ppaSection.classList.add('hidden');
                ppaGrid.innerHTML = '';
            }

            // Lançamento 2025 (histórico)
            if (months2025Wrapper) {
                months2025Wrapper.classList.remove('hidden');
                monthsGrid2025.innerHTML = '';
                MONTHS.forEach((m, idx) => {
                    const v = Number(ind.monthly_2025[idx] || 0);
                    const cell = document.createElement('div');
                    cell.className = 'bg-white rounded-xl border border-indigo-200 p-3 shadow-sm';
                    cell.innerHTML = `
                        <div class="text-[10px] font-black text-indigo-600 uppercase tracking-widest mb-1">${m}</div>
                        <input type="number" step="any" data-month-2025="${idx}" class="w-full bg-indigo-50 border border-indigo-200 rounded-lg p-2 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-100" value="${v}">
                    `;
                    monthsGrid2025.appendChild(cell);
                });
            }

            // Lançamento 2026 (realizado)
            const monthsGrid = document.getElementById('indMonthsGrid');
            monthsGrid.innerHTML = '';
            MONTHS.forEach((m, idx) => {
                const v = Number(ind.monthly[idx] || 0);
                const cell = document.createElement('div');
                cell.className = 'bg-white rounded-xl border border-slate-200 p-3 shadow-sm';
                cell.innerHTML = `
                    <div class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">${m}</div>
                    <input type="number" step="any" data-month="${idx}" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-pink-100" value="${v}">
                `;
                monthsGrid.appendChild(cell);
            });

            // Botão excluir aparece apenas se for doc do Firestore (tem id)
            const delBtn = document.getElementById('btnDeleteIndicator');
            if (delBtn) delBtn.classList.remove('hidden');

            toggleModal('indicatorModal');
        };

        window.saveIndicator = async () => {
            const id = selectedIndicatorId || document.getElementById('indId').value;
            if (!id) { alert('Não foi possível identificar o indicador.'); return; }

            const list = (dataStore.indicators && dataStore.indicators.length > 0) ? dataStore.indicators : INITIAL_INDICATORS;
            const ind = normalizeIndicator({ ...(list.find(x => x.id === id) || {}) });

            // 2026
            document.querySelectorAll('#indMonthsGrid input[data-month]').forEach(inp => {
                const idx = Number(inp.getAttribute('data-month'));
                const val = Number(String(inp.value).replace(',', '.'));
                ind.monthly[idx] = isNaN(val) ? 0 : val;
            });

            // 2025
            document.querySelectorAll('#indMonthsGrid2025 input[data-month-2025]').forEach(inp => {
                const idx = Number(inp.getAttribute('data-month-2025'));
                const val = Number(String(inp.value).replace(',', '.'));
                ind.monthly_2025[idx] = isNaN(val) ? 0 : val;
            });

            // PPA
            document.querySelectorAll('#indPpaGrid input[data-ppa-year]').forEach(inp => {
                const year = inp.getAttribute('data-ppa-year');
                const val = Number(String(inp.value).replace(',', '.'));
                if (!ind.ppa) ind.ppa = {};
                ind.ppa[year] = isNaN(val) ? 0 : val;
            });
            document.querySelectorAll('#indPpaGrid input[data-ppa-real-year]').forEach(inp => {
                const year = inp.getAttribute('data-ppa-real-year');
                const val = Number(String(inp.value).replace(',', '.'));
                if (!ind.ppaRealized) ind.ppaRealized = {};
                ind.ppaRealized[year] = isNaN(val) ? 0 : val;
            });

            // Persistência no Firestore
            try {
                await setDoc(
                    doc(db, 'artifacts', appId, 'public', 'data', 'indicators', id),
                    {
                        ...ind,
                        id,
                        updatedAt: new Date().toISOString(),
                    },
                    { merge: true }
                );
                toggleModal('indicatorModal');
            } catch (err) {
                console.error('Erro ao salvar indicador:', err);
                alert('Erro ao salvar no Firebase. Veja o console.');
            }
        };

        window.deleteIndicator = async () => {
            const id = selectedIndicatorId || document.getElementById('indId').value;
            if (!id) return;
            if (!confirm('Excluir este indicador? Essa ação não pode ser desfeita.')) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'indicators', id));
                toggleModal('indicatorModal');
            } catch (err) {
                console.error('Erro ao excluir indicador:', err);
                alert('Erro ao excluir no Firebase. Veja o console.');
            }
        };

        /* =================== FIM: INDICADORES: ABRIR / EDITAR / SALVAR =================== */

        function showCharts(showCards, showStatusChart) { /* ... same as before ... */ 
            const statsRow1 = document.getElementById('statsRow1'); const chartsSection = document.getElementById('chartsSection'); const statusChartWrapper = document.getElementById('statusChartWrapper'); const priorityChartWrapper = document.getElementById('priorityChartWrapper'); const statusLegend = document.getElementById('statusLegendContainer'); if(showCards) { statsRow1.classList.remove('hidden'); chartsSection.classList.remove('hidden'); chartsSection.className = "bg-white p-5 rounded-2xl border border-slate-200 shadow-sm transition-all duration-500 gap-4 chart-legend-container flex-col sm:flex-row w-full xl:w-auto xl:min-w-[320px] xl:max-w-[420px] shrink-0 flex"; statusChartWrapper.classList.add('hidden'); priorityChartWrapper.classList.remove('hidden', 'sm:pl-3'); statusLegend.className = "grid grid-cols-2 gap-x-2 gap-y-1 justify-center w-full"; } else { statsRow1.classList.add('hidden'); chartsSection.classList.remove('hidden'); chartsSection.className = "flex w-full bg-white p-5 rounded-2xl border border-slate-200 shadow-sm gap-4 chart-legend-container flex-col sm:flex-row"; statusChartWrapper.classList.remove('hidden'); priorityChartWrapper.classList.remove('hidden'); priorityChartWrapper.classList.add('sm:pl-3'); statusLegend.className = "flex flex-wrap justify-center gap-3 w-full mt-2"; }
        }

        window.renderData = () => {
            if (activeTab === 'calendar') { window.renderCalendar(); return; }
            if (activeTab === 'portaria') { window.renderPortaria(); return; }
            if (activeTab === 'indicators') { window.renderIndicators(); return; }
            if (activeTab === 'despachos') { window.renderDespachos(); return; }

            const container = document.getElementById('projectsList');
            const search = document.getElementById('searchInput').value.toLowerCase();
            container.innerHTML = '';
            let filtered = dataStore[activeTab] || [];
            
            if(search) filtered = filtered.filter(i => i.name && i.name.toLowerCase().includes(search));
            if(currentFilter !== 'all') filtered = filtered.filter(i => i.coord === currentFilter);
            if(activeTab === 'operational') { const serviceFilter = document.getElementById('filterService').value; if(serviceFilter !== 'all') { filtered = filtered.filter(i => { const s = i.services || (i.service ? [i.service] : []); return s.includes(serviceFilter); }); } }
            if(currentPriorityFilter !== 'all') filtered = filtered.filter(i => i.priority === currentPriorityFilter);
            
            const statusList = (activeTab === 'projects') ? PROJECT_STATUS : (activeTab === 'contracts' ? CONTRACT_STATUS : UNIFIED_STATUS);
            const counts = {}; statusList.forEach(s => counts[s] = 0);
            filtered.forEach(item => { if(counts[item.status] !== undefined) counts[item.status]++; });
            document.getElementById('statTotal').innerText = filtered.length;
            const map = {'Backlog':'statBacklog','Iniciado':'statIniciado','Em Planejamento':'statPlanejado','Crítico':'statCritico','Concluído':'statConcluido'};
            Object.keys(map).forEach(k => { if(document.getElementById(map[k])) document.getElementById(map[k]).innerText = counts[k]; });
            document.getElementById('statExecDP').innerText = counts['Em Execução (Dentro do Planejado)']; document.getElementById('statExecEA').innerText = counts['Em Execução (Atenção)']; document.getElementById('statExecRA').innerText = counts['Em Execução (Em Risco / Atrasado)'];
            if (document.getElementById('statCancelado')) document.getElementById('statCancelado').innerText = counts['Cancelado'] || 0;
            if (activeTab === 'contracts') {
                let totalResource = 0;
                let rv1Sum = 0;
                let rv3Sum = 0;

                const parseCurrency = (val) => {
                    if (val === null || val === undefined) return 0;
                    const s = val.toString().trim();
                    if (!s) return 0;
                    // Aceita "R$ 1.234,56", "1234,56", "1234.56"
                    let clean = s.replace(/[^0-9,.-]/g, '');
                    // Se tiver vírgula como decimal (pt-BR), remove separadores de milhar
                    if (clean.includes(',')) {
                        clean = clean.replace(/\./g, '').replace(',', '.');
                    }
                    const n = parseFloat(clean);
                    return isNaN(n) ? 0 : n;
                };

                filtered.forEach(item => {
                    const val = parseCurrency(item.resourceValue);

                    // Total geral (todos contratos/convênios com recurso)
                    totalResource += val;

                    // Totais por componente do programa Respeito à Vida
                    if (item.program === 'Respeito à Vida') {
                        if (item.programComponent === '1') rv1Sum += val;
                        if (item.programComponent === '3') rv3Sum += val;
                    }
                });

                document.getElementById('statResource').innerHTML =
                    `<span class="text-xl sm:text-2xl text-slate-400 mr-2 align-middle">R$</span>${totalResource.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;

                if (document.getElementById('statRV1')) {
                    document.getElementById('statRV1').innerHTML =
                        `<span class="text-xl sm:text-2xl text-slate-400 mr-2 align-middle">R$</span>${rv1Sum.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                }
                if (document.getElementById('statRV3')) {
                    document.getElementById('statRV3').innerHTML =
                        `<span class="text-xl sm:text-2xl text-slate-400 mr-2 align-middle">R$</span>${rv3Sum.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
                }
            }
            if(currentListFilter !== 'all') filtered = filtered.filter(i => i.status === currentListFilter);
            // Ordenação de Projetos (PMG + Concluídos no final)
            // Regra:
            // 1) Projetos NÃO concluídos primeiro
            // 2) Dentro disso, ordena por PMG (G=Alta, M=Média, P=Baixa)
            // 3) Desempate por nome
            if (activeTab === 'projects') {
                const pmgOrder = { 'Alta': 0, 'Média': 1, 'Baixa': 2 };
                const isDone = (it) => (it && it.status === 'Concluído');
                filtered = [...filtered].sort((a, b) => {
                    const da = isDone(a), db = isDone(b);
                    if (da !== db) return da ? 1 : -1;
                    const oa = pmgOrder[a?.complexity] ?? 99;
                    const ob = pmgOrder[b?.complexity] ?? 99;
                    if (oa !== ob) return oa - ob;
                    return (a?.name || '').localeCompare((b?.name || ''), 'pt-BR', { sensitivity: 'base' });
                });
            }

            
            // ... (Lógica charts status mantida) ...
            const total = filtered.length || 1;
            if (!document.getElementById('statusChartWrapper').classList.contains('hidden')) { let ca = 0, gs = 'conic-gradient(', lh = ''; statusList.forEach((st) => { const c = counts[st], p = (c / total) * 100, color = STATUS_COLORS_HEX[st]; if (c > 0) { gs += `${color} ${ca}% ${ca + p}%, `; ca += p; } lh += `<div onclick="setListFilter('${st}')" class="chart-legend-item flex items-center gap-2 text-[10px] font-bold text-slate-600 uppercase cursor-pointer mb-1 ${currentListFilter === st ? 'active-legend' : ''}"><span class="w-2 h-2 rounded-full ${STATUS_COLORS_TW_BG[st]} shrink-0"></span> <span class="truncate">${st.replace('Em Execução ', '')} (${c})</span></div>`; }); document.getElementById('statusChart').style.background = (total === 0 || filtered.length === 0) ? '#e2e8f0' : gs.slice(0, -2) + ')'; document.getElementById('statusLegendContainer').innerHTML = lh; }
            if (!document.getElementById('priorityChartWrapper').classList.contains('hidden')) { const urg = filtered.filter(p => p.priority === 'Urgente').length, high = filtered.filter(p => p.priority === 'Alta').length, mid = filtered.filter(p => p.priority === 'Média').length; const pU = Math.round((urg/total)*100), pH = Math.round((high/total)*100), pM = Math.round((mid/total)*100); document.getElementById('priorityChart').style.background = `conic-gradient(#ef4444 0% ${pU}%, #f97316 ${pU}% ${pU+pH}%, #eab308 ${pU+pH}% ${pU+pH+pM}%, #22c55e ${pU+pH+pM}% 100%)`; document.getElementById('count-prio-urg').innerText = `(${urg})`; document.getElementById('count-prio-high').innerText = `(${high})`; document.getElementById('count-prio-mid').innerText = `(${mid})`; document.getElementById('count-prio-low').innerText = `(${filtered.filter(p => p.priority === 'Baixa').length})`; }
            
            const today = new Date().toISOString().split('T')[0];

            if (activeTab === 'projects') {
                container.className = "grid grid-cols-1 lg:grid-cols-3 gap-6";
                const cols = {
                    'Alta': { label: 'Alta Complexidade (Estratégico)', class: 'pmg-g', tag: 'tag-g', letter: 'G', items: [] },
                    'Média': { label: 'Média Complexidade (Tático)', class: 'pmg-m', tag: 'tag-m', letter: 'M', items: [] },
                    'Baixa': { label: 'Baixa Complexidade (Rotina)', class: 'pmg-p', tag: 'tag-p', letter: 'P', items: [] }
                };
                filtered.forEach(item => { const comp = item.complexity || 'Média'; if(cols[comp]) cols[comp].items.push(item); else cols['Média'].items.push(item); });
                Object.keys(cols).forEach(key => {
                    const col = cols[key];
                    const colDiv = document.createElement('div');
                    colDiv.className = "pmg-column";
                    const listHtml = col.items.map(item => createCardHtml(item, today)).join('');
                    colDiv.innerHTML = `<div class="pmg-header ${col.class}"><span>${col.label}</span><span class="w-7 h-7 rounded-lg flex items-center justify-center bg-white border font-black ${col.class}">${col.letter}</span></div><div class="space-y-4">${listHtml || '<p class="text-xs text-slate-400 italic text-center py-4">Nenhum projeto.</p>'}</div>`;
                    container.appendChild(colDiv);
                });
            } else {
                container.className = "space-y-6";
                if (activeTab === 'contracts') {
                    const rv1Items = filtered.filter(i => i.program === 'Respeito à Vida' && i.programComponent === '1');
                    const rv3Items = filtered.filter(i => i.program === 'Respeito à Vida' && i.programComponent === '3');
                    const otherItems = filtered.filter(i => !(i.program === 'Respeito à Vida' && (i.programComponent === '1' || i.programComponent === '3')));

                    const makeSection = (title, subtitle, items) => {
                        const wrap = document.createElement('div');
                        wrap.className = "space-y-3";
                        wrap.innerHTML = `
                            <div class="flex items-end justify-between">
                                <div>
                                    <h3 class="text-xs font-black uppercase tracking-widest text-slate-600">${title}</h3>
                                    <p class="text-xs text-slate-400">${subtitle}</p>
                                </div>
                                <span class="text-xs font-black text-slate-500 bg-white border border-slate-200 rounded-lg px-3 py-1">${items.length}</span>
                            </div>
                            <div class="space-y-4"></div>
                        `;
                        const list = wrap.querySelector('div.space-y-4');
                        if (items.length === 0) {
                            const empty = document.createElement('div');
                            empty.className = "text-xs text-slate-400 italic text-center py-4 bg-white rounded-2xl border border-slate-200";
                            empty.innerText = "Nenhum registro nesta seção.";
                            list.appendChild(empty);
                        } else {
                            items.forEach(item => {
                                const row = document.createElement('div');
                                row.innerHTML = createCardHtml(item, today);
                                list.appendChild(row.firstElementChild);
                            });
                        }
                        container.appendChild(wrap);
                    };

                    makeSection('Respeito à Vida — Componente 1', 'Convênios/contratos vinculados ao Componente 1', rv1Items);
                    makeSection('Respeito à Vida — Componente 3', 'Convênios/contratos vinculados ao Componente 3', rv3Items);
                    makeSection('Demais Contratos/Convênios', 'Outros registros', otherItems);
                } else {
                    filtered.forEach(item => {
                        const row = document.createElement('div');
                        row.innerHTML = createCardHtml(item, today);
                        container.appendChild(row.firstElementChild);
                    });
                }
            }};

        // Função auxiliar para criar HTML do card (ATUALIZADA COM RASCI)
        function createCardHtml(item, today) {
            const sortedRoadmap = (item.roadmap || []).sort((a,b) => a.data.localeCompare(b.data));
            const roadmapHtml = sortedRoadmap.length > 0 ? `<div class="mt-4 pt-4 border-t border-slate-100"><p class="text-[11px] font-black text-slate-400 uppercase mb-3">Roadmap</p><div class="space-y-3 relative before:absolute before:left-[5px] before:top-2 before:bottom-2 before:w-0.5 before:bg-slate-200">` + sortedRoadmap.map(r => { const isPast = r.data < today; const dotClass = isPast ? 'bg-slate-300' : 'bg-blue-500 ring-4 ring-blue-100'; const dateClass = isPast ? 'text-slate-400' : 'text-blue-600 font-black'; const textClass = isPast ? 'text-slate-400 line-through decoration-slate-300' : 'text-slate-700 font-bold'; return `<div class="flex items-start gap-4 relative z-10 pl-1"><div class="w-2.5 h-2.5 rounded-full ${dotClass} mt-1.5 shrink-0"></div><div class="flex-1"><p class="text-[11px] ${dateClass}">${new Date(r.data + "T00:00:00").toLocaleDateString('pt-BR')}</p><p class="text-xs ${textClass}">${r.etapa}</p></div></div>`; }).join('') + `</div></div>` : `<div class="mt-4 pt-4 border-t border-slate-100"><p class="text-[11px] font-black text-slate-400 uppercase mb-1">Roadmap</p><p class="text-xs text-slate-400 italic">Nenhum marco.</p></div>`;
            const respectBadge = (activeTab === 'contracts' && item.program === 'Respeito à Vida' && (item.programComponent === '1' || item.programComponent === '3'))
                ? `<span class=\"ml-2 px-2 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider bg-purple-50 text-purple-700 border border-purple-100\">Respeito à Vida — C${item.programComponent}</span>`
                : '';

            const complexityTag = item.complexity ? `<span class="pmg-tag ${item.complexity === 'Alta' ? 'tag-g' : (item.complexity === 'Baixa' ? 'tag-p' : 'tag-m')} ml-2" title="Complexidade">${item.complexity === 'Alta' ? 'G' : (item.complexity === 'Baixa' ? 'P' : 'M')}</span>` : '';

            // --- LÓGICA DE INTEGRAÇÃO OPERACIONAL ---
            let operationalHtml = '';
            if (activeTab === 'projects' || activeTab === 'contracts') {
                const linkedOps = (dataStore.operational || []).filter(op => op.projRelation === item.id);
                if (linkedOps.length > 0) {
                    operationalHtml = `<div class="mt-4 pt-4 border-t border-slate-100 -mx-5 px-5 bg-orange-50/40 pb-2"><div class="flex items-center gap-2 mb-3 mt-1"><i class="fas fa-network-wired text-orange-400 text-xs"></i><p class="text-[10px] font-black text-orange-400 uppercase tracking-wider">Desdobramento Operacional (${linkedOps.length})</p></div><div class="grid grid-cols-1 gap-2">${linkedOps.map(op => { const opServices = op.services || (op.service ? [op.service] : ['N/A']); const badges = opServices.map(s => `<span class="px-1.5 py-0.5 rounded bg-orange-100 text-orange-700 text-[9px] font-black uppercase border border-orange-200">${s}</span>`).join(''); return `<div class="flex items-center justify-between bg-white border border-orange-100 p-2.5 rounded-lg shadow-sm hover:border-orange-300 transition-colors cursor-default"><div class="flex items-center gap-2.5 overflow-hidden"><div class="w-2 h-2 rounded-full ${window.getStatusColorBg(op.status)} shrink-0"></div><div class="flex-1 min-w-0"><p class="text-xs font-bold text-slate-700 truncate">${op.name}</p><div class="flex flex-wrap gap-1 mt-0.5">${badges}</div></div></div><span class="text-[9px] font-bold uppercase ${window.getStatusColor(op.status).split(' ')[0]} bg-slate-50 px-2 py-0.5 rounded border border-slate-100">${op.status}</span></div>`}).join('')}</div></div>`;
                }
            }

            // --- LÓGICA DA MATRIZ RASCI (NOVO BLOCO) ---
            let rasciHtml = '';
            if (item.rasci) {
                const roles = {
                    r: { label: 'R', title: 'Responsável', class: 'bg-blue-100 text-blue-700 border-blue-200' },
                    a: { label: 'A', title: 'Aprovador', class: 'bg-red-100 text-red-700 border-red-200' },
                    s: { label: 'S', title: 'Suporte', class: 'bg-orange-100 text-orange-700 border-orange-200' },
                    c: { label: 'C', title: 'Consultado', class: 'bg-purple-100 text-purple-700 border-purple-200' },
                    i: { label: 'I', title: 'Informado', class: 'bg-emerald-100 text-emerald-700 border-emerald-200' }
                };

                let innerRasci = '';
                Object.keys(roles).forEach(key => {
                    let actors = item.rasci[key];
                    // Normaliza para array se for string (legado)
                    if (typeof actors === 'string') actors = actors ? [actors] : [];
                    
                    if (actors && actors.length > 0) {
                        const role = roles[key];
                        // Cria badges para os atores
                        const actorsHtml = actors.map(a => `<span class="text-[10px] font-bold text-slate-600 bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">${a}</span>`).join(' ');
                        innerRasci += `
                            <div class="flex items-start gap-2 mb-2">
                                <span class="w-5 h-5 flex items-center justify-center rounded ${role.class} text-[10px] font-black border shrink-0" title="${role.title}">${role.label}</span>
                                <div class="flex-1 flex flex-wrap gap-1 items-center leading-tight pt-0.5">${actorsHtml}</div>
                            </div>
                        `;
                    }
                });

                if (innerRasci) {
                    rasciHtml = `
                        <div class="mt-4 pt-4 border-t border-slate-100">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fas fa-users-cog text-slate-400 text-xs"></i>
                                <p class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Matriz de Responsabilidades (RASCI)</p>
                            </div>
                            <div class="grid grid-cols-1 gap-1">
                                ${innerRasci}
                            </div>
                        </div>
                    `;
                }
            }

            let servicesBadgeHtml = '';
            if (activeTab === 'operational') {
                const sList = item.services || (item.service ? [item.service] : ['N/A']);
                servicesBadgeHtml = `<div class="flex flex-wrap gap-1 mt-1 mb-1">` + sList.map(s => `<p class="text-[9px] text-orange-600 bg-orange-50 border border-orange-100 px-1.5 py-0.5 rounded font-black uppercase tracking-wide">${s}</p>`).join('') + `</div>`;
            } else if (item.service) {
                servicesBadgeHtml = `<p class="text-[9px] text-slate-400 font-bold uppercase truncate">${item.service}</p>`;
            }

            return `
            <div class="accordion-row bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden mb-3 group hover:border-blue-300 transition-colors">
                <div class="px-5 py-5 flex flex-col gap-3">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start justify-between gap-3 w-full cursor-pointer" onclick="this.closest('.accordion-row').classList.toggle('active')">
                            <div class="flex items-start gap-4 min-w-0 flex-1">
                                <div class="w-1.5 h-10 rounded-full ${window.getStatusColorBg(item.status)}"></div>
                                <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-1 mb-1">
                                    <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500 font-black uppercase tracking-wider">${item.coord || 'N/A'}</span>
                                    ${complexityTag}${respectBadge}
                                </div>
                                <h4 class="font-bold text-slate-900 text-base leading-tight clamp-2 title-fixed">${item.name}</h4>
                                ${servicesBadgeHtml}
                            </div>
                        </div>
                        </div>
                        <div class="flex items-center gap-2 shrink-0 card-top-actions">
                        <button onclick="event.stopPropagation(); toggleDispatch('${item.id}', '${activeTab}')" class="btn-dispatch ${item.onDispatch ? 'active-dispatch' : ''}" title="${item.onDispatch ? 'Remover de Despacho' : 'Enviar para Despacho'}">
                            <i class="fas fa-clipboard-list"></i>
                        </button>
                        <button onclick="event.stopPropagation(); togglePlanner('${item.id}', '${activeTab}')" class="btn-planner ${item.onPlanner ? 'active-planner' : ''}" title="${item.onPlanner ? 'Remover do Planner da Presidência' : 'Sinalizar no Planner da Presidência'}">
                            <i class="fas fa-tasks"></i>
                        </button>
                    </div>
                    </div>
                    
                    <div class="flex items-center justify-between pt-1 border-t border-slate-50 mt-1">
                        <div class="flex items-center gap-4 text-xs text-slate-400 font-bold uppercase">
                            <span><i class="far fa-calendar mr-1"></i> ${item.prazo ? new Date(item.prazo + "T00:00:00").toLocaleDateString('pt-BR') : '--'}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="editItem('${item.id}')" class="text-slate-300 hover:text-blue-600 transition-colors text-sm"><i class="fas fa-edit"></i></button>
                            <i class="fas fa-chevron-down text-slate-300 chevron-icon transition-transform text-sm cursor-pointer" onclick="this.closest('.accordion-row').classList.toggle('active')"></i>
                        </div>
                    </div>
                </div>

                <div class="accordion-content px-5 bg-slate-50/50">
                    <div class="py-5 space-y-5">
                        <div class="space-y-5">
                            <div><p class="text-[11px] font-black text-slate-400 uppercase mb-2">Descrição / Escopo</p><p class="text-sm text-slate-700 leading-relaxed font-medium">${item.desc || 'Sem descrição.'}</p></div>
                            ${item.risks ? `<div class="bg-red-50 p-4 rounded-xl border border-red-100"><p class="text-[11px] font-black text-red-500 uppercase mb-2"><i class="fas fa-exclamation-triangle mr-1"></i> Riscos / Impedimentos</p><p class="text-sm text-red-700 leading-relaxed font-bold">${item.risks}</p></div>` : ''}
                            ${item.obs ? `<div class="pt-2"><p class="text-[11px] font-black text-slate-400 uppercase mb-2">Observações Gerais</p><p class="text-sm text-slate-600 leading-relaxed bg-amber-50 p-3 rounded-lg border border-amber-100">${item.obs}</p></div>` : ''}
                            ${((item.docLinks || (item.docLink ? [item.docLink] : [])).filter(Boolean)).length ? `<div class="pt-2">
                                <p class="text-[11px] font-black text-slate-400 uppercase mb-2"><i class="fas fa-paperclip mr-1"></i> Documentos</p>
                                <div class="space-y-2">
                                    ${(item.docLinks || (item.docLink ? [item.docLink] : [])).filter(Boolean).map(link => `
                                        <a href="${link}" target="_blank" class="flex items-center gap-2 bg-white border border-slate-200 rounded-lg px-3 py-2 hover:border-blue-300 hover:bg-blue-50/50 transition-colors">
                                            <span class="w-7 h-7 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center shrink-0"><i class="fas fa-link text-xs"></i></span>
                                            <span class="text-sm font-bold text-blue-700 truncate">${link}</span>
                                            <span class="text-slate-300 ml-auto"><i class="fas fa-external-link-alt text-xs"></i></span>
                                        </a>
                                    `).join('')}
                                </div>
                            </div>` : ''}
                            ${rasciHtml}
                            ${roadmapHtml}
                        </div>
                        
                        ${operationalHtml}

                        <div class="space-y-4 pt-4 border-t border-slate-200">
                             <div class="flex flex-wrap gap-2">
                                <span class="text-[11px] uppercase px-3 py-1.5 rounded-lg border font-bold ${window.getStatusColor(item.status)}">${item.status}</span>
                                ${item.priority === 'Urgente' ? '<span class="text-[11px] uppercase px-3 py-1.5 rounded-lg bg-red-100 text-red-600 border border-red-200 font-black">Urgente</span>' : ''}
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                ${item.sei ? `<div><p class="text-[10px] font-black text-slate-400 uppercase mb-1">SEI</p><p class="text-sm font-bold text-slate-700 bg-slate-100 px-2 py-0.5 rounded inline-block truncate max-w-full">${item.sei}</p></div>` : ''}
                            </div>
                            ${item.docLink ? `<div class="pt-2"><a href="${item.docLink}" target="_blank" class="text-xs font-bold text-blue-500 hover:underline flex items-center gap-1"><i class="fas fa-external-link-alt"></i> Docs</a></div>` : ''}
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // ... (changeMonth, renderCalendar, openCalendarModal... e Auth mantidos) ...
        window.changeMonth = (offset) => { currentDate.setMonth(currentDate.getMonth() + offset); selectedCalendarDay = null; window.renderCalendar(); };
        window.filterCalendarByDay = (dateStr) => { selectedCalendarDay = dateStr; window.renderCalendar(); };
        // Calendario
        window.renderCalendar = () => {
            const grid = document.getElementById('calendarGrid');
            const lc = document.getElementById('calendarEventsList');
            const clearBtn = document.getElementById('clearDayFilterBtn');
            const listTitle = document.getElementById('eventListTitle');
            if (!grid || !lc) return;

            grid.innerHTML = '';

            const y = currentDate.getFullYear();
            const m = currentDate.getMonth();
            const mn = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const monthNameEl = document.getElementById('calMonthName');
            const yearNameEl = document.getElementById('calYearName');
            if (monthNameEl) monthNameEl.innerText = mn[m];
            if (yearNameEl) yearNameEl.innerText = y;

            if (selectedCalendarDay) {
                clearBtn?.classList.remove('hidden');
                const [dYear, dMonth, dDay] = selectedCalendarDay.split('-');
                if (listTitle) listTitle.innerText = `Eventos em ${dDay}/${dMonth}/${dYear}`;
            } else {
                clearBtn?.classList.add('hidden');
                if (listTitle) listTitle.innerText = 'Detalhamento de Eventos';
            }

            const fd = new Date(y, m, 1).getDay();
            const dim = new Date(y, m + 1, 0).getDate();

            for (let i = 0; i < fd; i++) {
                grid.appendChild(Object.assign(document.createElement('div'), { className: 'calendar-new-day-empty' }));
            }

            const filterItem = (item) => {
                if (currentFilter === 'all') return true;
                const itemCoord = item.coord || item.area;
                return itemCoord === currentFilter;
            };

            let monthEvts = [];
            let filteredListEvts = [];

            for (let d = 1; d <= dim; d++) {
                const ds = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const cell = Object.assign(document.createElement('div'), { className: 'calendar-new-day-cell' });

                const today = new Date();
                if (d === today.getDate() && m === today.getMonth() && y === today.getFullYear()) {
                    cell.classList.add('calendar-day-active');
                }

                if (selectedCalendarDay === ds) {
                    cell.classList.add('!bg-blue-50', '!border-blue-400', '!ring-2', '!ring-blue-200');
                }

                cell.innerHTML = `<span class="text-[10px] font-bold text-slate-400 p-1 block text-right">${d}</span>`;

                const dayEvts = [];

                ['projects', 'contracts', 'operational'].forEach((s) => {
                    dataStore[s]?.forEach((i) => {
                        if (i.prazo === ds && filterItem(i)) dayEvts.push({ ...i, origin: s });
                    });
                });

                dataStore.calendarEvents.forEach((e) => {
                    if (e.prazo === ds && filterItem(e)) dayEvts.push({ ...e, origin: 'general' });
                });

                monthEvts = [...monthEvts, ...dayEvts];
                if (selectedCalendarDay === ds) filteredListEvts = [...dayEvts];

                if (dayEvts.length > 0) {
                    cell.innerHTML += `
                        <div class="mt-2 text-center" onclick="filterCalendarByDay('${ds}')">
                            <span class="bg-blue-50 text-blue-600 border border-blue-100 rounded-md py-0.5 px-2 text-[9px] font-black uppercase inline-block w-full truncate cursor-pointer hover:bg-blue-100 hover:border-blue-300 transition-colors">
                                ${dayEvts.length} eventos
                            </span>
                        </div>`;
                }

                grid.appendChild(cell);
            }

            const listData = selectedCalendarDay ? filteredListEvts : monthEvts;

            if (listData.length === 0) {
                lc.innerHTML = `<p class="text-slate-400 text-xs italic text-center py-4">Nenhum evento ${selectedCalendarDay ? 'neste dia' : 'para este filtro'}.</p>`;
                return;
            }

            const colors = { projects: 'bg-blue-500', contracts: 'bg-purple-500', operational: 'bg-orange-500', general: 'bg-green-500' };

            lc.innerHTML = listData
                .sort((a, b) => a.prazo.localeCompare(b.prazo))
                .map((e) => {
                    const [eY, eM, eD] = e.prazo.split('-');

                    // IMPORTANTE: onclick dentro de HTML nao tem acesso ao "e" do .map
                    const clickAction = (e.origin === 'general')
                        ? `openCalendarModalById('${e.id}')`
                        : `editItem('${e.id}', '${e.origin}')`;

                    return `
                        <div class="flex items-center gap-4 p-3 rounded-xl border border-slate-100 hover:bg-slate-50 transition-colors cursor-pointer" onclick="${clickAction}">
                            <div class="flex-none w-12 text-center">
                                <span class="block text-xs font-black text-slate-700">${eD}/${eM}</span>
                            </div>
                            <div class="w-1.5 h-8 rounded-full ${colors[e.origin]}"></div>
                            <div class="flex-1">
                                <p class="text-xs font-bold text-slate-800">${e.name}</p>
                                <p class="text-[10px] text-slate-400 font-bold uppercase">${e.coord || e.area || 'Geral'}</p>
                            </div>
                            <i class="fas fa-chevron-right text-slate-300 text-xs"></i>
                        </div>`;
                })
                .join('');
        };

        // Helper para abrir evento "Geral" pelo ID (porque onclick em HTML nao enxerga o objeto do map)
        window.openCalendarModalById = (id) => {
            const evt = dataStore.calendarEvents.find(e => String(e.id) === String(id));
            if (!evt) return;
            window.openCalendarModal(evt);
        };
        window.openCalendarModal = (e = null) => { const sel = document.getElementById('calEventArea'); if(sel.options.length === 0) sel.innerHTML = areasList.map(a => `<option value="${a}">${a}</option>`).join(''); if(e) { document.getElementById('calEventId').value = e.id; document.getElementById('calEventName').value = e.name; document.getElementById('calEventArea').value = e.area; document.getElementById('calEventDate').value = e.prazo; document.getElementById('calEventObs').value = e.obs || ''; document.getElementById('btnDeleteEvent').classList.remove('hidden'); } else { document.getElementById('calendarForm').reset(); document.getElementById('calEventId').value = ''; document.getElementById('calEventDate').valueAsDate = new Date(); document.getElementById('btnDeleteEvent').classList.add('hidden'); } toggleModal('calendarModal'); };
        window.saveCalendarEvent = async () => { const id = document.getElementById('calEventId').value || Date.now().toString(); await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calendar_events', id), { name: document.getElementById('calEventName').value, area: document.getElementById('calEventArea').value, prazo: document.getElementById('calEventDate').value, obs: document.getElementById('calEventObs').value }); toggleModal('calendarModal'); };
        window.deleteCalendarEvent = async () => { const id = document.getElementById('calEventId').value; if(id) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'calendar_events', id)); toggleModal('calendarModal'); };
        window.getStatusColorBg = s => ({"Backlog":"bg-slate-300","Iniciado":"bg-sky-400","Em Planejamento":"bg-indigo-500","Em Execução (Dentro do Planejado)":"bg-green-500","Em Execução (Atenção)":"bg-amber-400","Em Execução (Em Risco / Atrasado)":"bg-orange-500","Crítico":"bg-red-600","Concluído":"bg-emerald-600","Cancelado":"bg-slate-500"}[s] || "bg-slate-200");
        window.getStatusColor = s => (s === "Cancelado" ? "text-slate-600 bg-slate-100 border-slate-300" : (s === "Concluído" || s.includes("Dentro") ? "text-green-600 bg-green-50 border-green-200" : (s === "Crítico" || s.includes("Risco") ? "text-red-600 bg-red-50 border-red-200" : (s.includes("Atenção") ? "text-amber-600 bg-amber-50 border-amber-200" : "text-slate-600 bg-slate-50 border-slate-200"))));
        window.setListFilter = f => { currentListFilter = f; document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active-filter')); const map = {'all':'cardTotal','Backlog':'cardBacklog','Iniciado':'cardIniciado','Em Planejamento':'cardPlanejado','Em Execução (Dentro do Planejado)':'cardExecDP','Em Execução (Atenção)':'cardExecEA','Em Execução (Em Risco / Atrasado)':'cardExecRA','Crítico':'cardCritico','Cancelado':'cardCancelado','Concluído':'cardConcluido'}; if(map[f]) document.getElementById(map[f]).classList.add('active-filter'); window.renderData(); };
        window.setPriorityFilter = p => { currentPriorityFilter = (currentPriorityFilter === p) ? 'all' : p; document.querySelectorAll('[id^="legend-prio-"]').forEach(el => el.classList.remove('active-legend')); if(currentPriorityFilter !== 'all') { const map = {'Urgente':'urg', 'Alta':'high', 'Média':'mid', 'Baixa':'low'}; document.getElementById('legend-prio-'+map[currentPriorityFilter]).classList.add('active-legend'); } window.renderData(); };
        window.setFilter = f => { currentFilter = f; const btns = document.querySelectorAll('.coord-btn'); btns.forEach(b => b.classList.remove('active-coord')); if(f !== 'all') { document.getElementById('coordBtnContainer').classList.add('coord-list-active'); const b = document.getElementById('coord-'+f); if(b) b.classList.add('active-coord'); } else document.getElementById('coordBtnContainer').classList.remove('coord-list-active'); window.renderData(); };
        window.updateStatusUI = s => { document.getElementById('sysStatusDot').className = `w-2 h-2 rounded-full ${s === 'online' ? 'bg-emerald-400' : 'bg-amber-400'}`; document.getElementById('sysStatusText').innerText = s === 'online' ? 'Online' : 'Sincronizando...'; };
        
        onAuthStateChanged(auth, (user) => { currentUser = user; if (user) { initListeners(); setTimeout(() => window.switchTab('projects'), 500); setupTagInput('rasciInputR', 'rasciContainerR', 'tag-blue'); setupTagInput('rasciInputA', 'rasciContainerA', 'tag-red'); setupTagInput('rasciInputS', 'rasciContainerS', 'tag-orange'); setupTagInput('rasciInputC', 'rasciContainerC', 'tag-purple'); setupTagInput('rasciInputI', 'rasciContainerI', 'tag-green');

                    // Indicadores: listeners de busca/filtro
                    const s = document.getElementById('indicatorSearch');
                    const c = document.getElementById('indicatorClearSearch');
                    const tf = document.getElementById('indicatorTypeFilter');
                    const pf = document.getElementById('indicatorProductFilter');
                    const so = document.getElementById('indicatorSort');

                    if (s) {
                        s.addEventListener('input', (e) => { indicatorSearchQuery = e.target.value || ''; if (activeTab === 'indicators') window.renderIndicators(); });
                    }
                    if (c) {
                        c.addEventListener('click', () => { if (s) s.value = ''; indicatorSearchQuery = ''; if (activeTab === 'indicators') window.renderIndicators(); });
                    }
                    if (tf) {
                        tf.addEventListener('change', (e) => { indicatorTypeFilter = e.target.value; if (activeTab === 'indicators') window.renderIndicators(); });
                    }
                    if (pf) {
                        pf.addEventListener('change', (e) => { indicatorProductFilter = e.target.value; if (activeTab === 'indicators') window.renderIndicators(); });
                    }
                    if (so) {
                        so.addEventListener('change', (e) => { indicatorSort = e.target.value; if (activeTab === 'indicators') window.renderIndicators(); });
                    }
 } });
    

/* =================== CORRECAO: FUNCOES PARA NOVO INDICADOR =================== */



function toggleNewIndicatorTypeUI() {
  const type = document.getElementById("newIndType")?.value || "other";
  const isPpa = type === "ppa";

  const simple = document.getElementById("newIndPpaSimpleWrapper");
  const optional = document.getElementById("newIndPpaOptionalWrapper");

  if (simple) simple.classList.toggle("hidden-field", !isPpa);
  if (optional) optional.classList.toggle("hidden-field", !isPpa);

  // Se for "Outros", zera campos de PPA pra não “herdar” nada
  if (!isPpa) {
    const idsToClear = [
      "newIndMeta2024","newIndReal2024","newIndMeta2025","newIndReal2025","newIndMeta2027",
      "newIndPpa2025","newIndPpa2026","newIndPpaReal2025"
    ];
    idsToClear.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });
  }
}
window.openNewIndicatorModal = function(type = "other") {
  const form = document.getElementById("newIndicatorForm");
  if (form) form.reset();

  // Define o tipo no select (e não em atributo do modal)
  const typeSelect = document.getElementById("newIndType");
  if (typeSelect) typeSelect.value = type;

  // Ajusta campos visíveis de acordo com o tipo (PPA x Outros)
  toggleNewIndicatorTypeUI();
  if (typeSelect) typeSelect.onchange = toggleNewIndicatorTypeUI;

  // Pré-preenche meta PPA 2026 com a Meta 2026 (se existir)
  const metaEl = document.getElementById("newIndMeta");
  const ppa2026El = document.getElementById("newIndPpa2026");
  if (metaEl && ppa2026El) {
    metaEl.addEventListener('input', () => { ppa2026El.value = metaEl.value; }, { once: true });
  }

  // Gera os grids de meses (2025 e 2026) para permitir acompanhamento desde o cadastro
  const grid2025 = document.getElementById("newIndMonthsGrid2025");
  const grid2026 = document.getElementById("newIndMonthsGrid2026");
  const months = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];

  function buildMonthGrid(grid, prefix) {
    if (!grid) return;
    grid.innerHTML = "";
    months.forEach((m, i) => {
      grid.insertAdjacentHTML('beforeend',
        `<div class="flex flex-col">
           <label class="field-label">${m}</label>
           <input type="number" step="0.01" id="${prefix}_${i}" class="input-style" value="0">
         </div>`
      );
    });
  }
  buildMonthGrid(grid2025, "newIndMonth2025");
  buildMonthGrid(grid2026, "newIndMonth2026");

  toggleModal("newIndicatorModal");
};



window.createIndicator = async function createIndicator() {

  // Evita criacao duplicada (duplo clique, latencia, Enter, etc.)
  // E, como protecao extra, usa um id fixo enquanto a criacao estiver em andamento
  // (assim, mesmo que esta funcao dispare duas vezes por algum motivo, ela sobrescreve o mesmo doc).
  if (window.__creatingIndicator) return;
  window.__creatingIndicator = true;
  if (!window.__pendingIndicatorDocId) {
    window.__pendingIndicatorDocId = (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()));
  }
  const btn = document.getElementById("btnCreateIndicator");
  if (btn) { btn.disabled = true; btn.classList.add("opacity-60","cursor-not-allowed"); }

  const releaseCreate = () => {
    window.__creatingIndicator = false;
    const b = document.getElementById("btnCreateIndicator");
    if (b) { b.disabled = false; b.classList.remove("opacity-60","cursor-not-allowed"); }
  };

  const name = document.getElementById("newIndName").value;
  const product = document.getElementById("newIndProduct").value;
  const unit = document.getElementById("newIndUnit").value;
  const rule = document.getElementById("newIndRule").value;
  const type = document.getElementById("newIndType").value;
  const isPpa = type === "ppa";

  // Meta base (sempre): o campo 'Meta 2026' do topo funciona para PPA e Outros
  const metaBase2026 = Number(document.getElementById("newIndMeta").value || 0);

  if (!name || !metaBase2026) {
    alert("Preencha ao menos o nome do indicador e a Meta 2026.");
    releaseCreate();
    return;
  }

  // Para indicadores PPA, se o campo 'Meta 2026' do bloco PPA estiver preenchido, ele sobrescreve
  const metaPpa2026 = Number(document.getElementById("newIndMeta2026")?.value || 0);
  const m2026 = metaPpa2026 || metaBase2026;

  // PPA (somente quando type === 'ppa')
  let ppa = {};
  let ppaRealized = {};

  if (isPpa) {
    const m2024 = Number(document.getElementById("newIndMeta2024").value || 0);
    const r2024 = Number(document.getElementById("newIndReal2024").value || 0);
    const m2025 = Number(document.getElementById("newIndMeta2025").value || 0);
    const r2025 = Number(document.getElementById("newIndReal2025").value || 0);
    const m2027 = Number(document.getElementById("newIndMeta2027").value || 0);

    // Campos opcionais de PPA (detalhado)
    const ppa2025 = Number(document.getElementById("newIndPpa2025")?.value || 0);
    const ppa2026 = Number(document.getElementById("newIndPpa2026")?.value || 0);
    const ppaReal2025 = Number(document.getElementById("newIndPpaReal2025")?.value || 0);

    ppa = {
      "2024": m2024,
      "2025": ppa2025 || m2025,
      "2026": ppa2026 || m2026,
      "2027": m2027
    };

    ppaRealized = {
      "2024": r2024,
      "2025": ppaReal2025 || r2025
    };
  }

  // Acompanhamento mensal inicial (se preenchido)
  const monthly_2025 = Array.from({ length: 12 }, (_, i) =>
    Number(document.getElementById(`newIndMonth2025_${i}`)?.value || 0)
  );
  const monthly = Array.from({ length: 12 }, (_, i) =>
    Number(document.getElementById(`newIndMonth2026_${i}`)?.value || 0)
  );

  const newIndicator = {
    name,
    product: product || "OUTROS INDICADORES",
    unit: unit || "un",
    rule: rule || "Soma",
    type,
    meta: m2026,
    code: (type === 'ppa') ? 'NOVO' : 'OUTRO',
    ppa,
    ppaRealized,
    monthly,
    monthly_2025,
    createdAt: new Date().toISOString()
  };

  try {
    const newId = window.__pendingIndicatorDocId;
    await setDoc(
      doc(db, "artifacts", appId, "public", "data", "indicators", newId),
      newIndicator
    );

    // Fecha modal. A lista sera atualizada pelo onSnapshot (fonte de verdade) sem risco de duplicar cards.
    toggleModal("newIndicatorModal");

  } catch (err) {
    console.error(err);
    alert("Erro ao criar indicador. Veja o console.");
  } finally {
    window.__creatingIndicator = false;
    window.__pendingIndicatorDocId = null;
    const btn = document.getElementById("btnCreateIndicator");
    if (btn) { btn.disabled = false; btn.classList.remove("opacity-60","cursor-not-allowed"); }
  }
};

/* =================== FIM DA CORRECAO =================== */

</script>
</body>
</html>
